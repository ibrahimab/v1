<?php

if($login->logged_in) {
	if($_GET["bid"]) {
		$db->query("SELECT boeking_id, type_id, aankomstdatum, aantalpersonen FROM boeking WHERE boeking_id='".addslashes($_GET["bid"])."'".($boeking_wijzigen ? " AND website='".$vars["website"]."'" : "").";");
		#echo $db->lastquery;

		if($db->next_record()) {

			#
			# Gegevens uit database halen
			#
			$temp_gegevens=boekinginfo($db->f("boeking_id"));

			$gegevens["stap1"]=$temp_gegevens["stap1"];

			# Controle op status Persoonlijke gegevens (2 heeft voorkeur boven 1)
			if($temp_gegevens["stap2"][2]) {
			$gegevens["stap2"]=$temp_gegevens["stap2"][2];
			} elseif($temp_gegevens["stap2"][1]) {
			$gegevens["stap2"]=$temp_gegevens["stap2"][1];
			}

			# Controle op status Persoonlijke gegevens (2 heeft voorkeur boven 1)
			if($temp_gegevens["stap3"][2][2]) {
			$gegevens["stap3"]=$temp_gegevens["stap3"][2];
			} elseif($temp_gegevens["stap3"][1][2]) {
			$gegevens["stap3"]=$temp_gegevens["stap3"][1];
			}

			# Controle op status Geselecteerde opties (2 heeft voorkeur boven 1)
			if($temp_gegevens["stap4"][2]) {
			$gegevens["stap4"]=$temp_gegevens["stap4"][2];
			$gegevens["stap4"]["actieve_status"]=2;
			$gegevens["fin"]=$temp_gegevens["fin"][2];
			} else {
			$gegevens["stap4"]=$temp_gegevens["stap4"][1];
			$gegevens["stap4"]["actieve_status"]=1;
			$gegevens["fin"]=$temp_gegevens["fin"][1];
			}
			$gegevens["stap5"]=$temp_gegevens["stap5"];
		}

		// Set the booking person country code
        if(file_exists("docdata/library/functions.php")) {
            require_once("docdata/library/functions.php");
            $gegevens["stap2"]["iso_land"] = docdata_iso_landcode($gegevens["stap2"]["land"], $gegevens["stap1"]["website"]);
        } else {
            $gegevens["stap2"]["iso_land"] = false;
        }

		echo "<p><a href=\"".$vars["path"]."bsys.php?bid=".intval($_GET["bid"])."\">";
			echo html("terugnaardeoverzichtspagina","bsys");
		echo "</a></p>";

		if(isset($_GET["menu"]) && $gegevens["stap1"]["factuurdatum"]>0) {

			# Display messages
			if(isset($_GET["success"]) && (int)$_GET["success"] > 0) {
				echo "<p align=\"center\" style=\"color:#999900;font-weight:bold;background:#fff;padding:5px;border:1px solid #999900;\">".html("success_".$_GET["success"],"bsys")."</p>";
			} elseif(isset($_GET["error"]) && (int)$_GET["error"] > 0) {
				echo "<p align=\"center\" style=\"color:#d40139;font-weight:bold;background:#fff;padding:5px;border:1px solid #d40139;\">".html("error_".$_GET["error"],"bsys")."</p>";

				// send error to errorlog
				trigger_error("_notice: Docdata-foutmelding ".$_GET["error"].": ".txt("error_".$_GET["error"],"bsys"),E_USER_NOTICE);
			}

			# Init variables
			$txt_html = array();
			$total_paid = 0;
			$checked1 = ' checked="checked"';
			$checked2 = '';

			# Get all registered payments
			$sql = "SELECT type, UNIX_TIMESTAMP(datum) AS datum, bedrag FROM `boeking_betaling` WHERE boeking_id = '" . mysql_real_escape_string($_GET["bid"]) . "'";
			$db->query($sql);
			if($db->num_rows() > 0) {
				while($db->next_record()) {
					$txt_html[$db->f('datum')] = "<tr><td>". datum("D MAAND JJJJ",$db->f('datum')) ."</td><td align=\"right\">&euro; ". number_format($db->f('bedrag'),2,',','.') ."</td></tr>";
					$total_paid += $db->f('bedrag');
				}
			}

			$ramining_payments = round($gegevens["fin"]["totale_reissom"] - $total_paid, 2);

			# If at least one payment was made, we display only the remaining amount to be paid
			if(count($txt_html) > 0 && $total_paid > 0) {
				$advance_payment = true;
				$checked1 = '';
				$checked2 = ' checked="checked"';
			}

            # Disable the advance payment if the advance payment date is higher then the full payment date
            if($gegevens["stap1"]["dagen_voor_vertrek"]<($gegevens["stap1"]["totale_reissom_dagenvooraankomst"]+$gegevens["stap1"]["aanbetaling1_dagennaboeken"])) {
                $advance_payment = true;
            }

			# Get payment dates
			$datum_weken_voorvertrek=date("d/m/Y",mktime(0,0,0,date("m",$gegevens["stap1"]["aankomstdatum_exact"]),date("d",$gegevens["stap1"]["aankomstdatum_exact"])-$gegevens["stap1"]["totale_reissom_dagenvooraankomst"],date("Y",$gegevens["stap1"]["aankomstdatum_exact"])));
				if($gegevens["stap1"]["totale_reissom_dagenvooraankomst"]%7==0 and $gegevens["stap1"]["totale_reissom_dagenvooraankomst"]<>7) {
				$aanbetaling_aantalweken=round($gegevens["stap1"]["totale_reissom_dagenvooraankomst"]/7);
			} else {
				$aanbetaling_aantaldagen=$gegevens["stap1"]["totale_reissom_dagenvooraankomst"];
			}
			# Full payment date
			if($aanbetaling_aantalweken) {
				$full_pay_date = txt("uiterlijkXwekenvoorvertrek","factuur",array("v_weken"=>$aanbetaling_aantalweken,"v_datum"=>$datum_weken_voorvertrek));
			} else {
				$full_pay_date = txt("uiterlijkXdagenvoorvertrek","factuur",array("v_dagen"=>$aanbetaling_aantaldagen,"v_datum"=>$datum_weken_voorvertrek));
			}
			# Advance payment date
			$n_date = strtotime("+ ".$gegevens["stap1"]["aanbetaling1_dagennaboeken"]. " day", $gegevens["stap1"]["bevestigdatum"]);
			$pay_date = date("d/m/Y", $n_date);
			$advance_pay_date = txt("uiterlijkdatumtebetalen","factuur",array("v_datum"=> $pay_date));

			# Switch pages
			switch ((int)$_GET["menu"]) {
				#DocData payment form
				case 1:
					// Display the form only if there are any amounts due to be paid
					if($ramining_payments > 0) {
						echo "<form method=\"post\" action=\"http".($_SERVER["HTTPS"]=="on" ? "s" : "")."://".$_SERVER["HTTP_HOST"] . "/docdata/payment/redirect/"."\" name=\"payment\">";
						echo "<table align=\"center\" style=\"width:100%;\" cellpadding=\"5\">";
						echo "<tr style=\"background: #d5e1f9;\"><td><em><strong>". html("payment_part","bsys") ."</strong></em></td><td><em><strong>". html("payment_method","bsys") ."</strong></em></td></tr>";

						echo "<input type=\"hidden\" name=\"order\" value=\"{$_GET["bid"]}\">";
						echo "<tr><td style=\"vertical-align:top;\">";

							// if no payment was made we display the advanced payment options
							if(!$advance_payment) {
								echo "<p>";
								echo "<input type=\"radio\" name=\"payment_type\" id=\"advance\" value=\"advance\" ". $checked1 ." />";
								echo "<label for=\"advance\">". html("advance_payment","bsys") ." (&euro; " . number_format($gegevens["fin"]["aanbetaling"],2,',','.') .")</label><br/>";
								echo "&nbsp; &nbsp; <em>" . $advance_pay_date ."</em>";
								echo "</p>";

								echo "<p>";
								echo "<input type=\"radio\" name=\"payment_type\" id=\"full\" value=\"full\" ". $checked2 ." />";
								echo "<label for=\"full\">". html("full_payment","bsys") ." (&euro; " . number_format($ramining_payments,2,',','.') .")</label><br />";
								echo "&nbsp; &nbsp; <em>" . $full_pay_date ."</em>";
								echo "</p>";
							} else {
								echo "<p>";
								echo "<input type=\"hidden\" name=\"payment_type\" id=\"full\" value=\"full\" />";
								echo html("full_payment","bsys") ." (&euro; " . number_format($ramining_payments,2,',','.') .")<br />";
								echo "<em>" . $full_pay_date ."</em>";
								echo "</p>";
							}

							echo "</td>";

							echo "<td style=\"vertical-align:top;width: 30%;\">";

							// display payment methods
							$count_payments = count($vars["docdata_payments"]);
							if($count_payments > 0) {
								$checked = ' checked="checked"';
                                reset($vars["docdata_payments"]);
								foreach($vars["docdata_payments"] as $key => $value) {
                                    echo "<div class=\"p_m\">";
                                    if ($count_payments > 1) {
                                        if ($gegevens["stap2"]["iso_land"] && isset($value["country"]) && !in_array($gegevens["stap2"]["iso_land"], $value["country"])) {
                                            continue;
                                        }
                                        $country = (isset($value["country"])) ? implode(",", $value["country"]) : "";

                                        echo "<label><input type=\"radio\" name=\"pm_code\" data-country=\"". $country  ."\" value=\"". $key ."\" ". $checked ." />". $value["title"] ."</label>";

                                    } else {
                                        echo "<input type=\"hidden\" name=\"pm_code\" value=\"". $key ."\" />". $value["title"];
                                    }

                                    echo "<img style=\"padding-left:10px;vertical-align:middle;\" src=\"". $vars["path"] . $value["icon"] ."\" alt=\"". $value["title"] ."\" />";
                                    echo "<div style=\"clear:both;height:3px;\">&nbsp;</div>";
                                    echo "</div>";
                                    $checked = '';

                                } #end foreach
						    }
                            echo "<script>jQuery(function($){
                                if( $('input[name=pm_code]').length == 1 && $('input[name=pm_code]').attr('type') == 'radio')  {
                                    $('input[name=pm_code]').hide();
                                }
                            });</script>";
							echo "</td></tr>";
							echo "<tr><td colspan=\"2\" align=\"right\">";


							# If no match was found for the country code, we display a dropdown with the countries
						    if(!$gegevens["stap2"]["iso_land"]) {
								echo "<label>" . html("customer_country","bsys") ."*: ";
								echo "<select name=\"country\">";
									foreach($countriesList[$vars["taal"]] as $key => $value) {
                                        if($gegevens["stap1"]["website"] == "C") {
                                            if($key == "NL" || $key == "BE") {}
                                            else { continue; }
                                        }
										echo "<option value=\"". $key ."\" title=\"". wt_he($value) ."\">" . wt_he($value) ."</option>";
									}
								echo "</select></label>";

								echo "<script>jQuery(function($){
                                    if( $('input[name=pm_code]').length == 1 )  {
                                        $('input[name=pm_code]').hide();
                                    }
                                    $('input[name=pm_code]').change(function() {
                                        if($(this).val() == 'docdata_idl') {
                                            $('select[name=country]').val('NL');
                                        } else if($(this).val() == 'docdata_mrc') {
                                                $('select[name=country]').val('BE');
										}
									});
									// Check if the user selected the country
									$('form[name=payment]').submit(function(){
									   if($('select[name=country]').val() == '') {
										   event.preventDefault();
										  return false;
									   }
									});
                                    $('select[name=country]').change(function(){
                                        var val = $(this).val();
                                        var chk = false;
                                        $('input[name=pm_code]').each(function(){
                                            var data_country = $(this).attr('data-country');
                                            if(data_country != '') {
                                                var arr_country = data_country.split(',');
                                                var found = false
                                                for(var i = 0; i < arr_country.length; i++) {
                                                    if(val == arr_country[i]) found = true;
                                                }
                                                if(data_country != '' && found == false) {
                                                    $(this).attr('disabled', 'disabled');
                                                    if($(this).is(':checked')) {
                                                        $(this).prop('checked', false);
                                                        chk = true;
                                                    }
                                                    $(this).parents('.p_m').hide();
                                                }
                                                else {
                                                    $(this).prop('disabled', false);
                                                    $(this).parents('.p_m').show();
                                                }
                                            }
                                        });
                                        if(chk) {
                                            $('input[name=pm_code]:enabled').first().prop('checked', true);
                                        }
									});
								});</script>";
							} else {
								echo "<input type=\"hidden\" name=\"country\" value=\"". $gegevens["stap2"]["iso_land"] ."\" />";
							}

						echo "</td></tr>";
						echo "<tr><td colspan=\"2\" align=\"center\"><input type=\"submit\" value=\" ".wt_he(strtoupper(txt("akkoord","bsys")))." \" id=\"paymentsubmit\"></td></tr>";

						echo "</table>";
						echo "</form>";
					} else {
						echo html("no_remaining_payments","bsys");
					}
				break;

				# Bank Transfer page
				case 2:
					echo "<h2>". html("bank_transfer","bsys") ."</h2><br />";

					if($ramining_payments > 0) {

						$payments_overview = "<table cellpadding=\"0\" cellspacing=\"2\" style=\"width:690px;\">";
						// if no payment was made we display the advanced payment text
						if(!$advance_payment) {
							$payments_overview .= "<tr><td width=\"65%\">" . $advance_pay_date ."</td><td align=\"right\"> &euro; " . number_format($gegevens["fin"]["aanbetaling"],2,',','.') ."</td></tr>";
						}

						$restbetalen=$gegevens["fin"]["totale_reissom"]-$gegevens["fin"]["aanbetaling"];
						if($ramining_payments<>$restbetalen and $ramining_payments<>$gegevens["fin"]["totale_reissom"]) {
							$restbetalen=$ramining_payments;
						}

						$payments_overview .= "<tr><td width=\"60%\">" . $full_pay_date ."</td><td align=\"right\"> &euro; " . number_format($restbetalen,2,',','.') ."</td></tr>";
						$payments_overview .= "</table>";

						$payments_text = "<p>". htmlentities_uitgebreid(html("banktransfer_text","bsys",array("v_resnumber"=> $gegevens["stap1"]["boekingsnummer"]))) ."</p>";

						echo $payments_text;
						echo $payments_overview;

					} else {
						echo html("no_remaining_payments","bsys");
					}
				break;

				#Payments history table
				case 3:
					echo "<h2>". html("summary","bsys") ."</h2><br />";

                    $txt_by = "docdata";
                    reset($vars["docdata_payments"]);
                    foreach($vars["docdata_payments"] as $method) {
                        if($gegevens["stap2"]["iso_land"] && isset($method["country"]) && !in_array($gegevens["stap2"]["iso_land"], $method["country"])) continue;
                        $txt_by .= "_" . $method["by"];
                    }

					# Display Docdata transactions table if there are any payments registered for this order
					if(count($txt_html) > 0 && $total_paid > 0) {
						ksort($txt_html);

						echo "<table style=\"width:100%\" class=\"toonacctabel\" cellpadding=\"5\">";
						echo "<tr><th>". html("payment_date","bsys") ."</th><th>". html("payment_amount","bsys") ."</th></tr>";
						foreach($txt_html as $entry) {
							echo $entry;
						}

						echo "<tr><td colspan=\"2\">&nbsp;</td></tr>";
						echo "<tr><td align=\"right\">". html("total_amount","bsys") .":</td><td align=\"right\">&euro; ". number_format($gegevens["fin"]["totale_reissom"],2,',','.') ."</td></tr>";
						echo "<tr><td align=\"right\">". html("total_paid","bsys") .":</td><td align=\"right\">&euro; ". number_format(($total_paid * -1),2,',','.') ."</td></tr>";
						echo "<tr><td align=\"right\">". html("remaining_payments","bsys") .":";
						if($ramining_payments > 0) {
							echo "<br /><em>" . $full_pay_date ."</em>";
						}
						echo "</td><td align=\"right\">&euro; ". number_format($ramining_payments,2,',','.') ."</td></tr>";
						echo "</table>";

						if($ramining_payments > 0) {
							echo "<p><a href=\"".$path."bsys_payments.php?menu=1&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html("pay_now","bsys", array("v_method" => html($txt_by,"bsys")))." &raquo;</a></p>";
							echo "<p><a href=\"".$path."bsys_payments.php?menu=2&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">". html("paynow_bank_transfer","bsys") ." &raquo;</a></p>";
						}
					} else {
						#echo html("no_payments","bsys");
						echo "<table cellspacing=\"2\" cellpadding=\"0\">";
							// if no payment was made we display the advanced payment text
							if(!$advance_payment) {
								echo "<tr><td>" . $advance_pay_date ."</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td align=\"right\">" . "&euro; " . number_format($gegevens["fin"]["aanbetaling"],2,',','.') ."</td></tr>";
							}

							$restbetalen=$gegevens["fin"]["totale_reissom"]-$gegevens["fin"]["aanbetaling"];
							if($ramining_payments<>$restbetalen and $ramining_payments<>$gegevens["fin"]["totale_reissom"]) {
								$restbetalen=$ramining_payments;
							}

							echo "<tr><td>" . $full_pay_date ."</td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td><td align=\"right\">" . "&euro; " . number_format($restbetalen,2,',','.') ."</td></tr>";
						echo "</table>";

						echo "<p><a href=\"".$path."bsys_payments.php?menu=1&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html("pay_now","bsys", array("v_method" => html($txt_by,"bsys")))." &raquo;</a></p>";
						echo "<p><a href=\"".$path."bsys_payments.php?menu=2&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">". html("paynow_bank_transfer","bsys") ." &raquo;</a></p>";
					}
				break;
			}
		}
	}
}
