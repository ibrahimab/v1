<?php

$gegevens=get_boekinginfo($_GET["bid"]);

# Kijken of het om een verzameltype gaat
if($gegevens["stap1"]["verzameltype_gekozentype_id"]) {
	$verzameltype_accinfo=accinfo($gegevens["stap1"]["verzameltype_gekozentype_id"],$gegevens["stap1"]["aankomstdatum"],$gegevens["stap1"]["aantalpersonen"]);
	$gegevens["stap1"]["accinfo"]["leverancierscode"]=$verzameltype_accinfo["leverancierscode"];
}

$leveranciercodes=split(",",$gegevens["stap1"]["accinfo"]["leverancierscode"]);

$db->query("SELECT naam, xml_type FROM leverancier WHERE leverancier_id='".addslashes($gegevens["stap1"]["leverancierid"])."';");
if($db->next_record()) {
	echo "<h2>Boeken via XML bij ".htmlentities($db->f("naam"))."</h2>";
	$xml_type=$db->f("xml_type");
}

echo boekingkoptekst($gegevens);
if($_GET["burl"]) echo "<a href=\"".$_GET["burl"]."\">terug naar boekingsgegevens</a><p>";

if($gegevens["stap1"]["leverancierscode"]) {
	echo "<span class=\"error\">Bestellen via XML niet mogelijk: er is al een <a href=\"".$vars["path"]."cms_boekingen_leveranciers.php?burl=".htmlentities(urlencode($_GET["burl"]))."&bid=".htmlentities($_GET["bid"])."\">Reserveringsnummer leverancier</a> bij deze boeking bekend.</span>";
} else {
	if(is_array($leveranciercodes)) {
		while(list($key,$value)=each($leveranciercodes)) {
	
			if($xml_type==1) {
				#
				# Huetten
				#
				$xml_submit="<parameter><LodgeId>".$value."</LodgeId><BeginDate>".date("d-m-Y",$gegevens["stap1"]["aankomstdatum_exact"])."</BeginDate><Duration>1</Duration><Persons>".$gegevens["stap1"]["aantalpersonen"]."</Persons><Client><Firstname>".$gegevens["stap2"]["voornaam"]."</Firstname><Lastname>".($gegevens["stap2"]["tussenvoegsel"] ? $gegevens["stap2"]["tussenvoegsel"]." " : "").$gegevens["stap2"]["achternaam"]."</Lastname><Phone>".$gegevens["stap2"]["telefoonnummer"]."</Phone><Salutation>".($gegevens["stap2"]["geslacht"]==1 ? "Sir" : "Madam")."</Salutation></Client></parameter>";
				if($_SERVER["DOCUMENT_ROOT"]=="/home/webtastic/html") {
					$xml_url="http://81.223.118.203/dataexchange/Booking.aspx?PartnerId=58063&Pwd=chalet.nl&xmlFile=".urlencode($xml_submit);
#					$xml_url="http://www.cgh-partenaires.com/results.xml";
				} else {
					$xml_url="https://api.huetten.com/dataexchange/Booking.aspx?PartnerId=76640&Pwd=chalet.nl&xmlFile=".urlencode($xml_submit);
				}
	
				$xml=@simplexml_load_file($xml_url);
				if($xml->error) {
					echo "<b>Foutmelding bij leverancierscode ".$value.":</b> <span class=\"error\">".htmlentities(utf8_decode($xml->error))."</span><br>";
				} else {
					$bestelnummer=trim(utf8_decode($xml->booking_info->attributes()->booking_number));
#					wt_mail("jeroen@webtastic.nl","Huetten-XML-bestelling","Boeking: ".$gegevens["stap1"]["boekingid"]."\nBestelnummer: ".$bestelnummer);

					echo "<br><b>Boeking is verzonden. Ontvangen reserveringsnummer: <i>".$bestelnummer."</i></b><br><br>Dit reserveringsnummer is opgeslagen in het CMS en de bestelstatus is gewijzigd in &quot;bevestigd&quot;.<br><br>";
					$db->query("UPDATE boeking SET leverancierscode='".addslashes($bestelnummer)."', bestelstatus=3, besteldatum=NOW() WHERE boeking_id='".addslashes($gegevens["stap1"]["boekingid"])."';");
					chalet_log("bestelling via xml verzonden (ontvangen reserveringsnummer: ".$bestelnummer.")",false,true);
					chalet_log("besteldatum op ".date("d-m-Y")." gezet, bestelstatus veranderd in 'bevestigd'",false,true);
					break;
				}
			} elseif($xml_type==9) {
				#
				# Maisons Vacances Ann Giraud
				#
	#			$xml_submit="http://www.rent-villas-france.com/servicespub/rent/add-reserv";
	
				/*
				secret-key : obligatory setting, password to secure and identify the information exchange
				/ref : obligatory setting, property reference
				/start date : obligatory setting, start date
				/length of stay : obligatory setting, length of stay
				/partner-booking-number : obligatory setting, your booking number
				/name : obligatory setting, client's name
				[/first name] : optional setting, client's first name
				[/price] : optional 
				
				*/
	
				$xml=simplexml_load_file($xml_url);
				if($xml->error) {
					echo "<b>Foutmelding bij leverancierscode ".$value.":</b> <span class=\"error\">".htmlentities(utf8_decode($xml->error))."</span><br>";
				} else {
					echo "<pre>";
					print_r($xml);
					echo "</pre>";
					$db->query("UPDATE boeking SET bestelstatus=2, besteldatum=NOW() WHERE boeking_id='".addslashes($gegevens["stap1"]["boekingid"])."';");
					chalet_log("bestelling via xml verzonden",false,true);
					chalet_log("besteldatum op ".date("d-m-Y")." gezet, bestelstatus veranderd in 'bevestiging afwachten'",false,true);
					break;
				}
	
	
	
				#
				# CIS
				#
				#http://xml.arkiane.com/xml_v2.asp?app=LS&clt=112&top=87&qry=ins_opti@top_id='CHALE',@lot_ref='',@begin='',@end='',@price='',@civi='M',@name='',@firstname='',@addr1='',@addr2='',@addr3='',@postcode='',@city='',@country='',@tel='',@fax='',@email='',@comments='',@lang=''
	
	
			} elseif($xml_type==13 or $xml_type==15) {
				#
				# Eurogroup en Des Neiges
				#
	
				if(ereg("_",$gegevens["stap1"]["accinfo"]["leverancierscode"])) {
				
					# etab_id [0] en room_type_code [1] bepalen
					$code=split("_",$gegevens["stap1"]["accinfo"]["leverancierscode"]);
	
					if($xml_type==13) {
						#
						# Eurogroup
						#
						# SOAP-verbinden starten
						$client = new SoapClient("http://www.eto.madamevacances.resalys.com/rsl/wsdl_distrib",array("trace"=>1));
		
						# base_product_code ophalen
	#					REBERE002 REBERE004
	
						if($gegevens["stap1"]["accinfo"]["wzt"]==2) {
							# zomer
#							$soap_conventionid="1894";
							$soap_conventionid="";
						} else {
							# winter
							$soap_conventionid="";
						}
						$soap_baseid="eurogroup";
						$soap_username="chaletnl";
						$soap_password="partner";
						$soap_allotment="";
						$soap_partnercode="REBERE004";
						$soap_partnercode2="REBERE002";
						
						$soap_systeemnaam="Eurogroup";
					} elseif($xml_type==15) {
						#
						# Des Neiges
						#
						echo "<div style=\"border:1px solid #000000;background-color:yellow;padding:5px;width:500px;margin-top:10px;margin-bottom:10px;\">Let op: het XML-bestelsysteem van Des Neiges is nog niet uitgebreid getest.</div>";
						$client = new SoapClient("http://chaletdesneiges.resalys.com/rsl/wsdl_distrib",array('trace'=>1));

						$soap_conventionid="";
						$soap_baseid="cdn";
						$soap_username="CHNL";
						$soap_password="chnl";
						$soap_allotment="0";
						$soap_partnercode="CHNL";

						$soap_systeemnaam="Des Neiges";
					}

					unset($error);
					try {
						$full_request="getDistribProposalsbyDate2(".$soap_baseid.",".$soap_username.",".$soap_password.",".$soap_partnercode.",".$soap_conventionid.",".$soap_allotment.",".$code[0].",".$code[1].",".date("Y-m-d",$gegevens["stap1"]["aankomstdatum_exact"]).",".date("Y-m-d",$gegevens["stap1"]["vertrekdatum_exact"]).")";
						$result=$client->getDistribProposalsbyDate2($soap_baseid,$soap_username,$soap_password,$soap_partnercode,$soap_conventionid,$soap_allotment,$code[0],$code[1],date("Y-m-d",$gegevens["stap1"]["aankomstdatum_exact"]),date("Y-m-d",$gegevens["stap1"]["vertrekdatum_exact"]));
					} catch (SoapFault $E) {
						if($E->faultcode or $E->faultstring) $error=$E->faultcode." - ".$E->faultstring;
					}
					if($error) {
						if($soap_partnercode2) {
							$soap_partnercode=$soap_partnercode2;
							unset($error);
							try {
								$result=$client->getDistribProposalsbyDate2($soap_baseid,$soap_username,$soap_password,$soap_partnercode,$soap_conventionid,$soap_allotment,$code[0],$code[1],date("Y-m-d",$gegevens["stap1"]["aankomstdatum_exact"]),date("Y-m-d",$gegevens["stap1"]["vertrekdatum_exact"]));
							} catch (SoapFault $E) {
								if($E->faultcode or $E->faultstring) $error=$E->faultcode." - ".$E->faultstring;
							}
							
						}
					}
					if($error) {
						trigger_error("notice: ".$soap_systeemnaam."-foutmelding (partnercode: ".$soap_partnercode."): ".$error." - request: ".$full_request,E_USER_NOTICE);
					} else {
						$base_product_code=utf8_decode($result->distribProposal->base_product_code);
					}

					if($_SERVER["DOCUMENT_ROOT"]=="/home/webtastic/html") {
						# testsysteem
						echo "getDistribProposalsbyDate2(\"".$soap_baseid."\",\"".$soap_username."\",\"".$soap_password."\",\"".$soap_partnercode."\",\"".$conventionid."\",\"\",".$code[0].",".$code[1].",".date("Y-m-d",$gegevens["stap1"]["aankomstdatum_exact"]).",".date("Y-m-d",$gegevens["stap1"]["vertrekdatum_exact"]).")<br>";
						echo "base_product_code: ".$base_product_code."<br><br><pre>";
						print_r($client);
						print_r($result);
						exit;
					}
					
					if($base_product_code) {
						if($gegevens["stap2"]["voornaam"]) {
							$firstname=$gegevens["stap2"]["voornaam"];
						} else {
							$firstname="";
						}
						if($gegevens["stap2"]["achternaam"]) {
							$lastname=$gegevens["stap2"]["achternaam"];
							if($gegevens["stap2"]["tussenvoegsel"]) {
								$lastname=$gegevens["stap2"]["tussenvoegsel"]." ".$lastname;
							}
						} else {
							$lastname="";
						}
	
						if($lastname) {
							if($gegevens["stap1"]["boekingsnummer"]) {
								if(strlen($gegevens["stap1"]["boekingsnummer"])==16) {
									$externalid=substr($gegevens["stap1"]["boekingsnummer"],0,7);
								} else {
									$externalid=substr($gegevens["stap1"]["boekingsnummer"],0,9);
								}
							} else {
								$externalid=$gegevens["stap1"]["boekingid"];
							}
							$reservation="<reservation><reservation><external_id>".$externalid."</external_id><etab_id>".$code[0]."</etab_id><reservation_type>gin</reservation_type><firstname>".$firstname."</firstname><lastname>".$lastname."</lastname><stays><stay><nb_rooms>1</nb_rooms><room_type_code>".$code[1]."</room_type_code><start_date>".date("Y-m-d",$gegevens["stap1"]["aankomstdatum_exact"])."</start_date><end_date>".date("Y-m-d",$gegevens["stap1"]["vertrekdatum_exact"])."</end_date></stay></stays></reservation></reservation>";
	
							if($_SERVER["DOCUMENT_ROOT"]=="/home/webtastic/html") {
								$result="TEST";						
							} else {
								unset($error);
								try {
									$result = $client->__soapCall("saveDistribReservation2",
										array(
										new SoapParam($soap_baseid,"base_id"),
										new SoapParam($soap_username,"username"),
										new SoapParam($soap_password,"password"),
										new SoapParam($soap_partnercode,"partnercode"),
										new SoapParam($base_product_code,"baseProductCode"),
										new SoapVar($reservation,XSD_ANYXML)
									));
								} catch (SoapFault $E) {
									if($E->faultcode or $E->faultstring) $error=$E->faultcode." - ".$E->faultstring;
								}
							}
							
							if($result and !$error) {
								echo "<br><b>Boeking ".$externalid." is verzonden. Ontvangen reserveringsnummer: <i>".utf8_decode($result)."</i></b><br><br>Dit reserveringsnummer is opgeslagen in het CMS en de bestelstatus is gewijzigd in &quot;bevestigd&quot;.<br><br>";
								$db->query("UPDATE boeking SET leverancierscode='".addslashes(utf8_decode($result))."', bestelstatus=3, besteldatum=NOW() WHERE boeking_id='".addslashes($gegevens["stap1"]["boekingid"])."';");
								chalet_log("bestelling via xml verzonden (ontvangen reserveringsnummer: ".utf8_decode($result).")",false,true);
								chalet_log("besteldatum op ".date("d-m-Y")." gezet, bestelstatus veranderd in 'bevestigd'",false,true);
							} else {
								echo "<span class=\"error\">Boeken niet gelukt.<br><br>Foutmelding van het ".$soap_systeemnaam."-systeem: ".htmlentities(($error ? $error : "onbekende fout"))."</span><p>";
								trigger_error("notice: ".$soap_systeemnaam."-foutmelding ".$error,E_USER_NOTICE);
							}
		
	#						echo "<pre>";
	#						print_r($result);
	#						echo "REQUEST:\n" . htmlentities($client->__getLastRequest(),ENT_QUOTES, 'UTF-8') . "\n";
	#						echo "RESPONSE:\n" . htmlentities($client->__getLastResponse(),ENT_QUOTES, 'UTF-8') . "\n";
	#						echo "</pre>";
						} else {
							echo "<span class=\"error\">Boeken niet gelukt.<br><br>Foutmelding van het ".$soap_systeemnaam."-systeem: geen achternaam bekend (is een verplicht veld bij ".$soap_systeemnaam.").</span><p>";
						}
					} else {
						echo "<span class=\"error\">Boeken niet gelukt.<br><br>Foutmelding van het ".$soap_systeemnaam."-systeem: ophalen &quot;base_product_code&quot; niet gelukt. (".htmlentities($error).")</span><p>";
					}
					exit;
				} else {
					echo "<span class=\"error\">Boeken niet gelukt.<br><br>Foutmelding van het ".$soap_systeemnaam."-systeem: geen juiste leverancierscode aanwezig.</span><p>";
				}
				break;
			}
		}
	} else {
		echo "Er is geen XML-leverancierscode aan deze accommodatie gekoppeld.";
	}
}

?>