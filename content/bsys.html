<?php

if($login->logged_in) {
	if($_GET["bid"]) {
		$db->query("SELECT boeking_id, type_id, aankomstdatum, aantalpersonen FROM boeking WHERE boeking_id='".addslashes($_GET["bid"])."'".($boeking_wijzigen ? " AND website='".$vars["website"]."'" : "").";");
#		echo $db->lastquery;
		if($db->next_record()) {
			$accinfo=accinfo($db->f("type_id"),$db->f("aankomstdatum"),$db->f("aantalpersonen"));

			#
			# Gegevens uit database halen
			#
			$temp_gegevens=boekinginfo($db->f("boeking_id"));

			$gegevens["stap1"]=$temp_gegevens["stap1"];

			# Controle op status Persoonlijke gegevens (2 heeft voorkeur boven 1)
			if($temp_gegevens["stap2"][2]) {
				$gegevens["stap2"]=$temp_gegevens["stap2"][2];
			} elseif($temp_gegevens["stap2"][1]) {
				$gegevens["stap2"]=$temp_gegevens["stap2"][1];
			}

			# Controle op status Persoonlijke gegevens (2 heeft voorkeur boven 1)
			if($temp_gegevens["stap3"][2][2]) {
				$gegevens["stap3"]=$temp_gegevens["stap3"][2];
			} elseif($temp_gegevens["stap3"][1][2]) {
				$gegevens["stap3"]=$temp_gegevens["stap3"][1];
			}

			# Controle op status Geselecteerde opties (2 heeft voorkeur boven 1)
			if($temp_gegevens["stap4"][2]) {
				$gegevens["stap4"]=$temp_gegevens["stap4"][2];
				$gegevens["stap4"]["actieve_status"]=2;
				$gegevens["fin"]=$temp_gegevens["fin"][2];
			} else {
				$gegevens["stap4"]=$temp_gegevens["stap4"][1];
				$gegevens["stap4"]["actieve_status"]=1;
				$gegevens["fin"]=$temp_gegevens["fin"][1];
			}
			$gegevens["stap5"]=$temp_gegevens["stap5"];

			// Set the booking person country code
			if(file_exists("docdata/library/functions.php")) {
				require_once("docdata/library/functions.php");

				$gegevens["stap2"]["iso_land"] = docdata_iso_landcode($gegevens["stap2"]["land"], $gegevens["stap1"]["website"]);
			} else {
				$gegevens["stap2"]["iso_land"] = false;
			}

			if($gegevens["stap1"]["website"] == "B") {
				$gegevens["stap2"]["iso_land"] = "BE";
			}

			if(($temp_gegevens["stap4"][1]["korting"] and $mustlogin) or $temp_gegevens["stap4"][2]["korting"]) {
				$celbreedte=110;
			} else {
				$celbreedte=80;
			}
			if($mustlogin) {
				$bewerk_url="cms_boekingen_wijzigen.php?burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."&stap=";
			} else {
				$bewerk_url="bsys_wijzigen.php?burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."&stap=";
			}

			# Is deze boeking al bekeken door Chalet.nl?
			if($mustlogin and !$gegevens["stap1"]["gezien"] and $login->userlevel<10) {
				$db2->query("UPDATE boeking SET gezien=1 WHERE boeking_id='".$gegevens["stap1"]["boekingid"]."';");
			}

			if($mustlogin) {
				echo boekingkoptekst($gegevens);
			}

			# Moet deze boeking worden goedgekeurd?
			$db2->query("SELECT DISTINCT optie_onderdeel_id FROM boeking_optie WHERE status=2 AND boeking_id='".$gegevens["stap1"]["boekingid"]."';");
			if($db2->num_rows()) {
				$opties_goedkeuren=true;
			}

			$db2->query("SELECT DISTINCT annverz_voorheen FROM boeking_persoon WHERE annverz_voorheen IS NOT NULL AND boeking_id='".$gegevens["stap1"]["boekingid"]."';");
			if($db2->num_rows()) {
				$opties_goedkeuren=true;
			}

			if($gegevens["stap1"]["gewijzigd"]) $opties_goedkeuren=true;

			if($_GET["menu"]) {
				if($_GET["burl"]) {
					echo "<p><a href=\"".$_GET["burl"]."\">";
					if(ereg("cms\.php",$_GET["burl"])) {
						echo html("terugnaardehoofdpagina","bsys");
					} else {
						if($_GET["tnvp"]) {
							echo html("terugnaardevorigepagina","bsys");
						} else {
							echo html("terugnaardeoverzichtspagina","bsys");
						}
					}
					echo "</a></p>";
				} elseif($mustlogin and $_GET["bid"]) {
					echo "<p><a href=\"".$vars["path"]."cms_boekingen.php?show=21&21k0=".intval($_GET["bid"])."\">".html("terugnaardeoverzichtspagina","bsys")."</a></p>";
				} elseif($boeking_wijzigen and $_GET["bid"]) {
					echo "<p><a href=\"".$vars["path"]."bsys.php?bid=".intval($_GET["bid"])."\">".html("terugnaardeoverzichtspagina","bsys")."</a></p>";
				}
			} else {
				if($mustlogin) {
					$db2->query("SELECT leverancier_id, naam FROM leverancier WHERE leverancier_id='".addslashes($gegevens["stap1"]["leverancierid"])."';");
					if($db2->next_record()) {
						$temp["leverancier_naam"]=$db2->f("naam");
					}

#					echo "<h2>".($gegevens["stap1"]["boekingsnummer"] ? $gegevens["stap1"]["boekingsnummer"]." - " : "").htmlentities($temp["leverancier_naam"])." - ".htmlentities(wt_naam($gegevens["stap2"]["voornaam"],$gegevens["stap2"]["tussenvoegsel"],$gegevens["stap2"]["achternaam"]));
#					if($gegevens["stap1"]["reisbureau_naam"]) echo " (via ".htmlentities($gegevens["stap1"]["reisbureau_naam"]).")";
#					echo "</h2>";
#if($gegevens["stap1"]["voucherstatus"]) echo "<b>Voucherstatus: ".$vars["voucherstatus"][$gegevens["stap1"]["voucherstatus"]]."</b><p>";

					# Controle op blokkade van het account
					$db2->query("SELECT user_id FROM boekinguser WHERE wrongtime>='".(time()-3600)."' AND wrongcount>=3 AND user='".addslashes($gegevens["stap2"]["email"])."'");
					if($db2->next_record()) {
						echo "<span class=\"error\">De hoofdboeker heeft op dit moment geen toegang vanwege het 3x verkeerd invoeren van het wachtwoord.<ul><li><a href=\"".$_SERVER["REQUEST_URI"]."&deblock=".$db2->f("user_id")."&back=".urlencode($_SERVER["REQUEST_URI"])."\">Inlogblokkade opheffen</a></li></ul></span><p>";
					}

					if($opties_goedkeuren) {
						echo "<span class=\"error\">Er zijn bij deze boeking onderdelen die nog moeten worden beoordeeld. Wijzigingen aanbrengen in deze boeking is pas mogelijk na het goed- of afkeuren van deze onderdelen.</span><p>";
					}

					if($gegevens["stap1"]["zit_in_beheersysteem_melding"]) {
						echo $gegevens["stap1"]["zit_in_beheersysteem_melding"]."<p>";
					}

					if($opties_goedkeuren) {
						echo "<ul>";
						echo "<li><a href=\"".$_SERVER["REQUEST_URI"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."&menu=1\">Samenstelling reissom + inkoopwaarde</a></li>";
						echo "<li><a href=\"".$_SERVER["REQUEST_URI"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."&menu=2\"><b>Onderdelen beoordelen</b></a></li>";
						echo "</ul>";
					} else {
						if($gegevens["stap1"]["opmerkingen_intern"]) {
							echo "<table width=\"100%\" cellspacing=\"0\" cellpadding=\"0\"><tr><td valign=\"top\" width=\"60%\">";
						}
						if($_GET["bestaande"] or $gegevens["stap1"]["status_klanten_vorig_seizoen"]>0) {
							# Gegevens bestaande klanten (mail n.a.v. boeking vorig seizoen) tonen/bewerken
							echo "<b>Werving bestaande klanten:</b><br>";
							echo "<form method=\"post\" action=\"".htmlentities(($_GET["back"] ? $_GET["back"] : "cms_mail_klanten_vorig_seizoen.php?status=1"))."#regel".htmlentities($_GET["regel"])."\" name=\"frm\">";
							echo "<input type=\"hidden\" name=\"boekingsgegevens\" value=\"1\">";
							echo "<input type=\"hidden\" name=\"boekingid\" value=\"".$gegevens["stap1"]["boekingid"]."\">";
							echo "<table cellspacing=\"0\" cellpadding=\"0\"><tr><td>";
							echo "Status:&nbsp;&nbsp;&nbsp;";
							echo "<select name=\"status_klanten_vorig_seizoen\" onchange=\"if(document.frm.status_klanten_vorig_seizoen.value==2||document.frm.status_klanten_vorig_seizoen.value==3) document.getElementById('status_vanaf_klanten_vorig_seizoen').style.display=''; else document.getElementById('status_vanaf_klanten_vorig_seizoen').style.display='none';\">";
							if($gegevens["stap1"]["status_klanten_vorig_seizoen"]>0) unset($vars["status_bestaandeklanten"][0]);
							while(list($key,$value)=each($vars["status_bestaandeklanten"])) {
								echo "<option value=\"".$key."\"".($gegevens["stap1"]["status_klanten_vorig_seizoen"]==$key ? " selected" : "").">".htmlentities($value)."</option>";
							}
							echo "</select>";
							echo "</td><td>&nbsp;&nbsp;&nbsp;&nbsp;</td><td>";
							echo "<div id=\"status_vanaf_klanten_vorig_seizoen\" style=\"".($gegevens["stap1"]["status_klanten_vorig_seizoen"]==2||$gegevens["stap1"]["status_klanten_vorig_seizoen"]==3 ? "" : "display:none;")."\">";
							echo "Vanaf (optioneel)&nbsp;&nbsp;";
							echo "<select name=\"day\">";
							echo "<option> </option>";
							for($i=1;$i<=31;$i++) {
								echo "<option value=\"".$i."\"".($gegevens["stap1"]["status_vanaf_klanten_vorig_seizoen"]>0&&date("d",$gegevens["stap1"]["status_vanaf_klanten_vorig_seizoen"])==$i ? " selected" : "").">".$i."</option>";
							}
							echo "</select>&nbsp;&nbsp;";
							echo "<select name=\"month\">";
							echo "<option> </option>";
							for($i=1;$i<=12;$i++) {
								echo "<option value=\"".$i."\"".($gegevens["stap1"]["status_vanaf_klanten_vorig_seizoen"]>0&&date("m",$gegevens["stap1"]["status_vanaf_klanten_vorig_seizoen"])==$i ? " selected" : "").">".DATUM("MAAND",mktime(0,0,0,$i,1,2000))."</option>";
							}
							echo "</select>&nbsp;&nbsp;";
							echo "<select name=\"year\">";
							echo "<option> </option>";
							for($i=date("Y")-2;$i<=date("Y")+1;$i++) {
								echo "<option value=\"".$i."\"".($gegevens["stap1"]["status_vanaf_klanten_vorig_seizoen"]>0&&date("Y",$gegevens["stap1"]["status_vanaf_klanten_vorig_seizoen"])==$i ? " selected" : "").">".$i."</option>";
							}
							echo "</select>";
							echo "<div>";
							echo "</td></tr></table>";
							echo "<p>Opmerkingen:<br>";
							echo "<textarea name=\"opmerkingen_klanten_vorig_seizoen\" style=\"width:700px;height:100px;\">".htmlentities($gegevens["stap1"]["opmerkingen_klanten_vorig_seizoen"])."</textarea>";
							echo "<p><input type=\"submit\" value=\" OPSLAAN \" id=\"submit1frm\" onclick=\"document.frm.submit1frm.disabled=1;document.frm.submit();\">";
							echo "</form>";
							echo "<hr><p>";
						}

						if(($vars["acceptatie_testserver"] or $_SERVER["DOCUMENT_ROOT"]=="/home/webtastic/html") and $mustlogin) {
							$db2->query("SELECT user_id, password, password_uc FROM boekinguser WHERE user='".addslashes($gegevens["stap2"]["email"])."';");
							if($db2->next_record() and $db2->f("password_uc")) {

								$directlogin = new directlogin;
								$directlogin->boeking_id=$gegevens["stap1"]["boekingid"];
								$directlogin_link=$directlogin->maak_link($gegevens["stap1"]["website"],1,$db2->f("user_id"),md5($db2->f("password_uc")));

								$directlogin_link2=$directlogin->maak_link($gegevens["stap1"]["website"],2,$db2->f("user_id"),md5($db2->f("password_uc")));

								echo "<div class=\"opvalblok\">";
								if($_SERVER["DOCUMENT_ROOT"]=="/home/webtastic/html") {
									$directlogin_link=str_replace($vars["websiteinfo"]["basehref"][$gegevens["stap1"]["website"]],"http://".$_SERVER["HTTP_HOST"]."/chalet/",$directlogin_link);
									$directlogin_link="http://".$_SERVER["HTTP_HOST"]."/chalet/cms.php?gotourl=".urlencode($directlogin_link)."&testsite=".$gegevens["stap1"]["website"];

									$directlogin_link2=str_replace($vars["websiteinfo"]["basehref"][$gegevens["stap1"]["website"]],"http://".$_SERVER["HTTP_HOST"]."/chalet/",$directlogin_link2);
									$directlogin_link2="http://".$_SERVER["HTTP_HOST"]."/chalet/cms.php?gotourl=".urlencode($directlogin_link2)."&testsite=".$gegevens["stap1"]["website"];
									echo "Test-server";
								} else {
									echo "Acceptatie-server";
								}
								echo ":<ul>";
								echo "<li><a href=\"".wt_he($directlogin_link)."\" target=\"_blank\">Inloggen in &quot;Mijn boeking&quot;</a></li>";
								echo "<li><a href=\"".wt_he($directlogin_link2)."\" target=\"_blank\">Betalingen</a></li>";

								echo "</ul></div>";
							}
						}

						echo "Bekijken:<ul>";
						echo "<li><a href=\"".$_SERVER["REQUEST_URI"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."&menu=1\">Samenstelling reissom + inkoopwaarde</a></li>";
						echo "<li><a href=\"".$_SERVER["REQUEST_URI"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."&menu=2\">Gegevens en opties alle deelnemers</a></li>";
						$db2->query("SELECT boeking_id FROM boeking_enquete WHERE boeking_id='".addslashes($gegevens["stap1"]["boekingid"])."';");
						if($db2->num_rows()) {
							echo "<li><a href=\"".$path."cms_boekingen_enquete.php?burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."\">Ingevulde enqu&ecirc;te</a></li>";
						}
						echo "</ul>";
						if($_GET["bt"]==3 or !$gegevens["stap1"]["bevestigdatum"]) {
							echo "<a href=\"cms_boeking_oppakken.php?boekingid=".addslashes($gegevens["stap1"]["boekingid"])."\" target=\"_blank\">Deze onafgeronde boeking oppakken &gt; &gt;</a><p>";
						} else {

if($_SERVER["DOCUMENT_ROOT"]=="/home/webtastic/html") {
	$booking_payment = new booking_payment($gegevens);
	$booking_payment->get_amounts();
	echo wt_dump($booking_payment->text);
	echo wt_dump($booking_payment->amount);
	echo wt_dump($booking_payment->date);
}

							echo "Wijzigen:<ul>";
							echo "<li><a href=\"".$bewerk_url."1\">Algemene gegevens</a>";
#							echo " <font size=1>(status, reserveringsnummer, accommodatie, aantal personen, interne opmerkingen)</font>";
							echo "</li>";
							echo "<li><a href=\"".$bewerk_url."2\">Persoonlijke gegevens hoofdboeker</a></li>";
							echo "<li><a href=\"".$bewerk_url."3\">Persoonlijke gegevens overige deelnemers</a></li>";
							echo "<li><a href=\"".$bewerk_url."4\">Opties</a></li>";
							if($gegevens["stap1"]["goedgekeurd"]) {
								echo "<li><a href=\"".$path."cms_handmatige_opties.php?burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."\">Handmatige opties en bijkomende kosten</a></li>";
								echo "<li><a href=\"".$path."cms_boekingen_bedragen.php?burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."\">Bedragen</a></li>";
							}
							echo "<li><a href=\"".$path."cms_boekingen_leveranciers.php?burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."\">Inkoopgegevens accommodatie</a></li>";
							if($gegevens["stap1"]["goedgekeurd"]) {
								echo "<li><a href=\"".$path."cms_boekingen_facturen.php?burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."\">Facturen en diverse instellingen</a></li>";
								echo "<li><a href=\"".$path."cms_boekingen_betalingen.php?burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."\">Betalingen</a>".($login->has_priv(5) ? " (klant)" : "")."</li>";
								if($login->has_priv(5)) {
									echo "<li><a href=\"".$path."cms_boekingen_betalingen_lev.php?burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."\">Inkoopbetalingen</a> (leverancier)</li>";
								}
								echo "<li><a href=\"".$path."cms_boekingen_vouchers.php?burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."\">Vouchers</a></li>";
							}
							echo "</ul>";
							if($_GET["bt"]<>3 and $_GET["bt"]<>4 and $_GET["bt"]<>5 and $_GET["bt"]<>6) {
								$db2->query("SELECT leverancier_id, naam, url, xml_type, email_reserveringen AS email, opmerkingen_intern, standaardbestelmanier FROM leverancier WHERE leverancier_id='".addslashes($gegevens["stap1"]["leverancierid"])."';");
								if($db2->next_record()) {
									echo "Bestellen:";
										if($gegevens["stap1"]["verzameltype"]) {
											if($gegevens["stap1"]["verzameltype_gekozentype_id"]) {
												echo " <span class=\"error\">(verzameltype-boeking - het gekozen onderliggende type zal worden besteld)</span>";
												$verzameltype_accinfo=accinfo($gegevens["stap1"]["verzameltype_gekozentype_id"],$gegevens["stap1"]["aankomstdatum"],$gegevens["stap1"]["aantalpersonen"]);
												$gegevens["stap1"]["accinfo"]["leverancierscode"]=$verzameltype_accinfo["leverancierscode"];
											} else {
												echo " <span class=\"error\">(verzameltype-boeking - let op: er is nog geen onderliggend type geselecteerd)</span>";
											}
										}
										echo "<ul>";
										if(!$db2->f("standaardbestelmanier") or $db2->f("standaardbestelmanier")==1) {
											if($db2->f("email")) {
												echo "<li><a href=\"".$path."cms_bestelmailfax.php?t=1&burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."\">Via e-mail</a> (vanaf <i>".htmlentities($login->vars["email"])."</i>)</li>";
												echo "<li><a href=\"".$path."cms_bestelmailfax.php?t=1&burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."&info=1\">Via e-mail</a> (vanaf <i>info@chalet.nl</i>)</li>";
											} elseif($db2->f("standaardbestelmanier")) {
												echo "<li>Via e-mail: er is geen mailadres aan deze leverancier gekoppeld</li>";
											}
										}
										if(!$db2->f("standaardbestelmanier") or $db2->f("standaardbestelmanier")==2) {
											echo "<li><a href=\"".$path."cms_bestelmailfax.php?t=2&burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."\">Via fax</a></li>";
										}

										# Boeken via XML: aangeven welke xml-types hier gebruik van maken
										if($db2->f("xml_type")==1 or $db2->f("xml_type")==12 or $db2->f("xml_type")==13 or $db2->f("xml_type")==15 or $db2->f("xml_type")==18 or $db2->f("xml_type")==19 or $db2->f("xml_type")==20 or $db2->f("xml_type")==22) {
											if(!$db2->f("standaardbestelmanier") or $db2->f("standaardbestelmanier")==3) {
												if($gegevens["stap1"]["accinfo"]["leverancierscode"]) {
													echo "<li><a href=\"".$path."cms_boeken_xml.php?burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."\" onclick=\"return confirmClick(this,'Deze boeking bestellen via XML?');\">Via XML</a></li>";
												} else {
													echo "<li>Via XML: er is geen XML-code aan deze accommodatie gekoppeld</li>";
												}
											}
										}
										if($db2->f("standaardbestelmanier")==4) {
											if($db2->f("url")) {
												echo "<li><a href=\"".htmlentities($db2->f("url"))."\" target=\"_blank\">Via inlog op website</a>";
												if($gegevens["stap1"]["accinfo"]["bestelnaam"]) {
													echo " <i>(".htmlentities($gegevens["stap1"]["accinfo"]["bestelnaam"]).")</i>";
												}
												echo "</li>";
											} elseif($db2->f("standaardbestelmanier")) {
												echo "<li>Via inlog op website: er is geen website aan deze leverancier gekoppeld</li>";
											}
										}
										if($db2->f("standaardbestelmanier")==5) {
											echo "<li><b>Boeking moet intern verwerkt worden.</b></li>";
										}

										echo "</ul>";
#									} else {
#										echo "<b> is pas mogelijk na het invullen van het veld &quot;akkoord&quot; bij de <a href=\"".$path."cms_boekingen_leveranciers.php?burl=".urlencode($_SERVER["REQUEST_URI"])."&bid=".$gegevens["stap1"]["boekingid"]."\">inkoopgegevens</a></b><br><br>";
#									}
									if(trim($db2->f("opmerkingen_intern"))<>"") {
										echo "Opmerkingen leverancier:<br><ul><li>".nl2br(htmlentities($db2->f("opmerkingen_intern")))."</li></ul>";
									}
								}
							}
						}
						if($gegevens["stap1"]["opmerkingen_intern"]) {
							echo "</td><td valign=\"top\" width=\"40%\"><div style=\"border: solid #D40139 2px;padding:4px;\"><b>Interne opmerkingen:</b><p><font size=1>".nl2br(htmlentities($gegevens["stap1"]["opmerkingen_intern"]))."</font></div></td></tr></table>";
						}

					}
				} else {
					# Login loggen
					if(!$_SESSION["LOGIN"]["chaletboekingwijzigen"]["chaletlog_login"]) {
						$_SESSION["LOGIN"]["chaletboekingwijzigen"]["chaletlog_login"]=true;
						chalet_log("ingelogd in \"Mijn boeking\"",false,true);
#						exit;
					}
					if($vars["chalettour_logged_in"]) {
						if($gegevens["stap1"]["boekingsnummer"]) {
							echo "<p><b>".html("boeking","bsys")." ".$gegevens["stap1"]["boekingsnummer"]."</b></p>";
						} else {
							echo "<p><b>".html("aanvraagmoetnogbevestigdworden","bsys",array("v_websitenaam"=>$vars["websitenaam"])).".</b></p>";
						}
					} else {
						echo html("inleiding","bsys",array("v_websitenaam"=>$vars["websitenaam"]))."<p>";
					}
					echo html("bekijken","bsys").":<ul>\n";
					echo "<li><a href=\"".$path."bsys.php?menu=1&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html("samenstellingreissom","bsys")."</a></li>";
					echo "<li><a href=\"".$path."bsys.php?menu=2&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html("gegevensdeelnemers","bsys")."</a></li>";

					if($gegevens["stap1"]["factuurdatum"]>0) {
						if($gegevens["stap1"]["vraag_ondertekening"]) {
							# link naar "factuur goedkeuren"
							echo "<li><a href=\"".$path."bsys.php?menu=3&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html("factuurgoedkeuren","bsys")."</a></li>";
						} else {
							# link naar "factuur"
							echo "<li><a href=\"".$path."bsys.php?laatstefactuur=1&bid=".$gegevens["stap1"]["boekingid"]."\" target=\"_blank\">".html("factuur","bsys")."</a></li>";
						}
					}

					echo "</ul><hr>";
					if($gegevens["stap1"]["wijzigen_toegestaan"]) {
						echo html("wijzigen","bsys").":<ul>\n";
						echo "<li><a href=\"".$path."bsys_wijzigen.php?stap=1&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html("aantalpersonen","bsys")."</a></li>";
						echo "<li><a href=\"".$path."bsys_wijzigen.php?stap=2&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html("mijnpersoonlijkegegevens","bsys")."</a></li>";
						echo "<li><a href=\"".$path."bsys_wijzigen.php?stap=3&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html("persoonlijkegegevensoverigedeelnemers","bsys")."</a></li>";
						echo "<li><a href=\"".$path."bsys_wijzigen.php?stap=4&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html("opties","bsys")."</a></li>";
						echo "</ul>";
						if($gegevens["stap1"]["aantalpersonen"]==@count($gegevens["stap3"]["geboortedatum_ingevuld"])) {

						} else {
							echo "<br><b>".html("letopeerstgeboortedatainvullen","bsys")."</b>";
						}
					} else {
						if($gegevens["stap1"]["wijzigen_dagen"]==1) {
							echo html("wijzigennietmogelijk1dag","bsys",array("l1"=>"contact"));
						} else {
							echo html("wijzigennietmogelijkaantaldagen","bsys",array("v_aantal"=>$gegevens["stap1"]["wijzigen_dagen"],"l1"=>"contact"));
						}
					}
					echo "<hr>";

					if($gegevens["stap1"]["factuurdatum"]>0) {
						if(!$gegevens["stap1"]["vraag_ondertekening"]) {
							echo html("payment","bsys").":<ul>\n";

							# Get all registered payments
							$total_paid = 0;
							$sql = "SELECT SUM(bedrag) as total FROM `boeking_betaling` WHERE boeking_id = '" . mysql_real_escape_string($_GET["bid"]) . "'";
							$db->query($sql);
							if($db->num_rows() > 0) {
								$db->next_record();
								$total_paid = $db->f('total');
							}

							$ramining_payments = round($gegevens["fin"]["totale_reissom"] - $total_paid, 2);

							if($ramining_payments > 0) {
								if(is_array($vars["docdata_payments"])) {
									reset($vars["docdata_payments"]);
									$txt_by = "docdata";
									foreach($vars["docdata_payments"] as $method) {
										if($gegevens["stap2"]["iso_land"] && isset($method["country"]) && !in_array($gegevens["stap2"]["iso_land"], $method["country"])) continue;
										$txt_by .= "_" . $method["by"];
									}
								}
								if($txt[$vars["taal"]]["bsys"][$txt_by]) {
									echo "<li><a href=\"".$path."bsys_payments.php?menu=1&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html($txt_by,"bsys")."</a></li>";
								}
								echo "<li><a href=\"".$path."bsys_payments.php?menu=2&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html("via_bank_transfer","bsys")."</a></li>";
							}
							echo "<li><a href=\"".$path."bsys_payments.php?menu=3&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html("summary","bsys")."</a></li>";
							echo "</ul><hr>";
						}
					}
				}


				echo "&nbsp;<br>";

				echo "<table cellspacing=\"0\" class=\"toonacctabel\">";
				echo "<tr><th colspan=\"2\">".html("algemenegegevens","bsys")."</th>";
				if(!$mustlogin or $_GET["bt"]<>3) {
					echo "<tr><td width=\"165\" valign=\"top\">".html("status","bsys")."</td><td>";
					if($gegevens["stap1"]["geannuleerd"]) {
						echo "<b style=\"color:red\">".html("geannuleerd","bsys")."</b>";
					} elseif($gegevens["stap1"]["goedgekeurd"])  {
						echo html("geboekt","bsys");
					} else {
						echo html("aangevraagd","bsys");
					}
					echo "</td></tr>";
				}
				if(!$gegevens["stap1"]["goedgekeurd"]) {
					echo "<tr><td width=\"165\" valign=\"top\">".html("aanvraagnummer","bsys")."</td><td>".$gegevens["stap1"]["boekingid"]."</td></tr>";
				}

				if($gegevens["stap1"]["reisbureau_user_id"]) {
					echo "<tr><td width=\"165\" valign=\"top\">".html("reisbureau","bsys")."</td><td><a href=\"".$vars["path"]."cms_reisbureaus.php?show=27&27k0=".$gegevens["stap1"]["reisbureau_id"]."\">".htmlentities($gegevens["stap1"]["reisbureau_naam"])."</a> - ".htmlentities($gegevens["stap1"]["reisbureau_usernaam"])."</td></tr>";
				}


				if($gegevens["stap1"]["boekingsnummer"] and ($gegevens["stap1"]["goedgekeurd"] or $mustlogin)) {
					echo "<tr><td width=\"165\" valign=\"top\">".html("reserveringsnummer","bsys")."</td><td>".$gegevens["stap1"]["boekingsnummer"]."</td></tr>";
				}
				if($mustlogin) {
					echo "<tr><td width=\"165\" valign=\"top\">".html("hoofdboeker","bsys")."</td><td>".htmlentities(wt_naam($gegevens["stap2"]["voornaam"],$gegevens["stap2"]["tussenvoegsel"],$gegevens["stap2"]["achternaam"]))."&nbsp;(<a href=\"mailto:".$gegevens["stap2"]["email"]."\">".htmlentities($gegevens["stap2"]["email"])."</a>)</td></tr>";
				} else {
					echo "<tr><td width=\"165\" valign=\"top\">".html("hoofdboeker","bsys")."</td><td>".htmlentities(wt_naam($gegevens["stap2"]["voornaam"],$gegevens["stap2"]["tussenvoegsel"],$gegevens["stap2"]["achternaam"]))."&nbsp;</td></tr>";
				}

				if($mustlogin) {
					if($_GET["bt"]==3 or !$gegevens["stap1"]["bevestigdatum"]) {
						echo "<tr><td width=\"165\" valign=\"top\">Ingevuld op</td><td>".DATUM("DAG D MAAND JJJJ, UU:ZZ",$gegevens["stap1"]["invuldatum"])."u.</td></tr>";
						echo "<tr><td width=\"165\" valign=\"top\">Afgerond tot en met</td><td>Stap ".$gegevens["stap1"]["stap_voltooid"]."</td></tr>";
					} else {
						echo "<tr><td width=\"165\" valign=\"top\">Geboekt op</td><td>".DATUM("DAG D MAAND JJJJ, UU:ZZ",$gegevens["stap1"]["bevestigdatum"])."u.</td></tr>";
						echo "<tr><td width=\"165\" valign=\"top\">Via website</td><td>".htmlentities($vars["websites"][$gegevens["stap1"]["website"]])."</td></tr>";
					}
				}
				echo "<tr><td width=\"165\" valign=\"top\">".html("accommodatie","bsys")."</td><td><a href=\"".$gegevens["stap1"]["website_specifiek"]["basehref"].$accinfo["url_zonderpad"]."\" target=\"_blank\">".htmlentities($accinfo["begincode"].$accinfo["type_id"]." - ".ucfirst($accinfo["soortaccommodatie"])." ".$accinfo["naam_ap"])."</a>".($mustlogin ? " - <a href=\"cms_types.php?wzt=".$accinfo["wzt"]."&show=2&2k0=".$accinfo["type_id"]."\">CMS</a>" : "")."</td></tr>";
				echo "<tr><td width=\"165\" valign=\"top\">".html("plaats","bsys")."</td><td><a href=\"".$gegevens["stap1"]["website_specifiek"]["basehref"].$accinfo["plaats_url_zonderpad"]."\" target=\"_blank\">".htmlentities($accinfo["plaats"].", ".$accinfo["land"])."</a>".($mustlogin ? " - <a href=\"cms_plaatsen.php?wzt=".$accinfo["wzt"]."&show=4&4k0=".$accinfo["plaats_id"]."\">CMS</a>" : "")."</td></tr>";
				if($mustlogin) {
					echo "<tr><td width=\"165\" valign=\"top\">Tarievenoptie</td><td>".htmlentities(($gegevens["stap1"]["wederverkoop"] ? "Wederverkoop" : $vars["toonper"][$accinfo["toonper"]]))."</td></tr>";
					$db2->query("SELECT leverancier_id, naam FROM leverancier WHERE leverancier_id='".addslashes($gegevens["stap1"]["leverancierid"])."';");
					if($db2->next_record()) {
						echo "<tr><td width=\"165\" valign=\"top\">Leverancier</td><td><a href=\"".$path."cms_leveranciers.php?show=8&bc=".$_GET["bc"]."&8k0=".$db2->f("leverancier_id")."\">".htmlentities($db2->f("naam"))."</a> (".$db2->f("leverancier_id").")</td></tr>";
					}
					if($gegevens["stap1"]["accinfo"]["skipasid"]) {
						$db2->query("SELECT skipas_id, naam FROM skipas WHERE skipas_id='".addslashes($gegevens["stap1"]["accinfo"]["skipasid"])."';");
						if($db2->next_record()) {
							echo "<tr><td width=\"165\" valign=\"top\">Skipasleverancier</td><td><a href=\"".$path."cms_skipassen.php?show=10&bc=".$_GET["bc"]."&10k0=".$db2->f("skipas_id")."\">".htmlentities($db2->f("naam"))."</a></td></tr>";
						}
					}
				}
				echo "<tr><td valign=\"top\">".html("aantalpersonen","bsys")."</td><td>".htmlentities($gegevens["stap1"]["aantalpersonen"])."</td></tr>";
#				echo "<tr><td valign=\"top\">Verblijfsperiode</td><td>".htmlentities($accinfo["aankomstdatum"][$gegevens["stap1"]["aankomstdatum"]]." - ".DATUM("DAG D MAAND JJJJ",$gegevens["stap1"]["vertrekdatum"]))."</td></tr>";
				echo "<tr><td valign=\"top\">".html("verblijfsperiode","bsys")."</td><td>".DATUM("DAG D MAAND JJJJ",$gegevens["stap1"]["aankomstdatum_exact"],$vars["taal"])." - ".DATUM("DAG D MAAND JJJJ",$gegevens["stap1"]["vertrekdatum_exact"],$vars["taal"])." (".$gegevens["stap1"]["aantalnachten"]." ".html("nachten","bsys").")</td></tr>";

				if(!$mustlogin or $_GET["bt"]<>3) {
					echo "<tr><td valign=\"top\">".html("totalereissom","bsys")."</td><td>&euro;&nbsp;".number_format($gegevens["fin"]["totale_reissom"],2,',','.')."</td></tr>";
				}
				if($mustlogin) {
					$referer=getreferer($gegevens["stap1"]["bezoekerid"]);
					if($referer["opsomming"]) {
						echo "<tr><td valign=\"top\">Referentielink</td><td valign=\"top\">".$referer["opsomming"]."</td></tr>";
					}
					if($gegevens["stap1"]["referentiekeuze"]) {
						echo "<tr><td valign=\"top\">Referentiekeuze</td><td>";
						$referentiekeuze_array=split(",",$gegevens["stap1"]["referentiekeuze"]);
						unset($referentiekeuze_aantal);
						while(list($key,$value)=each($referentiekeuze_array)) {
							if($referentiekeuze_aantal) echo "<br>";
							echo htmlentities($vars["referentiekeuze"][$value]);
							$referentiekeuze_aantal++;
						}
						echo "</td></tr>";
					}
				}
				echo "</table>";
			}

			if($_GET["menu"]==1) {
				if($mustlogin) {
					#
					# Inkoop- en verkoopgegevens voor CMS-gebruikers
					#
					$reissom_tabel=reissom_tabel($gegevens,$accinfo,"",true);

					# Marge
#					echo "<p><table cellspacing=\"0\" class=\"toonacctabel_zonderborder\" style=\"width:900px;\">";
#					echo "<tr><th colspan=\"4\">Marge</th></tr>";
#					echo "<tr style=\"background-color:#ebebeb;\"><td width=\"800\">Verkoop</td><td>&euro;</td><td align=\"right\">".number_format($reissom_tabel["bedragen"]["verkoop"],2,',','.')."</td><td>&nbsp;</td></tr>";
#					echo "<tr style=\"background-color:#ffffff;\"><td width=\"800\">Inkoop</td><td>&euro;</td><td align=\"right\">".number_format($reissom_tabel["bedragen"]["inkoop"],2,',','.')."</td><td>&nbsp;</td></tr>";
#					echo "<tr style=\"background-color:#ebebeb;\"><td colspan=\"4\">&nbsp;</td></tr>";
#					echo "<tr style=\"background-color:#ffffff;\"><td width=\"800\">Marge</td><td>&euro;</td><td align=\"right\">".number_format($reissom_tabel["bedragen"]["marge_euro"],2,',','.')."</td><td>&nbsp;</td></tr>";
#					echo "<tr style=\"background-color:#ebebeb;\"><td width=\"800\">&nbsp;</td><td>&nbsp;</td><td align=\"right\">".number_format($reissom_tabel["bedragen"]["marge_percentage"],2,',','.')."</td><td align=\"left\">%</td></tr>";
#					echo "</table>";

					# Verkoop
					echo "<p><table cellspacing=\"0\" class=\"toonacctabel_zonderborder\" style=\"width:900px;\">";
					echo "<tr><th colspan=\"9\">".html("samenstellingreissom","bsys")."</th></tr>";
					echo $reissom_tabel["verkoop"];

					# Inkoop
					echo "<tr><td colspan=\"9\">&nbsp;</td></tr>";
					echo "<tr><th colspan=\"9\">Inkoopwaarde</th></tr>";
					echo $reissom_tabel["inkoop"];
					echo "</table>";
				} else {
					# Samenstelling reissom (voor klanten en reisagenten)
					echo "<p><table cellspacing=\"0\" class=\"toonacctabel_zonderborder\">";
					echo "<tr><th colspan=\"9\">".html("samenstellingreissom","bsys")."</th></tr>";
					echo reissom_tabel($gegevens,$accinfo);
					echo "</table>";
				}
			} elseif($_GET["menu"]==2) {

				if($opties_goedkeuren and $mustlogin) {
					echo "<p><i>goedkeuren/afkeuren van onderdelen kan onderaan deze pagina</i></p>";
				}

				if($mustlogin) {
					echo "<p><table cellspacing=\"0\" class=\"toonacctabel\">";
					echo "<tr><th colspan=\"2\">Algemeen</th>";
					if(ereg("AANTAL_PERSONEN_VAN_([0-9]+)",$gegevens["stap1"]["gewijzigd"],$regs)) {
						echo "<tr style=\"background-color:#AAFFA6\"><td valign=\"top\" width=\"175\">Aantal personen</td><td>".$regs[1]."</td></tr>";
						echo "<tr style=\"background-color:#FFA6AA\"><td valign=\"top\" width=\"175\">Aantal personen</td><td>".$gegevens["stap1"]["aantalpersonen"]."</td></tr>";
					} else {
						echo "<tr><td valign=\"top\" width=\"175\">Aantal personen</td><td>".$gegevens["stap1"]["aantalpersonen"]."</td></tr>";
					}
					echo "<tr".(ereg("ANN_",$gegevens["stap1"]["gewijzigd"]) ?  " style=\"background-color:#FFA6AA\"" : "")."><td valign=\"top\" width=\"175\">Annuleringsverzekering</td><td>".($gegevens["stap1"]["annverz_aantalpersonen"] ? "ja" : "nee")."</td></tr>";
					echo "<tr".(ereg("OPM_OPTIES",$gegevens["stap1"]["gewijzigd"]) ?  " style=\"background-color:#FFA6AA\"" : "")."><td valign=\"top\" width=\"175\">Opmerkingen m.b.t. opties</td><td>".nl2br(htmlentities($gegevens["stap1"]["opmerkingen_opties"]))."&nbsp;</td></tr>";
					echo "<tr><td valign=\"top\" width=\"175\">Opmerkingen stap 5</td><td>".nl2br(wt_he($gegevens["stap1"]["opmerkingen_boeker"]))."&nbsp;</td></tr>";
					echo "<tr".(ereg("SCHADEVERZEKERING",$gegevens["stap1"]["gewijzigd"]) ?  " style=\"background-color:#FFA6AA\"" : "")."><td valign=\"top\" width=\"175\">Schade Logies Verblijven</td><td>".($gegevens["stap1"]["schadeverzekering"] ? "ja" : "nee")."&nbsp;</td></tr>";
					if(ereg("OPTIES_NA_GEBOORTEDATUM",$gegevens["stap1"]["gewijzigd"])) {
						echo "<tr style=\"background-color:#FFA6AA;\"><td valign=\"top\" width=\"175\" colspan=\"2\">Let op: er zijn opties gewist n.a.v. geboortedatum-wijzigingen</td></tr>";
					}
					echo "</table>";
				}

				for($i=1;$i<=$gegevens["stap1"]["aantalpersonen"];$i++) {
					unset($totaal_persoon);
					echo "<p><table cellspacing=\"0\" class=\"toonacctabel\">";
					echo "<tr><th>".($i==1 ? html("hoofdboeker","bsys") : html("persoon","bsys")." ".$i)."</th>";
					echo "<td colspan=\"2\" align=\"right\" class=\"boekingstabel_bewerk\">";
					if(!$opties_goedkeuren and $_GET["bt"]<>3) {
						echo "<a href=\"".$bewerk_url.($i==1 ? "2&tnvp=1" : "3&tnvp=1#persoon".$i)."\">".html("bewerkpersoonlijkegegevens","bsys")."</a>";
						if($i==1 or ($gegevens["stap3"][$i]["voornaam"] and $gegevens["stap3"][$i]["achternaam"] and $gegevens["stap3"][$i]["plaats"] and $gegevens["stap3"][$i]["geslacht"] and isset($gegevens["stap3"][$i]["geboortedatum"]))) {
							if($gegevens["stap1"]["wijzigen_toegestaan"]) {
								echo " - <a href=\"".$bewerk_url."4&tnvp=1#persoon".$i."\">".html("bewerkopties","bsys")."</a>";
							}
						}
					} else {
						echo "&nbsp;";
					}
					echo "</td></tr>";
					if($i==1) {
						echo "<tr><td width=\"165\" valign=\"top\">".html("naam","bsys")."</td><td valign=\"top\" width=\"350\">".htmlentities(wt_naam($gegevens["stap2"]["voornaam"],$gegevens["stap2"]["tussenvoegsel"],$gegevens["stap2"]["achternaam"]))."&nbsp;</td><td>&nbsp;</td></tr>";
						echo "<tr><td valign=\"top\">".html("adres","bsys")."</td><td valign=\"top\">".($gegevens["stap2"]["adres"] ? htmlentities($gegevens["stap2"]["adres"]) : "&nbsp;")."</td><td>&nbsp;</td></tr>";
						echo "<tr><td valign=\"top\">".html("postcode","bsys")."</td><td valign=\"top\">".htmlentities($gegevens["stap2"]["postcode"])."&nbsp;</td><td>&nbsp;</td></tr>";
						echo "<tr><td valign=\"top\">".html("woonplaats","bsys")."</td><td valign=\"top\">".htmlentities($gegevens["stap2"]["plaats"])."&nbsp;</td><td>&nbsp;</td></tr>";
						echo "<tr><td valign=\"top\">".html("land","bsys")."</td><td valign=\"top\">".htmlentities($gegevens["stap2"]["land"])."&nbsp;</td><td>&nbsp;</td></tr>";
						echo "<tr><td valign=\"top\">".html("geboortedatum","bsys")."</td><td valign=\"top\">".(isset($gegevens["stap2"]["geboortedatum"]) ? wt_adodb_date("d-m-Y",$gegevens["stap2"]["geboortedatum"]) : "<i class=\"wtform_error\">".html("nognietingevoerd","bsys")."</i>")."</td><td>&nbsp;</td></tr>";

						echo "<tr><td valign=\"top\">".html("geslacht","bsys")."</td><td valign=\"top\">";
						if($gegevens["stap2"]["geslacht"]==1) {
							echo html("man","vars");
						} elseif($gegevens["stap2"]["geslacht"]==2) {
							echo html("vrouw","vars");
						}
						echo "&nbsp;</td><td>&nbsp;</td></tr>";
						echo "<tr><td valign=\"top\">".html("telefoon","bsys")."</td><td valign=\"top\">".htmlentities($gegevens["stap2"]["telefoonnummer"]);
						if($gegevens["stap2"]["mobielwerk"]) echo " / ".htmlentities($gegevens["stap2"]["mobielwerk"]);
						echo "&nbsp;</td><td>&nbsp;</td></tr>";
						echo "<tr><td valign=\"top\">".html("email","bsys")."</td><td valign=\"top\">";
						if($mustlogin) {
							echo "<a href=\"mailto:".$gegevens["stap2"]["email"]."\">".htmlentities($gegevens["stap2"]["email"])."</a>";
						} else {
							echo htmlentities($gegevens["stap2"]["email"]);
						}
						echo "&nbsp;</td><td>&nbsp;</td></tr>";
					} else {
						echo "<tr><td width=\"165\" valign=\"top\">".html("naam","bsys")."</td><td valign=\"top\">";
						if($gegevens["stap3"][$i]["voornaam"] or $gegevens["stap3"][$i]["achternaam"]) {
							echo htmlentities(wt_naam($gegevens["stap3"][$i]["voornaam"],$gegevens["stap3"][$i]["tussenvoegsel"],$gegevens["stap3"][$i]["achternaam"]));
						} else {
							echo "<i class=\"wtform_error\">".html("nognietingevoerd","bsys")."</i>";
						}
						echo "</td><td>&nbsp;</td></tr>";
						echo "<tr><td valign=\"top\">".html("woonplaats","bsys")."</td><td valign=\"top\">";
						if($gegevens["stap3"][$i]["plaats"]) {
							echo htmlentities($gegevens["stap3"][$i]["plaats"]);
						} else {
							echo "<i class=\"wtform_error\">".html("nognietingevoerd","bsys")."</i>";
						}
						echo "</td><td>&nbsp;</td></tr>";
						echo "<tr><td valign=\"top\">".html("geboortedatum","bsys")."</td><td valign=\"top\">";
						if(isset($gegevens["stap3"][$i]["geboortedatum"])) {
							echo wt_adodb_date("d-m-Y",$gegevens["stap3"][$i]["geboortedatum"]);
						} else {
							echo "<i class=\"wtform_error\">".html("nognietingevoerd","bsys")."</i>";
						}
						echo "</td><td>&nbsp;</td></tr>";
						echo "<tr><td valign=\"top\">".html("geslacht","bsys")."</td><td valign=\"top\">";
						if($gegevens["stap3"][$i]["geslacht"]==1) {
							echo html("man","vars");
						} elseif($gegevens["stap3"][$i]["geslacht"]==2) {
							echo html("vrouw","vars");
						} else {
							echo "<i class=\"wtform_error\">".html("nognietingevoerd","bsys")."</i>";
						}
						echo "</td><td>&nbsp;</td></tr>";
					}

					# Accommodatie / arrangement
					if($accinfo["toonper"]==3 or $gegevens["stap1"]["wederverkoop"]) {
						echo "<tr><td valign=\"top\">".html("accommodatie","bsys")."</td><td valign=\"top\">".htmlentities(ucfirst($accinfo["soortaccommodatie"])." ".$accinfo["naam_ap"])."</td>";
						echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\">";
						echo "<span style=\"float:left;\">&euro;&nbsp;</span><span style=\"float:right;\">".number_format($gegevens["stap1"]["verkoop"]/$gegevens["stap1"]["aantalpersonen"],2,',','.')."</span>";
						echo "</td></tr>";
						$totaal_persoon+=$gegevens["stap1"]["verkoop"]/$gegevens["stap1"]["aantalpersonen"];
					} else {
						echo "<tr><td valign=\"top\">".html("accommodatieplusskipas","bsys")."</td><td valign=\"top\">".htmlentities(ucfirst($accinfo["soortaccommodatie"])." ".$accinfo["naam_ap"])."</td>";
						echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\">";
						echo "<span style=\"float:left;\">&euro;&nbsp;</span><span style=\"float:right;\">".number_format($gegevens["stap1"]["verkoop"],2,',','.')."</span>";
						echo "</td></tr>";
						$totaal_persoon+=$gegevens["stap1"]["verkoop"];
					}

					# Opties
					if($mustlogin) {
						if(is_array($temp_gegevens["stap4"][2][$i]["optiesoort_perpersoon"]) or $temp_gegevens["stap4"][2]["algemene_optie_zelfgekozen"]) {
							$gewijzigde_opties=true;
						} else {
							$gewijzigde_opties=false;
						}

						#
						# Algemene opties
						#

						# Status=1
						@reset($temp_gegevens["stap4"][1]["algemene_optie"]["soort"]);
						while(list($key,$value)=@each($temp_gegevens["stap4"][1]["algemene_optie"]["soort"])) {
							if($opties_goedkeuren and !$temp_gegevens["stap4"][2]["algemene_optie"]["naam"][$key]) {
								# Optie is uitgezet
								echo "<tr style=\"background-color:#FFA6AA\"><td valign=\"top\">".htmlentities(ucfirst($value))."</td><td valign=\"top\"><i>Uitgezet</i></td><td>&nbsp;</td></tr>";
								$factuur_tewijzigen=true;
							} else {
								echo "<tr".($gewijzigde_opties && !$temp_gegevens["stap4"][2]["algemene_optie"]["naam_op_onderdeel_id"][$temp_gegevens["stap4"][1]["algemene_optie"]["optie_onderdeel_id"][$key]] ? " style=\"background-color:#AAFFA6\"" : "")."><td valign=\"top\">".htmlentities(($value ? ucfirst($value) : $temp_gegevens["stap4"][1]["algemene_optie"]["naam"][$key]))."</td><td valign=\"top\">".($value ? htmlentities($temp_gegevens["stap4"][1]["algemene_optie"]["naam"][$key]) : "&nbsp;")."</td>";
								echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\">";
								echo "<span style=\"float:left;\">&euro;&nbsp;</span><span style=\"float:right;\">".number_format($temp_gegevens["stap4"][1]["algemene_optie"]["verkoop"][$key]/$temp_gegevens["stap1"]["aantalpersonen"],2,',','.')."</span>";
								echo "</td></tr>";
								$totaal_persoon+=$temp_gegevens["stap4"][1]["algemene_optie"]["verkoop"][$key]/$temp_gegevens["stap1"]["aantalpersonen"];
							}
						}


						# Status=2
						@reset($temp_gegevens["stap4"][2]["algemene_optie"]["soort"]);
						while(list($key,$value)=@each($temp_gegevens["stap4"][2]["algemene_optie"]["soort"])) {
							if($temp_gegevens["stap4"][2]["algemene_optie"]["naam"][$key] and !$temp_gegevens["stap4"][1]["algemene_optie"]["naam_op_onderdeel_id"][$temp_gegevens["stap4"][2]["algemene_optie"]["optie_onderdeel_id"][$key]]) {
								echo "<tr style=\"background-color:#FFA6AA\"><td valign=\"top\">".htmlentities(($value ? ucfirst($value) : $temp_gegevens["stap4"][2]["algemene_optie"]["naam"][$key]))."</td><td valign=\"top\">".($value ? htmlentities($temp_gegevens["stap4"][2]["algemene_optie"]["naam"][$key]) : "&nbsp;")."</td>";
								echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\">";
								echo "<span style=\"float:left;\">&euro;&nbsp;</span><span style=\"float:right;\">".number_format($temp_gegevens["stap4"][2]["algemene_optie"]["verkoop"][$key]/$temp_gegevens["stap1"]["aantalpersonen"],2,',','.')."</span>";
								echo "</td></tr>";
								$factuur_tewijzigen=true;
							}
						}

						#
						# Gewone opties
						#

						#
						# Status=1
						#
						if(is_array($temp_gegevens["stap4"][1][$i]["optiesoort_perpersoon"])) {
							while(list($key,$value)=@each($temp_gegevens["stap4"][1][$i]["optiesoort_perpersoon"])) {
								if($opties_goedkeuren and !$temp_gegevens["stap4"][2][$i]["optieonderdeel_id"][$key] and !$temp_gegevens["stap4"][1][$i]["optieonderdeel_extra"][$key]) {
									# Optie is uitgezet
									echo "<tr style=\"background-color:#FFA6AA\"><td valign=\"top\">".htmlentities(ucfirst($value))."</td><td valign=\"top\"><i>Uitgezet</i></td><td>&nbsp;</td></tr>";
									$factuur_tewijzigen=true;
								} else {
									echo "<tr".($gewijzigde_opties && !$temp_gegevens["stap4"][2]["optie_onderdeelid"][$i][$temp_gegevens["stap4"][1][$i]["optieonderdeel_id"][$key]] && !$temp_gegevens["stap4"][1][$i]["optieonderdeel_extra"][$key] ? " style=\"background-color:#AAFFA6\"" : "")."><td valign=\"top\">".htmlentities(($value ? ucfirst($value) : $temp_gegevens["stap4"][1][$i]["optieonderdeel_perpersoon"][$key]))."</td><td valign=\"top\">";
									if($value) {
										echo htmlentities($temp_gegevens["stap4"][1][$i]["optieonderdeel_perpersoon"][$key]);
									} else {
										echo "&nbsp;";
									}
									echo "</td>";
									echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\"><span style=\"float:left;\">".($temp_gegevens["stap4"][1][$i]["optieonderdeel_verkoop"][$key]<0 ? html("korting","bsys")."&nbsp;" : "")."&euro;&nbsp;</span><span style=\"float:right;\">".number_format(abs($temp_gegevens["stap4"][1][$i]["optieonderdeel_verkoop"][$key]),2,',','.')."</span></td>";
									echo "</tr>";
									$totaal_persoon+=$temp_gegevens["stap4"][1][$i]["optieonderdeel_verkoop"][$key];
								}
							}
						}
						#
						# Status=2
						#
						if(is_array($temp_gegevens["stap4"][2][$i]["optiesoort_perpersoon"])) {
							while(list($key,$value)=@each($temp_gegevens["stap4"][2][$i]["optiesoort_perpersoon"])) {
								if($temp_gegevens["stap4"][2][$i]["optieonderdeel_id"][$key] and !$temp_gegevens["stap4"][1]["optie_onderdeelid"][$i][$temp_gegevens["stap4"][2][$i]["optieonderdeel_id"][$key]]) {
									echo "<tr style=\"background-color:#FFA6AA\"><td valign=\"top\">".htmlentities(ucfirst($value))."</td><td valign=\"top\">";
									echo htmlentities($temp_gegevens["stap4"][2][$i]["optieonderdeel_perpersoon"][$key]);
									echo "</td>";
									echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\"><span style=\"float:left;\">".($temp_gegevens["stap4"][2][$i]["optieonderdeel_verkoop"][$key]<0 ? html("korting","bsys")."&nbsp;" : "")."&euro;&nbsp;</span><span style=\"float:right;\">".number_format(abs($temp_gegevens["stap4"][2][$i]["optieonderdeel_verkoop"][$key]),2,',','.')."</span></td>";
									echo "</tr>";
									$factuur_tewijzigen=true;
								}
							}
						}
					} else {

						# Algemene opties
						@reset($gegevens["stap4"]["algemene_optie"]["soort"]);
						while(list($key,$value)=@each($gegevens["stap4"]["algemene_optie"]["soort"])) {
							echo "<tr><td valign=\"top\">".htmlentities(($value ? ucfirst($value) : $gegevens["stap4"]["algemene_optie"]["naam"][$key]))."</td><td valign=\"top\">".($value ? htmlentities($gegevens["stap4"]["algemene_optie"]["naam"][$key]) : "&nbsp;")."</td>";
							echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\">";
							echo "<span style=\"float:left;\">&euro;&nbsp;</span><span style=\"float:right;\">".number_format($gegevens["stap4"]["algemene_optie"]["verkoop"][$key]/$gegevens["stap1"]["aantalpersonen"],2,',','.')."</span>";
							echo "</td></tr>";
							$totaal_persoon+=$gegevens["stap4"]["algemene_optie"]["verkoop"][$key]/$gegevens["stap1"]["aantalpersonen"];
						}

						# Gewone opties
						if(is_array($gegevens["stap4"][$i]["optiesoort_perpersoon"])) {
							while(list($key,$value)=@each($gegevens["stap4"][$i]["optiesoort_perpersoon"])) {
								echo "<tr><td valign=\"top\">".htmlentities(ucfirst($value))."</td><td valign=\"top\">";
								echo htmlentities($gegevens["stap4"][$i]["optieonderdeel_perpersoon"][$key]);
								echo "</td>";
								if($gegevens["stap4"][$i]["optieonderdeel_reisverzekering"][$key]) {
									$optie_bedrag=$gegevens["stap4"][$i]["optieonderdeel_verkoop"][$key]+($gegevens["fin"]["reisverzekering_poliskosten"]/count($gegevens["stap4"]["reisverzekering_per_persoon"]));
								} else {
									$optie_bedrag=$gegevens["stap4"][$i]["optieonderdeel_verkoop"][$key];
								}
								echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\">";
								echo "<span style=\"float:left;\">".($optie_bedrag<0 ? html("korting","bsys")."&nbsp;" : "")."&euro;&nbsp;</span><span style=\"float:right;\">".number_format(abs($optie_bedrag),2,',','.')."</span>";
								echo "</td>";
								echo "</tr>";
								$totaal_persoon+=$optie_bedrag;
							}
						}
					}

					# Annuleringsverzekering
#					if($gegevens["stap1"]["annuleringsverzekering"]) {
#						echo "<tr><td valign=\"top\">".html("annuleringsverzekering","bsys")."</td><td valign=\"top\">&nbsp;</td>";
#						echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\">";
#						echo "<span style=\"float:left;\">&euro;&nbsp;</span><span style=\"float:right;\">".number_format(($gegevens["fin"]["annuleringsverzekering_percentage"]+$gegevens["fin"]["annuleringsverzekering_poliskosten"])/$gegevens["stap1"]["aantalpersonen"],2,',','.')."</span>";
#						echo "</td></tr>";
#						$totaal_persoon+=($gegevens["fin"]["annuleringsverzekering_percentage"]+$gegevens["fin"]["annuleringsverzekering_poliskosten"])/$gegevens["stap1"]["aantalpersonen"];
#					}

					# Annuleringsverzekering
					if($gegevens["stap3"][$i]["annverz"] or ($mustlogin and $gegevens["stap3"][$i]["annverz_voorheen"])) {
						if($gegevens["stap3"][$i]["annverz"]) {
							if($mustlogin and $gegevens["stap3"][$i]["annverz_voorheen"]<>"") {
								echo "<tr".($mustlogin && $gegevens["stap3"][$i]["annverz_voorheen"]<>"" ? " style=\"background-color:#FFA6AA\"" : "").">";
								$factuur_tewijzigen=true;
							} else {
								echo "<tr>";
							}
							echo "<td valign=\"top\">".html("annuleringsverzekering","bsys")."</td><td valign=\"top\">".htmlentities($vars["annverz_soorten"][$gegevens["stap3"][$i]["annverz"]])."</td>";
							echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\">";
							if($gegevens["stap1"]["annverz_aantalpersonen"]) {
								$ann_temp_bedrag=round($gegevens["stap4"][$i]["annverz_persoon"]+($gegevens["fin"]["annuleringsverzekering_poliskosten"]/$gegevens["stap1"]["annverz_aantalpersonen"]),2);
							} else {
								unset($ann_temp_bedrag);
							}
							echo "<span style=\"float:left;\">&euro;&nbsp;</span><span style=\"float:right;\">".number_format($ann_temp_bedrag,2,',','.')."</span>";
							echo "</td></tr>";
							$totaal_persoon+=$ann_temp_bedrag;
						} else {
							# Annuleringsverzekering is uitgezet
							echo "<tr style=\"background-color:#FFA6AA\"><td valign=\"top\">".html("annuleringsverzekering","bsys")."</td><td valign=\"top\"><i>Uitgezet</i></td><td>&nbsp;</td></tr>";
							$factuur_tewijzigen=true;
						}
					}

					# Schadeverzekering
					if($gegevens["stap1"]["schadeverzekering"]) {
						echo "<tr>";
						echo "<td valign=\"top\">".html("schadeverzekering","bsys")."</td><td valign=\"top\">&nbsp;</td>";
						echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\">";
						$schadeverzekering_temp_bedrag=round(($gegevens["fin"]["schadeverzekering_variabel"]/$gegevens["stap1"]["aantalpersonen"]),2);
						echo "<span style=\"float:left;\">&euro;&nbsp;</span><span style=\"float:right;\">".number_format($schadeverzekering_temp_bedrag,2,',','.')."</span>";
						echo "</td></tr>";
						$totaal_persoon+=$schadeverzekering_temp_bedrag;
					}

					# Poliskosten alle verzekeringen samen
					if($gegevens["stap1"]["heeft_verzekering_per_persoon"][$i] or $gegevens["stap1"]["schadeverzekering"]) {
						if($gegevens["stap1"]["schadeverzekering"]) {
							$temp_bedrag=round(($gegevens["fin"]["verzekeringen_poliskosten"]/$gegevens["stap1"]["aantalpersonen"]),2);
						} else {
							$temp_bedrag=round($gegevens["fin"]["verzekeringen_poliskosten"]/count($gegevens["stap1"]["heeft_verzekering_per_persoon"]),2);
						}
						echo "<tr><td valign=\"top\">".html("poliskostenverzekeringen","bsys")."</td><td>&nbsp;</td><td valign=\"top\">";
						echo "<span style=\"float:left;\">&euro;&nbsp;</span><span style=\"float:right;\">".number_format($temp_bedrag,2,',','.')."</span>";
						echo "</td></tr>";
						$totaal_persoon+=$temp_bedrag;
					}

					# Reserveringskosten
					if($gegevens["fin"]["reserveringskosten"]>0) {
						echo "<tr><td valign=\"top\">".html("reserveringskosten","bsys")."</td><td valign=\"top\">&nbsp;</td>";
						echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\">";
						$temp_bedrag=round($gegevens["fin"]["reserveringskosten"]/$gegevens["stap1"]["aantalpersonen"],2);
						echo "<span style=\"float:left;\">&euro;&nbsp;</span><span style=\"float:right;\">".number_format($temp_bedrag,2,',','.')."</span>";
						echo "</td></tr>";
						$totaal_persoon+=$temp_bedrag;
					}

					# Totaal
					if(!$opties_goedkeuren) {
						echo "<tr style=\"font-weight:bold;\"><td valign=\"top\">".html("totaal","bsys")."</td><td valign=\"top\">&nbsp;</td>";
						echo "<td nowrap width=\"".$celbreedte."\" valign=\"top\">";
						echo "<span style=\"float:left;\">&euro;&nbsp;</span><span style=\"float:right;\">".number_format($totaal_persoon,2,',','.')."</span>";
						echo "</td></tr>";
					}

					echo "</table>";
				}

				if($opties_goedkeuren and $mustlogin) {
					echo "<p><a href=\"".$_SERVER["REQUEST_URI"]."&goedkeuren=1\" onclick=\"return confirmClick(this,'Alle rode onderdelen goedkeuren?');\"><img src=\"".$vars["path"]."pic/icon_okay.png\" width=\"20\" height=\"20\" style=\"margin-right:5px;margin-bottom:-5px;\">rode onderdelen goedkeuren</a><br><br><a href=\"".$_SERVER["REQUEST_URI"]."&afkeuren=1\" onclick=\"return confirmClick(this,'Alle rode onderdelen afkeuren?');\"><img src=\"".$vars["path"]."pic/icon_notokay.png\" width=\"20\" height=\"20\" style=\"margin-right:5px;margin-bottom:-5px;\">rode onderdelen afkeuren</a></p>";
				}

				if($mustlogin) {
					# Kijken of de wijzigingen een nieuwe factuur vereisen
					if($factuur_tewijzigen or ereg("AANTAL_PERSONEN_VAN_([0-9]+)",$gegevens["stap1"]["gewijzigd"]) or ereg("SCHADEVERZEKERING",$gegevens["stap1"]["gewijzigd"]) or ereg("ANN_",$gegevens["stap1"]["gewijzigd"])) {
						$db2->query("UPDATE boeking SET factuur_tewijzigen=1 WHERE boeking_id='".addslashes($gegevens["stap1"]["boekingid"])."';");
					}
				}
			} elseif($_GET["menu"]==3 and $gegevens["stap1"]["boekingsnummer"]) {
				#
				# Accordeer-systeem
				#

				echo "<div style=\"border:1px solid #cccccc;background-color:#ebebeb;padding:10px;\">";
				echo "<h2>".html("factuurgoedkeuren","bsys")."</h2>";

				if($_GET["akkoord"]) {
					# Bedankt na akkoord geven
					echo "<p>".html("akkoordmelding1","bsys")."</p>";

					// if($vars["website"] == "C" || $vars["website"] == "E" || $vars["website"] == "B") {
					if($vars["docdata_payments"]) {
						reset($vars["docdata_payments"]);
						$txt_by = "docdata";
						foreach($vars["docdata_payments"] as $method) {
							if($gegevens["stap2"]["iso_land"] && isset($method["country"]) && !in_array($gegevens["stap2"]["iso_land"], $method["country"])) continue;
							$txt_by .= "_" . $method["by"];
						}
						if($txt[$vars["taal"]]["bsys"][$txt_by]) {
							echo "<p><a href=\"".$path."bsys_payments.php?menu=1&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">".html("pay_now","bsys", array("v_method" => txt($txt_by,"bsys")))." &raquo;</a></p>";
						}
						echo "<p><a href=\"".$path."bsys_payments.php?menu=2&bid=".$gegevens["stap1"]["boekingid"]."&burl=".urlencode($_SERVER["REQUEST_URI"])."\">". html("paynow_bank_transfer","bsys") ." &raquo;</a></p>";
					}

					echo "<p>".html("akkoordmelding2","bsys")."</p>";
					echo "<p><a href=\"".$vars["path"]."bsys.php?bid=".intval($_GET["bid"])."\">".html("akkoordmelding3","bsys")."</a></p>";

				} elseif($gegevens["stap1"]["factuur_ondertekendatum"] and !$gegevens["stap1"]["vraag_ondertekening"]) {
					echo "<p>".html("boekingisalgoedgekeurd","bsys",array("v_boekingsnummer"=>$gegevens["stap1"]["boekingsnummer"]))."</p>";
				} else {
					if($gegevens["stap1"]["factuurdatum"]>0) {

						echo "<table cellpadding=\"5\">";
						echo "<form method=\"post\" action=\"".wt_he($_SERVER["REQUEST_URI"])."\" name=\"factuurakkoord\">";
						echo "<input type=\"hidden\" name=\"factuurakkoord\" value=\"1\">";

						if($_POST["factuurakkoord"]) {
							echo "<tr><td colspan=\"2\"><strong>".html("gaakkoordmetallevoorwaarden","bsys")."</strong></td></tr>";
						}

						echo "<tr><td style=\"vertical-align:top;\"><input type=\"checkbox\" name=\"goedkeur1\" id=\"goedkeur1\"></td><td><label for=\"goedkeur1\">".html("akkoordfactuur","bsys",array("h_1"=>"<a href=\"".$vars["path"]."bsys.php?laatstefactuur=1&bid=".intval($_GET["bid"])."\" target=\"_blank\">","h_2"=>"</a>","v_boekingsnummer"=>$gegevens["stap1"]["boekingsnummer"]))."</label></td></tr>";

						if($gegevens["stap1"]["website_specifiek"]["websitetype"]==9) {
							$pdffile="pdf/".txt("pdf_algemene_voorwaarden")."_venturasol.pdf";
						} else {
							$pdffile="pdf/".txt("pdf_algemene_voorwaarden").".pdf";
						}

						echo "<tr><td style=\"vertical-align:top;\"><input type=\"checkbox\" name=\"goedkeur2\" id=\"goedkeur2\"></td><td><label for=\"goedkeur2\">".html("akkoordvoorwaarden","bsys",array("v_websitenaam"=>$vars["websitenaam"],"h_1"=>"<a href=\"".$vars["path"].$pdffile."\" target=\"_blank\">","h_2"=>"</a>"))."</label>:";
						echo "<ol>";

						if(txt("pdf_voorwaarden_europeesche_annverz")<>"NA") {
							echo "<li><a href=\"".$vars["path"]."pdf/".txt("pdf_voorwaarden_europeesche_annverz").".pdf\" target=\"_blank\">".html("voorwaarden_annuleringsverzekering","bsys")."</a></li>";
						}

						if(txt("pdf_voorwaarden_schadeverzekering")<>"NA") {
							echo "<li><a href=\"".$vars["path"]."pdf/".txt("pdf_voorwaarden_schadeverzekering").".pdf\" target=\"_blank\">".html("voorwaarden_schadeverzekering","bsys")."</a></li>";
						}

						if(txt("pdf_voorwaarden_europeesche_reisverz")<>"NA") {
							echo "<li><a href=\"".$vars["path"]."pdf/".txt("pdf_voorwaarden_europeesche_reisverz").".pdf\" target=\"_blank\">".html("voorwaarden_reisverzekering","bsys")."</a></li>";
						}
						echo "</ol></td></tr>";

						echo "<tr><td colspan=\"2\" align=\"center\"><input type=\"submit\" value=\" ".wt_he(strtoupper(txt("akkoord","bsys")))." \" id=\"factuurakkoordsubmit\" disabled onclick=\"document.factuurakkoord.factuurakkoordsubmit.disabled=1;submit();\"></td></tr>";

						echo "</form>";
						echo "</table>";

					} else {
						trigger_error("gevraagd om goedkeuring factuur terwijl er nog geen factuurdatum is vastgelegd bij deze boeking",E_USER_NOTICE);
					}
				}
			}
		}
	} else {
		echo html("geenactueleboekingengekoppeld","bsys");
		$db->query("SELECT DISTINCT b.boeking_id FROM boeking b, boeking_persoon bp WHERE b.boeking_id=bp.boeking_id AND b.website='".$vars["website"]."' AND bp.email='".addslashes($login->username)."' AND b.bevestigdatum IS NOT NULL AND b.aankomstdatum>'".(time()-864000)."';");
		if(!$db->num_rows()) {
			$db->query("SELECT DISTINCT DISTINCT b.website FROM boeking b, boeking_persoon bp WHERE b.boeking_id=bp.boeking_id AND b.website<>'".$vars["website"]."' AND bp.email='".addslashes($login->username)."' AND b.bevestigdatum IS NOT NULL AND b.aankomstdatum>'".(time()-864000)."';");
			if($db->num_rows()) {
				echo "<p>".html("ganaar","bsys")."<ul>";
				while($db->next_record()) {
					echo "<li><a href=\"".$vars["websites_basehref"][$db->f("website")].txt("menu_inloggen").".php\">".htmlentities($vars["websites_basehref"][$db->f("website")].txt("menu_inloggen")).".php</li>";
				}
				echo "</ul>";
			}
		}
	}
}

?>