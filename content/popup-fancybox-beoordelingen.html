<?php

$db->query("SELECT AVG(be.vraag1_7) AS totaaloordeel FROM boeking_enquete be, view_accommodatie v WHERE be.type_id='".intval($_GET["typeid"])."' AND be.beoordeeld=1 AND v.type_id=be.type_id AND v.atonen=1 AND v.ttonen=1 AND v.archief=0 GROUP BY be.type_id;");

if($db->next_record()) {
	$totaaloordeel=$db->f("totaaloordeel");

	$accinfo=accinfo($_GET["typeid"]);


	$db->query("SELECT b.boeking_id, b.aankomstdatum_exact, be.websitetekst_gewijzigd, be.websitetekst_naam, be.vraag1_1, be.vraag1_2, be.vraag1_3, be.vraag1_4, be.vraag1_5, be.vraag1_6, be.vraag1_7 FROM boeking_enquete be, boeking b, type t WHERE b.type_id=t.type_id AND be.boeking_id=b.boeking_id AND t.type_id='".intval($_GET["typeid"])."' AND be.beoordeeld=1 ORDER BY b.aankomstdatum_exact DESC, b.boeking_id;");
	while($db->next_record()) {
		$beoordeling_aantalbeoordelingen=$db->num_rows();
		$enquete[$db->f("boeking_id")]["aankomstdatum_exact"]=$db->f("aankomstdatum_exact");
		$enquete[$db->f("boeking_id")]["websitetekst_gewijzigd"]=$db->f("websitetekst_gewijzigd");
		$enquete[$db->f("boeking_id")]["websitetekst_naam"]=$db->f("websitetekst_naam");
		for($i=1;$i<=7;$i++) {
			if($db->f("vraag1_".$i) and $db->f("vraag1_".$i)<=10) {
				$enquete[$db->f("boeking_id")][$i]=$db->f("vraag1_".$i);
			}
		}
	}

	echo "<style type=\"text/css\">\n"; ?>


	<?php

	echo "</style>";

	echo "<div id=\"beoordeling_wrapper\">";
	// echo "<h1>".html("titel","beoordelingen")."</h1>";

	echo "<div id=\"beoordeling_header\">";
	echo "<div id=\"beoordeling_header_left\">";
	echo "<img src=\"".imageurl(substr($accinfo["hoofdfoto"],8),170,127)."\" width=\"170\" height=\"127\">";
	echo "</div>"; // afsluiten #beoordeling_header_left

	echo "<div id=\"beoordeling_header_right\">";
	echo "<h1>".wt_he(ucfirst($accinfo["soortaccommodatie"])." ".$accinfo["accommodatie"])."</h1><h3 style=\"padding-bottom:5px;\">".wt_he($accinfo["type"])."</h3>";
	echo "<div>".wt_he($accinfo["plaats"]." - ".$accinfo["skigebied"])."</div>";

	echo "<div id=\"beoordeling_gemiddeldtotaaloordeel_regel\">";

	echo "<div id=\"beoordeling_gemiddeldtotaaloordeel\">";
	echo html("gemiddeldtotaaloordeel","beoordelingen").":</div>";
	echo "<div id=\"beoordeling_gemiddeldtotaaloordeel_cijfer\">".number_format($totaaloordeel,1,",",".")."</div>";
	echo "<div id=\"beoordeling_aantalbeoordelingen\">(".intval($beoordeling_aantalbeoordelingen)." ".($beoordeling_aantalbeoordelingen==1 ? html("beoordeling","beoordelingen") : html("beoordelingen","beoordelingen")).")</div>";

	echo "</div>"; // afsluiten #beoordeling_gemiddeldtotaaloordeel_regel
	echo "</div>"; // afsluiten #beoordeling_header_right

	echo "<div class=\"clear\"></div>";

	echo "</div>"; // afsluiten #beoordeling_header

	echo "<div class=\"clear\"></div>";

	if(is_array($enquete)) {
		while(list($key,$value)=each($enquete)) {

			echo "<div class=\"beoordeling_enquete\">";

			echo "<div class=\"beoordeling_enquete_bovenbalk\">";
			echo "<b>".html("totaaloordeel","beoordelingen").": ".$value[7]."</b>";
			echo " - ";
			echo html("aankomst","beoordelingen").": ".DATUM("MAAND JJJJ",$value["aankomstdatum_exact"],$vars["taal"]);

			echo " - ".html("ingevulddoor","beoordelingen").": ";
			if($value["websitetekst_naam"]) {
				echo wt_he($value["websitetekst_naam"]);
			} else {
				echo "<i>".html("anoniem","beoordelingen")."</i>";
			}
			echo "</div>"; // afsluiten .beoordeling_enquete_bovenbalk

			echo "<div class=\"beoordeling_enquete_cijfers\">";

			echo "<table cellspacing=\"0\" cellpadding=\"0\" class=\"beoordeling_enquete_table\">";
			for($i=1;$i<=6;$i++) {
				if($value[$i]>0) {
					$regelteller++;
					echo "<tr class=\"".($regelteller%2 ? "regel1" : "regel2")."\"><td>".html("vraag1_".$i,"enquete")."</td><td>&nbsp;</td><td align=\"right\">".intval($value[$i])."</td></tr>";
				}
			}
			echo "</table>";

			echo "</div>"; // afsluiten .beoordeling_enquete_cijfers

			if($value["websitetekst_gewijzigd"] and $vars["taal"]=="nl") {
				echo "<div class=\"beoordeling_enquete_toelichting\">";
				echo "<div class=\"beoordeling_enquete_toelichting_wrapper\">";
				echo "<i>".html("toelichting","beoordelingen").":</i><br>";
				echo nl2br(wt_he($value["websitetekst_gewijzigd"]));
				echo "</div>"; // afsluiten .beoordeling_enquete_toelichting_wrapper
				echo "</div>"; // afsluiten .beoordeling_enquete_toelichting
			}
			echo "<div class=\"clear\"></div>";
			echo "</div>"; // afsluiten .beoordeling_enquete
		}
	}
	echo "</div>"; // afsluiten #beoordeling_wrapper
	echo "<br>";
} else {
	echo "<p>not found</p>";
	trigger_error("geen beoordelingen gevonden",E_USER_NOTICE);
}

?>