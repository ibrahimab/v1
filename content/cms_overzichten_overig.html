<?php

if($_GET["t"]==1) {
	# Overzicht van aantal aangeboden bedden per seizoen tonen
	if($_GET["sid"]) {
		#   1. *Jaar*
		#   2. *Land*
		#   3. *Leverancier*
		#   4. *A**ccommodatie*
		#   5. *Types*
		#   6. *Slaapplaatsen*
		#   7. *Seizoen*
		$db->query("SELECT DISTINCT s.naam AS seizoen, l.naam AS land, lev.naam AS leverancier, a.naam, t.naam AS type, t.type_id, t.maxaantalpersonen, a.wzt, p.naam AS plaats, l.begincode FROM accommodatie a, type t, leverancier lev, plaats p, land l, seizoen s, tarief ta WHERE t.accommodatie_id=a.accommodatie_id AND t.leverancier_id=lev.leverancier_id AND a.plaats_id=p.plaats_id AND p.land_id=l.land_id AND ta.type_id=t.type_id AND ta.seizoen_id=s.seizoen_id AND s.seizoen_id='".addslashes($_GET["sid"])."' ORDER BY a.wzt, lev.naam, p.naam, a.naam, t.naam, t.maxaantalpersonen;");
		if($db->num_rows()) {
			$db->next_record();
			echo "<b>Overzicht aantal bedden - ".htmlentities($vars["seizoentype_namen"][$db->f("wzt")])." - ".htmlentities($db->f("seizoen"))."</b><p>";
			$db->seek();
			echo "<table cellspacing=\"0\" class=\"tbl\">";
			echo "<tr><th>Leverancier</th><th>Land</th><th>Plaats</th><th>Accommodatie</th><th>Type</th><th>Bedden</th></tr>";
			while($db->next_record()) {
				echo "<tr><td>".htmlentities($db->f("leverancier"))."</td><td>".htmlentities($db->f("land"))."</td><td>".htmlentities($db->f("plaats"))."</td><td>".htmlentities($db->f("naam"))."</td><td>".htmlentities($db->f("begincode").$db->f("type_id").($db->f("type") ? " - ".$db->f("type") : ""))."</td><td align=\"right\">".htmlentities($db->f("maxaantalpersonen"))."</td></tr>\n";
				$aantalbedden=$aantalbedden+$db->f("maxaantalpersonen");
			}
			echo "</table>";
			echo "<p><hr><p><b><i>Totalen</i></b>";
			echo "<table style=\"font-weight:bold;\">";
			echo "<tr><td>Aantal types</td><td>:</td><td>".$db->num_rows()."</td></tr>";
			echo "<tr><td>Aantal bedden</td><td>:</td><td>".$aantalbedden."</td></tr>";
			echo "</table>";
		}
	}

} elseif($_GET["t"]==2) {
	#
	# Overzicht ontbrekende handtekeningen
	#
#	echo "<h2>Ontbrekende handtekeningen</h2>";
	?>
	<style type="text/css">
		th, td {
			border-width: 1px 0px 0px 1px;
			padding: 4px;
		}
		th {
			background-color: #339999;
			color: #FFFFFF;
		}
		tr.alt td {
			background-color: #EEEEEE;
		}
		tbody {
			height: 600px;
			overflow-y: auto;
			overflow-x: hidden;
		}
	</style>
	<!--[if IE]>
	<style type="text/css">
		#tablediv {
			position: relative;
			height: 600px;
			overflow-y: scroll;
			overflow-x: hidden;
			border: solid #282e82;
			border-width: 0px 0px 1px 0px;
		}
		thead tr {
			position: absolute;
			top: expression(this.offsetParent.scrollTop);
		}
		tbody {
			height: auto;
		}
		table tbody tr:first-child td {
			padding: 29px 4px 4px 4px;
		}
	</style>
	<![endif]-->
	<?php

	# Eerste en laatste factuur bepalen
	$db->query("SELECT boeking_id, UNIX_TIMESTAMP(datum) AS datum FROM factuur ORDER BY datum;");
	while($db->next_record()) {
		if(!$eerstefactuur[$db->f("boeking_id")]) {
			$eerstefactuur[$db->f("boeking_id")]=$db->f("datum");
		}
		$laatstefactuur[$db->f("boeking_id")]=$db->f("datum");
	}

	# Betaalde bedragen (voldaan) bepalen
	$db->query("SELECT boeking_id, sum(bedrag) AS bedrag FROM boeking_betaling GROUP BY boeking_id;");
	while($db->next_record()) {
		$voldaan_array[$db->f("boeking_id")]=round($db->f("bedrag"),2);
	}

	$db->query("SELECT DISTINCT SUBSTR(b.boekingsnummer,2) AS bn_zonder_letter, b.boeking_id, b.boekingsnummer, UNIX_TIMESTAMP(b.bevestigdatum) AS bevestigdatum, b.aankomstdatum_exact, b.totale_reissom, b.aanbetaling1_dagennaboeken, b.aanbetaling1 , b.aanbetaling1_gewijzigd, UNIX_TIMESTAMP(b.aanbetaling2_datum) AS aanbetaling2_datum, b.aanbetaling2, b.totale_reissom_dagenvooraankomst, b.aanmaning_tekst, b.aanmaning_mailblokkeren, UNIX_TIMESTAMP(b.aanmaning_verstuurdatum) AS aanmaning_verstuurdatum, b.aanmaning_aantal, b.opmerkingen_intern, UNIX_TIMESTAMP(b.opmerkingen_intern_gewijzigd) AS opmerkingen_intern_gewijzigd, b.reisbureau_user_id, p.voornaam, p.tussenvoegsel, p.achternaam FROM boeking b, boeking_persoon p, factuur f WHERE f.boeking_id=b.boeking_id AND p.boeking_id=b.boeking_id AND p.persoonnummer=1 AND b.geannuleerd=0 AND b.boekingsnummer<>'' AND b.factuur_ondertekendatum IS NULL AND b.vraag_ondertekening=1 ORDER BY 1;");
	if($db->num_rows()) {
		echo "<div id=\"tablediv\">";
		echo "<table cellspacing=\"0\" class=\"tbl\">\n";
		echo "<thead>";
		echo "<tr><th>Res.nr.</th><th style=\"width:250px;\">Hoofdboeker</th><th title=\"Datum laatste wijziging opmerkingen\">Opm</th><th>Aankomst</th><th nowrap title=\"Eerste factuur\">Eerste factuur</th><th nowrap title=\"Laatste factuur\">Laatste factuur</th><th>Voldaan&nbsp;&nbsp;&nbsp;&nbsp;</th></tr>\n";
		echo "</thead>";
		echo "<tbody>";

		unset($reisbureau_inquery);
		while($db->next_record()) {
			if($db->f("reisbureau_user_id")) {
				if($reisbureau_inquery) $reisbureau_inquery.=",".$db->f("reisbureau_user_id"); else $reisbureau_inquery=$db->f("reisbureau_user_id");
			}
		}
		if($reisbureau_inquery) {
			$db2->query("SELECT ru.user_id, r.naam FROM reisbureau r, reisbureau_user ru WHERE ru.reisbureau_id=r.reisbureau_id AND ru.user_id IN (".$reisbureau_inquery.");");
			while($db2->next_record()) {
				$reisbureau_namen[$db2->f("user_id")]=$db2->f("naam");
			}
		}

		$db->seek();
		while($db->next_record()) {
			unset($regeltonen,$totaal,$voldaan,$openstaand,$telaat,$telaat_type,$tevoldoen);
			$totaal=round($db->f("totale_reissom"),2);

			$voldaan=$voldaan_array[$db->f("boeking_id")];

			$voldaan=round($voldaan,2);
			$openstaand=$totaal-$voldaan;
			$openstaand=round($openstaand,2);

			echo "<tr><td nowrap><a href=\"cms_boekingen.php?show=21&archief=0&21k0=".$db->f("boeking_id")."\" target=\"_blank\">".$db->f("boekingsnummer")."</a></td><td style=\"width:250px;\">".htmlentities(wt_naam($db->f("voornaam"),$db->f("tussenvoegsel"),$db->f("achternaam")));
			if($db->f("reisbureau_user_id")) {
				echo " (via ".$reisbureau_namen[$db->f("reisbureau_user_id")].")";
			}
			echo "</td>";
			if($db->f("opmerkingen_intern_gewijzigd")>0) {
				echo "<td nowrap title=\"".htmlentities(ereg_replace("\n"," ",$db->f("opmerkingen_intern")))."\">".strftime("%e %b",$db->f("opmerkingen_intern_gewijzigd"))."</td>";
			} else {
				echo "<td>&nbsp;</td>";
			}
			echo "<td nowrap>".date("d-m-y",$db->f("aankomstdatum_exact"))."</td>".($eerstefactuur[$db->f("boeking_id")]>0 ? "<td align=\"right\" title=\"Eerste factuur: ".DATUM("DAG D MAAND JJJJ",$eerstefactuur[$db->f("boeking_id")])."\">".date("d-m-y",$eerstefactuur[$db->f("boeking_id")]) : "<td>&nbsp;")."</td>".($laatstefactuur[$db->f("boeking_id")]>0 ? "<td align=\"right\" title=\"Laatste factuur: ".DATUM("DAG D MAAND JJJJ",$laatstefactuur[$db->f("boeking_id")])."\">".date("d-m-y",$laatstefactuur[$db->f("boeking_id")]) : "<td>&nbsp;")."</td><td align=\"left\">".($voldaan<>0 ? "&nbsp;".number_format($voldaan,2,",",".")."&nbsp;" : "&nbsp;")."</td>";
			echo "</tr>\n";
		}
		echo "</tbody>";
		echo "</table>";
		echo "</div>";
	}
} elseif($_GET["t"]==3) {
	#
	# Overzicht te vertalen teksten
	#
	if($_GET["cmstaal"]) {
		$vars["cmstaal"]=$_GET["cmstaal"];
	}


	if($vars["cmstaal"]) {

		if($vars["cmstaal"]=="en") {
			$vars["cmstaal_website"]="E";
		} elseif($vars["cmstaal"]=="de") {
			$vars["cmstaal_website"]="D";
		}

		if($_GET["initieel_vertalen"]) {
			# Overzicht nog niet vertaalde types en accommodaties



			# Welke velden moeten worden vertaald bij de accommodaties?
			$ignore_fields=array("pdfupload","vertrekinfo_seizoengoedgekeurd","pdfupload_user","pdfupload_datum");
			$db->query("SHOW COLUMNS FROM accommodatie;");
			while($db->next_record()) {
				if(preg_match("/^(.*)_".$vars["cmstaal"]."$/",$db->f("Field"),$regs) and !in_array($regs[1],$ignore_fields)) {
					$orquery.=" OR (a.".$regs[1]."<>'' AND a.".$regs[1]."_".$vars["cmstaal"]."='')";
				}
			}

			# Accommodaties
			$db->query("SELECT DISTINCT a.accommodatie_id, a.naam, a.wzt FROM accommodatie a, type t WHERE t.accommodatie_id=a.accommodatie_id AND a.websites LIKE '%".$vars["cmstaal_website"]."%' AND (".substr($orquery,3).") AND archief=0 AND a.tonen=1 AND t.tonen=1 ORDER BY a.naam;");
			if($db->num_rows()) {
				echo "Bij de volgende accommodaties zijn nog onvertaalde ".strtoupper($vars["cmstaal"])."-teksten:<ul>";
				while($db->next_record()) {
					echo "<li><a href=\"cms_accommodaties.php?edit=1&1k0=".$db->f("accommodatie_id")."&wzt=".$db->f("wzt")."&archief=0&cmstaal=".$vars["cmstaal"]."&hidecmsmenu=1\" class=\"vertalingbewerken\">".wt_he($vars["alleacc"][$db->f("accommodatie_id")])."</a></li>";
				}
				echo "</ul>";
			}


			# Welke velden moeten worden vertaald bij de types?
			unset($orquery);
			$ignore_fields=array("pdfupload","vertrekinfo_seizoengoedgekeurd","pdfupload_user","pdfupload_datum");
			$db->query("SHOW COLUMNS FROM type;");
			while($db->next_record()) {
				if(preg_match("/^(.*)_".$vars["cmstaal"]."$/",$db->f("Field"),$regs) and !in_array($regs[1],$ignore_fields)) {
					$orquery.=" OR (t.".$regs[1]."<>'' AND t.".$regs[1]."_".$vars["cmstaal"]."='')";
				}
			}

			# Types
			$db->query("SELECT DISTINCT t.type_id, a.accommodatie_id, a.wzt FROM accommodatie a, type t WHERE t.accommodatie_id=a.accommodatie_id AND a.websites LIKE '%".$vars["cmstaal_website"]."%' AND (".substr($orquery,3).") AND archief=0 AND a.tonen=1 AND t.tonen=1 ORDER BY t.naam;");
			if($db->num_rows()) {
				echo "<br>Bij de volgende types zijn nog onvertaalde ".strtoupper($vars["cmstaal"])."-teksten:<ul>";
				while($db->next_record()) {
					echo "<li><a href=\"cms_types.php?edit=2&2k0=".$db->f("type_id")."&1k0=".$db->f("accommodatie_id")."&wzt=".$db->f("wzt")."&archief=0&pv_accommodatie_id=".$db->f("accommodatie_id")."&cmstaal=".$vars["cmstaal"]."&hidecmsmenu=1\" class=\"vertalingbewerken\">".wt_he($vars["alletypes"][$db->f("type_id")])."</a></li>";
				}
				echo "</ul>";
			}

		} else {
			if($vars["cmstaal"]=="de") {
				echo "<p class=\"opvalblok\"><a href=\"".$_SERVER["REQUEST_URI"]."&initieel_vertalen=1\">Bekijk de niet eerder ".strtoupper($vars["cmstaal"])."-vertaalde accommodaties en types &raquo;</a></p>";
			}

			echo "Klik op <img src=\"".$vars["path"]."pic/icon_okay.png\" width=\"20\" height=\"20\" border=\"0\"> na het controleren/vertalen van alle velden van een record.<br><br>";
			$db->query("SELECT DISTINCT table_name, cms_id FROM cmslog WHERE vertaald_".$vars["cmstaal"]."=0 AND specialtype NOT IN (2,3) ORDER BY table_name;");
			while($db->next_record()) {
				$db2->query("SHOW COLUMNS FROM ".$db->f("table_name").";");
				while($db2->next_record()) {
					if(ereg("^(.*)_".$vars["cmstaal"]."$",$db2->f("Field"),$regs)) {
						$onvertaald[$db->f("table_name")]["inquery"].=",'".$regs[1]."'";
						$cms_name[$db->f("table_name")]=$cms->settings[$db->f("cms_id")]["types"];
					}
				}
			}

			#
			# Bepalen welke records uitsluitend gebruikt moeten worden (bijv. vanwege zomer-accommodaties, archief, tonen=0)
			#

			# aanbiedingen
			$db->query("SELECT aanbieding_id FROM aanbieding WHERE wzt=1;");
			while($db->next_record()) {
				$alleen_inquery["aanbieding"].=",".$db->f("aanbieding_id");
			}

			# accommodaties
			$db->query("SELECT a.accommodatie_id FROM accommodatie a, plaats p WHERE a.plaats_id=p.plaats_id AND a.wzt=1 AND a.archief=0 AND a.websites LIKE '%".$vars["cmstaal_website"]."%' AND a.tonen=1 ORDER BY p.naam, a.naam;");
			while($db->next_record()) {
				$alleen_inquery["accommodatie"].=",".$db->f("accommodatie_id");
			}

			# types
			$db->query("SELECT t.type_id FROM type t, accommodatie a, plaats p WHERE t.accommodatie_id=a.accommodatie_id AND a.plaats_id=p.plaats_id AND t.tonen=1 AND t.websites LIKE '%".$vars["cmstaal_website"]."%' AND a.accommodatie_id IN (".substr($alleen_inquery["accommodatie"],1).") ORDER BY p.naam, a.naam, t.naam, t.optimaalaantalpersonen;");
			while($db->next_record()) {
				$alleen_inquery["type"].=",".$db->f("type_id");
			}

			# skigebieden
			$db->query("SELECT skigebied_id, naam FROM skigebied WHERE wzt=1 ORDER BY naam;");
			while($db->next_record()) {
				$alleen_inquery["skigebied"].=",".$db->f("skigebied_id");
			}

			# plaatsen
			$db->query("SELECT plaats_id, naam FROM plaats WHERE wzt=1 ORDER BY naam;");
			while($db->next_record()) {
				$alleen_inquery["plaats"].=",".$db->f("plaats_id");
			}

			# thema's
			$db->query("SELECT thema_id FROM thema WHERE wzt=1;");
			while($db->next_record()) {
				$alleen_inquery["thema"].=",".$db->f("thema_id");
			}

			while(list($key,$value)=@each($onvertaald)) {
				if($value["inquery"]) {
					$db->query("SELECT cmslog_id, table_name, cms_id, cms_name, record_id, record_name, hide, field, field_name, previous, now, url FROM cmslog WHERE table_name='".addslashes($key)."' AND vertaald_".$vars["cmstaal"]."=0 AND field IN (".substr($value["inquery"],1).")".($alleen_inquery[$key] ? " AND record_id IN (".substr($alleen_inquery[$key],1).") ORDER BY FIELD(record_id,".substr($alleen_inquery[$key],1)."), hide" : " ORDER BY record_id, hide").";");
					if($db->num_rows()) {
						echo "\n<br><h2>".htmlentities(ucfirst($cms_name[$key]))."</h2>\n";

						unset($record_gehad,$table_geopend);
						while($db->next_record()) {

							if($key=="accommodatie") {
								$naam=$vars["alleacc"][$db->f("record_id")];
							} elseif($key=="type") {
								$naam=$vars["alletypes"][$db->f("record_id")];
							} else {
								$naam=$db->f("record_name");
							}
							if(!$naam) $naam="- leeg -";
							if(!$record_gehad[$db->f("record_id")] and !preg_match("/zomer/",$db->f("field"))) {
								$tevertalen_getoond=true;
								if($record_gehad) echo "</table></div></div></div>\n\n";
								unset($table_geopend);
								echo "\n\n<div id=\"row1_".$key.$db->f("record_id")."\" style=\"\"><hr>";
								echo "<div id=\"row2_".$key.$db->f("record_id")."\" style=\"padding:2px;\">";
								if($db->f("hide")==1) {
									echo "<div style=\"float:left;width:20px;padding-top:2px;\"></div>";
									echo "<div style=\"float:left;\">".htmlentities($naam)."</div>";
								} else {
									echo "<div style=\"float:left;width:20px;padding-top:2px;\"><img src=\"".$vars["path"]."pic/plusicon.gif\" width=\"11\" height=\"11\" border=\"0\"></div>";
									echo "<div style=\"float:left;\"><a href=\"#\" class=\"openklappen\" rel=\"row3_".$key.$db->f("record_id")."\">".htmlentities($naam)."</a></div>";
								}
								echo "<div style=\"float:right;width:30px;\"><img src=\"".$vars["path"]."pic/icon_okay.png\" width=\"20\" height=\"20\" border=\"0\" class=\"vertalingafvinken\" rel=\"".$key.$db->f("record_id").",".$db->f("cmslog_id")."\"></div>";
								$url=$db->f("url");
								$url=preg_replace("/&add=".$db->f("cms_id")."/","&edit=".$db->f("cms_id")."&".$db->f("cms_id")."k0=".$db->f("record_id"),$url);
								$url=preg_replace("/\?add=".$db->f("cms_id")."/","&edit=".$db->f("cms_id")."&".$db->f("cms_id")."k0=".$db->f("record_id"),$url);
								echo "<div style=\"float:right;width:30px;\"><a href=\"".($_SERVER["DOCUMENT_ROOT"]=="/home/webtastic/html" ? "/chalet" : "").htmlentities(ereg_replace("\&bc=[0-9]+","",$url))."&cmstaal=".$vars["cmstaal"]."&hidecmsmenu=1\" class=\"vertalingbewerken\" rel=\"row3_".$key.$db->f("record_id")."\"><img src=\"".$vars["path"]."pic/class.cms_edit.gif\" width=\"20\" height=\"20\" border=\"0\"></a></div>";
								echo "<div style=\"clear:both;\"></div>\n";
								echo "<div id=\"row3_".$key.$db->f("record_id")."\" style=\"display:none;padding-left:20px;\">\n";
								if($db->f("hide")==0) {
									echo "<table cellspacing=\"0\" class=\"tbl difftbl\" style=\"margin-top:5px;\"><tr><th style=\"width:140px;\">veld</th><th style=\"width:40%;\">van</th><th style=\"width:40%;\">naar</th></tr>";
									$table_geopend=true;
								}
								$record_gehad[$db->f("record_id")]=true;
							}
							if($table_geopend) {
								if($db->f("hide")==0) {
									if(!preg_match("/zomer/",$db->f("field"))) {
										echo "<tr><td valign=\"top\">".htmlentities($db->f("field_name"))."</td><td valign=\"top\">".nl2br(htmlentities($db->f("previous")))."</td><td valign=\"top\">".nl2br(wt_diff($db->f("previous"),$db->f("now")))."</td></tr>";
									}
								} else {
									echo "<tr><td valign=\"top\" colspan=\"3\"> + Controleer alle velden</td></tr>";
								}
							}
						}
						if($record_gehad) {

							if($table_geopend) {
								echo "</table>";
							}
							echo "</div></div></div>\n\n";
							echo "<hr>";
						}
					}
				}
			}
			if(!$tevertalen_getoond) {
				echo "<hr><b>Er zijn geen te vertalen teksten.</b>";
			}
		}
	} else {
		echo "Selecteer de gewenste taal (Engels of Duits) via de <a href=\"".$vars["path"]."cms.php\">cms-hoofdpagina</a>.";
	}
} elseif($_GET["t"]==5) {
	#
	# Overzicht vouchers
	#
	$form->display_all();
	echo "<br><br>";

	if($form->okay and $form->input["van"]["unixtime"]) {
		$vars["temp_begin"]=$form->input["van"]["unixtime"];
		$vars["temp_eind"]=$form->input["tot"]["unixtime"];
	}
	if($_GET["sort"]=="factuur") {
		$sort="1, b.aankomstdatum_exact";
	} else {
		$sort="b.aankomstdatum_exact, 1";
	}

	if($_GET["verzendmethode"]==1) {
		$verzendmethode_andquery=" AND verzendmethode_reisdocumenten=1";
	} elseif($_GET["verzendmethode"]==2) {
		$verzendmethode_andquery=" AND verzendmethode_reisdocumenten=2";
	} elseif($_GET["verzendmethode"]==3) {
		$verzendmethode_andquery=" AND verzendmethode_reisdocumenten=3";
	} elseif($_GET["verzendmethode"]==4) {
		$verzendmethode_andquery=" AND verzendmethode_reisdocumenten=0";
	}

	# aantallen bepalen
	$vouchers_verzonden=array(2,3,9,10,11,12,13); # voucherstatussen die als "weg" kunnen worden beschouwd
	$db->query("SELECT SUBSTRING(b.boekingsnummer,2) AS factuur, b.verzendmethode_reisdocumenten, b.boekingsnummer, b.mailblokkeren_opties, b.boeking_id, b.seizoen_id, b.aankomstdatum, b.aankomstdatum_exact, b.website, b.voucherstatus, b.taal, b.totale_reissom, b.goedgekeurde_betaling, b.verzendmethode_reisdocumenten, a.naam, a.accommodatie_id, a.vertrekinfo_seizoengoedgekeurd, a.vertrekinfo_seizoengoedgekeurd_en, a.wzt, t.type_id, t.naam AS tnaam, p.naam AS plaats, l.begincode, lev.naam AS leverancier FROM boeking b, accommodatie a, type t, plaats p, land l, skigebied s, leverancier lev WHERE b.leverancier_id=lev.leverancier_id AND b.type_id=t.type_id AND t.accommodatie_id=a.accommodatie_id AND a.plaats_id=p.plaats_id AND p.skigebied_id=s.skigebied_id AND p.land_id=l.land_id AND b.geannuleerd=0 AND b.stap_voltooid=5 AND b.goedgekeurd=1 AND b.aankomstdatum_exact>='".$vars["temp_begin"]."' AND b.aankomstdatum_exact<='".$vars["temp_eind"]."' AND b.goedgekeurd=1 AND b.geannuleerd=0".";");
	while($db->next_record()) {
		if(in_array($db->f("voucherstatus"),$vouchers_verzonden)) {
			$aantallen["alles"]["weg"]++;
			$aantallen[$db->f("verzendmethode_reisdocumenten")]["weg"]++;
		} else {
			$aantallen["alles"]["nog"]++;
			$aantallen[$db->f("verzendmethode_reisdocumenten")]["nog"]++;
		}
	}

	$db->query("SELECT SUBSTRING(b.boekingsnummer,2) AS factuur, b.boekingsnummer, b.mailblokkeren_opties, b.boeking_id, b.seizoen_id, b.aankomstdatum, b.aankomstdatum_exact, b.website, b.voucherstatus, b.taal, b.totale_reissom, b.goedgekeurde_betaling, b.verzendmethode_reisdocumenten, a.naam, a.accommodatie_id, a.vertrekinfo_seizoengoedgekeurd, a.vertrekinfo_seizoengoedgekeurd_en, a.wzt, t.type_id, t.naam AS tnaam, p.naam AS plaats, l.begincode, lev.naam AS leverancier FROM boeking b, accommodatie a, type t, plaats p, land l, skigebied s, leverancier lev WHERE b.leverancier_id=lev.leverancier_id AND b.type_id=t.type_id AND t.accommodatie_id=a.accommodatie_id AND a.plaats_id=p.plaats_id AND p.skigebied_id=s.skigebied_id AND p.land_id=l.land_id AND b.geannuleerd=0 AND b.stap_voltooid=5 AND b.goedgekeurd=1 AND b.aankomstdatum_exact>='".$vars["temp_begin"]."' AND b.aankomstdatum_exact<='".$vars["temp_eind"]."' AND b.goedgekeurd=1 AND b.geannuleerd=0 AND b.voucherstatus NOT IN (2,3,9,10,11,12)".$verzendmethode_andquery." ORDER BY ".$sort.";");
#	echo $db->lastquery;
	if($db->num_rows() and !$form->error) {

		echo "<span style=\"background-color:#fdff86;display:inline-block;width:50px;\">Geel</span> = nog geen vertrekinfo aan de accommodatie gekoppeld<br>";
		echo "<span style=\"background-color:#e587f6;display:inline-block;width:50px;\">Paars</span> = vertrekinfo is niet goedgekeurd voor het betreffende seizoen<br>";
		echo "<span style=\"background-color:#a6ffb3;display:inline-block;width:50px;\">Groen</span> = vertrekinfo is in orde<br>";

		echo "<br>";

		echo "Sorteervolgorde: ";
		if($_GET["sort"]=="factuur") {
			echo "<a href=\"".htmlentities(wt_stripurl(array("sort")))."\">datum/factuurnummer</a>";
			echo " - ";
			echo "<b>factuurnummer</b>";
		} else {
			echo "<b>datum/factuurnummer</b>";
			echo " - ";
			echo "<a href=\"".htmlentities($_SERVER["REQUEST_URI"])."&sort=factuur\">factuurnummer</a>";
		}
		echo "<br><br>";


		#
		# Verzendmethode selecteren
		#
		if(!$_GET["verzendmethode"]) $_GET["verzendmethode"]="0";
		echo "Verzendmethode: ";

		# alles
		if($_GET["verzendmethode"]<>"0") {
			echo "<a href=\"".htmlentities(wt_stripurl(array("verzendmethode")))."&verzendmethode=0\">";
		} else {
			echo "<b>";
		}
		echo "alles";
		if($_GET["verzendmethode"]<>"0") {
			echo "</a>";
		} else {
			echo "</b>";
		}
		echo " (weg ".intval($aantallen["alles"]["weg"]).", nog ".intval($aantallen["alles"]["nog"]).")";

		# e-mail
		echo "&nbsp;&nbsp;-&nbsp;&nbsp;";
		if($_GET["verzendmethode"]<>"1") {
			echo "<a href=\"".htmlentities(wt_stripurl(array("verzendmethode")))."&verzendmethode=1\">";
		} else {
			echo "<b>";
		}
		echo "e-mail";
		if($_GET["verzendmethode"]<>"1") {
			echo "</a>";
		} else {
			echo "</b>";
		}
		echo " (weg ".intval($aantallen[1]["weg"]).", nog ".intval($aantallen[1]["nog"]).")";

		# post
		echo "&nbsp;&nbsp;-&nbsp;&nbsp;";
		if($_GET["verzendmethode"]<>"2") {
			echo "<a href=\"".htmlentities(wt_stripurl(array("verzendmethode")))."&verzendmethode=2\">";
		} else {
			echo "<b>";
		}
		echo "post";
		if($_GET["verzendmethode"]<>"2") {
			echo "</a>";
		} else {
			echo "</b>";
		}
		echo " (weg ".intval($aantallen[2]["weg"]).", nog ".intval($aantallen[2]["nog"]).")";

		# n.v.t.
		echo "&nbsp;&nbsp;-&nbsp;&nbsp;";
		if($_GET["verzendmethode"]<>"3") {
			echo "<a href=\"".htmlentities(wt_stripurl(array("verzendmethode")))."&verzendmethode=3\">";
		} else {
			echo "<b>";
		}
		echo "n.v.t.";
		if($_GET["verzendmethode"]<>"3") {
			echo "</a>";
		} else {
			echo "</b>";
		}
		echo " (weg ".intval($aantallen[3]["weg"]).", nog ".intval($aantallen[3]["nog"]).")";

		# onbekend
		echo "&nbsp;&nbsp;-&nbsp;&nbsp;";
		if($_GET["verzendmethode"]<>"4") {
			echo "<a href=\"".htmlentities(wt_stripurl(array("verzendmethode")))."&verzendmethode=4\">";
		} else {
			echo "<b>";
		}
		echo "onbekend";
		if($_GET["verzendmethode"]<>"4") {
			echo "</a>";
		} else {
			echo "</b>";
		}
		echo " (weg ".intval($aantallen[0]["weg"]).", nog ".intval($aantallen[0]["nog"]).")";
		echo "<br><br>";

		echo "<table class=\"tbl\" cellspacing=\"0\">";
		echo "<form method=\"post\" action=\"".htmlentities($_SERVER["REQUEST_URI"])."\" name=\"frm2\">";
		echo "<tr><th>Aankomst</th><th>Boeking</th><th>Accommodatie</th><th nowrap>Voucherstatus</th><th>Openstaand</th><th title=\"Verzendmethode\">V</th></tr>";
		while($db->next_record()) {

			# Openstaand bedrag bepalen
			$nog_te_betalen=round($db->f("totale_reissom"),2);
			$db2->query("SELECT bedrag, UNIX_TIMESTAMP(datum) AS datum FROM boeking_betaling WHERE boeking_id='".addslashes($db->f("boeking_id"))."';");
			while($db2->next_record()) {
				$nog_te_betalen=round($nog_te_betalen-$db2->f("bedrag"),2);
			}

			$voucherteller++;
			echo "<tr>";
			echo "<td nowrap>".date("d-m-Y",$db->f("aankomstdatum_exact"))."</td>";
			echo "<td nowrap><a name=\"vnr".$voucherteller."\"></a><a href=\"cms_boekingen.php?show=21&21k0=".$db->f("boeking_id")."\" target=\"_blank\">".htmlentities($db->f("boekingsnummer"))."</a></td>";
			echo "<td style=\"";
			# achtergrondkleur bepalen
			$file="pdf/route_".$db->f("taal")."/".$db->f("accommodatie_id").".pdf";
			if(file_exists($file)) {

				if($db->f("taal")=="nl") {
					$vertrekinfo_seizoengoedgekeurd=$db->f("vertrekinfo_seizoengoedgekeurd");
				} else {
					$vertrekinfo_seizoengoedgekeurd=$db->f("vertrekinfo_seizoengoedgekeurd_".$db->f("taal"));
				}
				$vertrekinfo_seizoengoedgekeurd=split(",",$vertrekinfo_seizoengoedgekeurd);
				$seizoenokay=false;
				if(is_array($vertrekinfo_seizoengoedgekeurd) and in_array($db->f("seizoen_id"),$vertrekinfo_seizoengoedgekeurd)) {
					$seizoenokay=true;
				}
				if($seizoenokay) {
					echo "background-color:#a6ffb3;";
				} else {
					echo "background-color:#e587f6;";
				}
			} else {
				echo "background-color:#fdff86;";
			}
			echo "\">";
			echo "<a href=\"".$vars["path"]."cms_accommodaties.php?edit=1&wzt=".$db->f("wzt")."&1k0=".$db->f("accommodatie_id")."&burl=".htmlentities(urlencode($_SERVER["REQUEST_URI"]."#vnr".($voucherteller-1)))."#vertrekinfo\">".htmlentities($db->f("plaats")." - ".$db->f("begincode").$db->f("type_id")." ".$db->f("naam").($db->f("tnaam") ? " ".$db->f("tnaam") : ""))."</a> (".htmlentities($db->f("leverancier")).")</td>";
			echo "<td nowrap style=\"".($db->f("voucherstatus")==1||$db->f("voucherstatus")==4||$db->f("voucherstatus")==7||$db->f("voucherstatus")==8||$db->f("voucherstatus")==13 ? "background-color:#a6ffb3;" : "")."\"><a href=\"".$vars["path"]."cms_boekingen_vouchers.php?burl=".htmlentities(urlencode($_SERVER["REQUEST_URI"]."#vnr".($voucherteller-1)))."&bid=".$db->f("boeking_id")."\">".htmlentities($vars["voucherstatus"][$db->f("voucherstatus")])."</a></td>";
			if($nog_te_betalen>0) {
				echo "<td align=\"center\" style=\"background-color:".($nog_te_betalen-$db->f("goedgekeurde_betaling")>0 ? "#ffa9a9" : "#a6ffb3").";\"><a href=\"".$vars["path"]."cms_boekingen_betalingen.php?burl=".htmlentities(urlencode($_SERVER["REQUEST_URI"]."#vnr".($voucherteller-1)))."&bid=".$db->f("boeking_id")."\">".number_format($nog_te_betalen,2,",",".")."</a></td>";
			} else {
				echo "<td align=\"center\" style=\"background-color:#a6ffb3;\">&nbsp;</td>";
			}
			if($db->f("verzendmethode_reisdocumenten")==1) {
				echo "<td title=\"Verzenden per mail\">M</td>";
			} elseif($db->f("verzendmethode_reisdocumenten")==2) {
				echo "<td title=\"Verzenden per post\">P</td>";
			} elseif($db->f("verzendmethode_reisdocumenten")==3) {
				echo "<td title=\"Verzenden per post\">-</td>";
			} else {
				echo "<td title=\"Verzendmethode onbekend\">?</td>";
			}
			echo "</tr>\n";
		}
		echo "</form>";
		echo "</table>";
	} else {
		echo "<i>Er zijn geen openstaande vouchers binnen de gekozen periode.</i>";
	}

} elseif($_GET["t"]==6 or $_GET["t"]==7) {
	#
	# Na te kijken accommodaties
	#
	if($_GET["t"]==6) {
		$wzt=1;
	} else {
		$wzt=2;
	}

	# Actuele seizoenen bepalen
	unset($inquery,$regexp);
	$db->query("SELECT seizoen_id, naam, UNIX_TIMESTAMP(eind) AS eind, type FROM seizoen WHERE type='".addslashes($wzt)."' AND UNIX_TIMESTAMP(eind)>'".(time()-(86400*60))."' ORDER BY type, begin, eind;");
	while($db->next_record()) {
		$vars["seizoengoedgekeurd"][$db->f("seizoen_id")]=$db->f("naam");
		$vars["seizoengoedgekeurd_eind"][$db->f("seizoen_id")]=$db->f("eind");
		$inquery.=",".$db->f("seizoen_id");
		$regexp.=" OR (ta.seizoen_id='".addslashes($db->f("seizoen_id"))."' AND a.teksten_seizoengoedgekeurd NOT REGEXP '[[:<:]]".addslashes($db->f("seizoen_id"))."[[:>:]]')";
	}
	if($inquery) $inquery=substr($inquery,1); else $inquery="0";
	if($regexp) $regexp=substr($regexp,4); else $regexp="1=1";

	$db->query("SELECT DISTINCT a.accommodatie_id, a.naam, a.wzt, a.teksten_seizoengoedgekeurd, p.naam AS plaats FROM accommodatie a, type t, tarief ta, plaats p WHERE t.accommodatie_id=a.accommodatie_id AND ta.type_id=t.type_id AND a.plaats_id=p.plaats_id AND a.archief=0 AND a.tonen=1 AND t.tonen=1 AND ta.seizoen_id IN (".$inquery.") AND (".$regexp.") ORDER BY p.naam, a.naam;");
	if($db->num_rows()) {
		echo "<p>Bij de volgende accommodaties zijn tarieven bekend, maar moeten de teksten nog worden nagekeken:</p><table cellspacing=\"0\" class=\"tbl\" style=\"width:650px;\"><tr><th>Accommodatie</th><th nowrap>Goedgekeurd t/m</th></tr>";
		while($db->next_record()) {

			# Goedgekeurd t/m bepalen
			unset($seizoengoedgekeurd_eind,$seizoengoedgekeurd);
			$seizoengoedgekeurd_array=split(",",$db->f("teksten_seizoengoedgekeurd"));
			while(list($key,$value)=@each($seizoengoedgekeurd_array)) {
				if($vars["seizoengoedgekeurd_eind"][$value]>$seizoengoedgekeurd_eind) {
					$seizoengoedgekeurd_eind=$vars["seizoengoedgekeurd_eind"][$value];
					if($vars["seizoengoedgekeurd"][$value]) {
						$seizoengoedgekeurd=$vars["seizoengoedgekeurd"][$value];
					}
				}
			}
			if($seizoengoedgekeurd) $seizoengoedgekeurd=htmlentities($seizoengoedgekeurd); else $seizoengoedgekeurd="&nbsp;";
			echo "<tr><td><a href=\"".$vars["path"]."cms_accommodaties.php?edit=1&wzt=".$db->f("wzt")."&archief=0&1k0=".$db->f("accommodatie_id")."\" target=\"_blank\">".htmlentities($db->f("plaats")." - ".$db->f("naam"))."</a></td><td>".$seizoengoedgekeurd."</td></tr>\n";
		}
		echo "</table>";
	}
#	echo $db->lastquery;


} elseif($_GET["t"]==10) {
	#
	# Nieuwsbrief-leden
	#

	// echo "<br><hr><br><h2>Gewone nieuwsbrief</h2>";
	// $db->query("SELECT COUNT(nieuwsbrieflid_id) AS aantal FROM nieuwsbrieflid WHERE export IS NULL;");
	// if($db->next_record()) {
	// 	$aantal=intval($db->f("aantal"));
	// } else {
	// 	$aantal=0;
	// }
	// echo "Via onderstaande link kun je de nieuwe nieuwsbrief-leden downloaden die zich hebben ingeschreven via een boeking, optie-aanvraag, contactformulier of ingevulde enqu&ecirc;te.</p>";
	// echo "<div style=\"margin-top:15px;margin-bottom:15px;border:1px solid #000000;background-color:#fffca2;padding:5px;width:500px;\">Aantal nieuwe inschrijvingen sinds laatste export: ".$aantal."</div>";
	// if($aantal>0) {
	// 	echo "<p><a href=\"".$vars["path"]."cms_overzichten_overig.php?t=10&dl=1\" onclick=\"return confirmClick(this,'nieuwe leden gewone nieuwsbrief downloaden?');\">nieuwe leden downloaden als CSV &raquo;</a></p>";
	// }


	echo "<br><hr><br><h2>Reisagenten-nieuwsbrief</h2>";
	$db->query("SELECT COUNT(user_id) AS aantal FROM reisbureau_user WHERE nieuwsbriefexport IS NULL AND userlevel=1 AND email<>'' AND (mailingmanager_agentennieuwsbrief=1 OR mailingmanager_gewonenieuwsbrief=1);");
	if($db->next_record()) {
		$aantal=intval($db->f("aantal"));
	} else {
		$aantal=0;
	}
	echo "Via onderstaande link kun je de nieuwe nieuwsbrief-leden downloaden die zijn toegevoegd aan het reisagenten-systeem.</p>";
	echo "<div style=\"margin-top:15px;margin-bottom:15px;border:1px solid #000000;background-color:#fffca2;padding:5px;width:500px;\">Aantal nieuwe inschrijvingen sinds laatste export: ".$aantal."</div>";
	if($aantal>0) {
		echo "<p><a href=\"".$vars["path"]."cms_overzichten_overig.php?t=10&dl=2\" onclick=\"return confirmClick(this,'nieuwe leden reisagenten-nieuwsbrief downloaden?');\">nieuwe leden downloaden als CSV &raquo;</a></p>";
	}
	echo "<br><hr><br>";

	$form->display_all();

} elseif($_GET["t"]==11) {
	#
	# Overzicht met na te kijken enquêtes
	#

	if(!isset($_GET["enquetestatus"])) {
		if($login->user_id==4 or $login->user_id==6) {
			$_GET["enquetestatus"]=2;
		} else {
			$_GET["enquetestatus"]=0;
		}
	}

	echo "<div class=\"opvalblok\"><form method=\"get\" action=\"cms_overzichten_overig.php?t=11\">Status:&nbsp;&nbsp;&nbsp;<select name=\"enquetestatus\" onchange=\"this;submit();\">";
	while(list($key,$value)=each($vars["enquetestatus"])) {
		echo "<option value=\"".$key."\"".($key==$_GET["enquetestatus"] ? " selected" : "").">".wt_he($value)."</option>";
	}
	echo "</select>";
	while(list($key,$value)=each($_GET)) {
		if($key<>"enquetestatus") echo "<input type=\"hidden\" name=\"".wt_he($key)."\" value=\"".wt_he($value)."\">";
	}
	echo "</form></div>";

	unset($algehad);
	$db->query("SELECT b.boeking_id, b.boekingsnummer, b.aankomstdatum_exact, UNIX_TIMESTAMP(e.invulmoment) AS invulmoment, b.type_id, v.plaats, v.naam, v.wzt FROM boeking b, boeking_enquete e, view_accommodatie v WHERE v.type_id=b.type_id AND e.boeking_id=b.boeking_id AND e.beoordeeld='".addslashes($_GET["enquetestatus"])."' AND v.atonen=1 AND v.ttonen=1 AND v.archief=0 ORDER BY v.wzt, v.plaats, b.aankomstdatum_exact, e.invulmoment;");
	if($db->num_rows()) {
		echo "<ul>";
		while($db->next_record()) {
			if(!$algehad[$db->f("wzt")]) {
				echo "<br><b>".$vars["seizoentype_namen"][$db->f("wzt")]."</b><br>";
				$algehad[$db->f("wzt")]=true;
			}
			echo "<li><a href=\"".wt_he("cms_boekingen_enquete.php?bid=".$db->f("boeking_id")."&from=".urlencode($_SERVER["REQUEST_URI"])."&controleren=1")."\">".wt_he($db->f("boekingsnummer")." - ".date("d/m/Y",$db->f("aankomstdatum_exact"))." - ".$vars["alletypes"][$db->f("type_id")])."</a></li>";
		}
		echo "</ul>";
	} else {
		echo "<p>Geen beoordelingen met deze status gevonden.</p>";
	}

} else {

	#
	# Overige overzichten
	#

	# Overzicht aantal aangeboden bedden per seizoen
	echo "<h2>Aantal aangeboden bedden per seizoen</h2>";
	echo "<ul>";
	unset($seizoengehad);
	$db->query("SELECT seizoen_id, naam, type FROM seizoen ORDER BY type, begin;");
	while($db->next_record()) {
		if(!$seizoengehad[$db->f("type")]) {
			echo "<p><i>".$vars["seizoentype_namen"][$db->f("type")].":</i></p>";
			$seizoengehad[$db->f("type")]=true;
		}
		echo "<li><a href=\"cms_overzichten_overig.php?t=1&sid=".$db->f("seizoen_id")."\">".htmlentities($db->f("naam"))."</a></li>";
	}
	echo "</ul>";
	echo "</li>";


	# Overzicht zomeraccommodaties zonder winter-koppeling
	$db->query("SELECT a.accommodatie_id, a.naam, t.type_id, t.naam AS type, p.naam AS plaats, l.naam AS leverancier FROM accommodatie a, type t, plaats p, leverancier l WHERE t.leverancier_id=l.leverancier_id AND t.accommodatie_id=a.accommodatie_id AND a.plaats_id=p.plaats_id AND t.geenzomerwinterkoppeling=0 AND (zomerwinterkoppeling_accommodatie_id IS NULL OR zomerwinterkoppeling_accommodatie_id=0) AND a.wzt=2 AND a.tonen=1 AND t.tonen=1 AND a.archief=0 ORDER BY l.naam, p.naam, a.naam, t.naam;");
	if($db->num_rows()) {
		echo "<hr>";
		echo "<h2>Zomeraccommodaties zonder winter-koppeling (aantal: ".$db->num_rows().")</h2>";
		echo "<form method=\"post\" action=\"".htmlentities($_SERVER["REQUEST_URI"])."\" name=\"frm3\">";
		echo "<input type=\"hidden\" name=\"winterkoppeling\" value=\"1\">";
		echo "<table cellspacing=\"0\" class=\"tbl\" style=\"width:800px;\">";
		echo "<tr><th>Type</th><th>Geen winterkoppeling</th></tr>";
		while($db->next_record()) {
			echo "<tr><td><a href=\"cms_types.php?show=2&1k0=".$db->f("accommodatie_id")."&2k0=".$db->f("type_id")."\" target=\"_blank\">".htmlentities($db->f("leverancier")." - ".$db->f("plaats")." - ".$db->f("naam").($db->f("type") ? " ".$db->f("type") : ""))."</a></td><td align=\"center\"><input type=\"checkbox\" name=\"geenkoppeling[".$db->f("type_id")."]\"></td></tr>";
		}
		echo "<tr><td colspan=\"2\" align=\"center\"><input type=\"submit\" value=\" OPSLAAN \" id=\"submit1frm3\" onclick=\"document.frm3.submit1frm3.disabled=1;document.frm3.submit();\"></td></tr>";
		echo "</table>";
		echo "</form>";
	}

#	echo "</ul>";

}

?>