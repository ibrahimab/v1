<?php

#
# Zoekformulier
#

if($pre_query_content) {
	echo $pre_query_content;
}


// temporarily: which table to use for caching?
if( $vars["lokale_testserver"] or $_GET["test"]==1 ) {
	$table_name_cache_vanafprijs = "cache_vanafprijs_incl_bkk_type";
} else {
	$table_name_cache_vanafprijs = "cache_vanafprijs_type";
}


# tekstzoeken: zoekopdracht "opschonen" (voor zoekopdrachten die binnenkomen via andere pagina dan zoek-en-boek.php - want in zoek-en-boek.php wordt dit opschonen ook al gedaan)
if($_GET["fzt"]==txt("tekstzoeken","zoek-en-boek")) {
	# als tekstzoekopdracht bestaat uit de placeholder-tekst: tekstzoekopdracht wissen
	unset($_GET["fzt"]);
}
if($_GET["fzt"]=="-- ".html("trefwoord","index")." --") {
	# als tekstzoekopdracht bestaat uit de placeholder-tekst: tekstzoekopdracht wissen
	$_GET["fzt"]="";
}
if($_GET["fzt"]==html("zoekoptekst","index")) {
	# als tekstzoekopdracht bestaat uit de placeholder-tekst: tekstzoekopdracht wissen
	$_GET["fzt"]="";
}


// zoekresultaat_prijs_info_bijkomendekosten_popup (hide by default)
$opmaak->html_at_the_bottom("<div class=\"zoekresultaat_prijs_info_bijkomendekosten_popup zoekresultaat_prijs_info_bijkomendekosten_empty\"><img src=\"".$vars["path"]."pic/close_icon.png\" class=\"close\" /><div></div></div>");


# Tekstzoeken: termen omzetten naar verfijningen
include_once($unixdir."content/vars/autocomplete.php");
if ( is_array( $autocomplete ) ) {
	while ( list( $key, $value )=each( $autocomplete ) ) {
		if($_GET["fzt"]==$key) {
			$_GET["fzt"]=str_replace($key,"",$_GET["fzt"]);
			while(list($key2,$value2)=each($value)) {
				$split=explode("=",$value2);
				$_GET[$split[0]]=$split[1];
			}
		}
	}
}

if(strlen($_GET["fzt"])>0) {
	$_GET["fzt"]=trim($_GET["fzt"]);
}


# voor CMS-gebruikers: zowel Chalet.nl als SuperSki doorzoeken (uitgezet: SuperSki bestaat niet meer - 24-9-2013)
// if($voorkant_cms and ($vars["website"]=="C" or $vars["website"]=="W") and ($_GET["allesites"] or !$_GET["filled"])) {
// 	$vars["where_websites_query"]="(websites LIKE '%C%' OR websites LIKE '%W%')";
// 	$vars["where_websites_query_t"]="(t.websites LIKE '%C%' OR t.websites LIKE '%W%')";
// 	$_GET["allesites"]=1;
// } else {
	$vars["where_websites_query"]="websites LIKE '%".$vars["website"]."%'";
	$vars["where_websites_query_t"]="t.websites LIKE '%".$vars["website"]."%'";
// }

# Kijken of flexibel zoeken is toegestaan
#if(($vars["website"]=="Z" and $landgebied[0]=="5") or $vars["websitetype"]==7) {
if($vars["websitetype"]==7) {
	$vars["flexibel_toegestaan"]=true;
	$_GET["sp"]=1;

	if($_GET["fad"] and !$_GET["fadf_d"]) {
		$_GET["fadf_d"]=date("d",$_GET["fad"]);
		$_GET["fadf_m"]=date("m",$_GET["fad"]);
		$_GET["fadf_y"]=date("Y",$_GET["fad"]);
	}
}

# Bepalen of dit een nieuwe zoekopdracht is, of dat de zoekopdracht in deze sessie al eens eerder is uitgevoerd
$te_controleren_velden=array("fsg","fad","fadf_d","fadf_m","fadf_y","fap","fas","fzt","fdu","faab","fpk_van","fpk_tot","fpk_enmeer");
$nieuwe_zoekopdracht=1;
if(is_array($_GET)) {
	reset($_GET);
	while(list($key,$value)=each($_GET)) {
		if(in_array($key,$te_controleren_velden) or substr($key,0,3)=="vf_") {
			if(strlen($value)>0) {
				$check_get.="&".$key."=".urlencode($value);
			}
		}
	}
	if($check_get) {
		if($_SESSION["zoekopdrachten"][$check_get]) {
			$nieuwe_zoekopdracht=0;
		}
		$_SESSION["zoekopdrachten"][$check_get]=true;
	}
}

#
# Verfijnd zoeken: gebleven bij $keuzeopsomming-teller [58] (eerst beschikbare: 59)
#
if($vars["seizoentype"]==1) {
	#
	# Verfijnd zoeken definiëren: winter
	#


	# Afstand tot de piste
	$keuzeopsomming[1]["combinatiesmogelijk"]=0;
	$keuzeopsomming[1]["name"]="afstandtotpiste";
	$keuzeopsomming[1]["verfijndname"]="afstandtotpiste";
	$keuzeopsomming[1]["getname"]="vf_piste";
	$keuzeopsomming[1]["fields"]=array(
		"piste_aandepiste"=>1,
		"piste_max250m"=>2,
		"piste_max500m"=>3,
		"piste_max1000m"=>4
	);
	$keuzeopsomming[1]["addwhere"][1][]="a.afstandpiste IS NOT NULL AND a.afstandpiste<=50";
	$keuzeopsomming[1]["addwhere"][2][]="a.afstandpiste IS NOT NULL AND a.afstandpiste<=250";
	$keuzeopsomming[1]["addwhere"][3][]="a.afstandpiste IS NOT NULL AND a.afstandpiste<=500";
	$keuzeopsomming[1]["addwhere"][4][]="a.afstandpiste IS NOT NULL AND a.afstandpiste<=1000";

	# Aantal km piste
	$keuzeopsomming[2]["combinatiesmogelijk"]=0;
	$keuzeopsomming[2]["name"]="aantalkmpiste";
	$keuzeopsomming[2]["verfijndname"]="aantalkmpiste";
	$keuzeopsomming[2]["getname"]="vf_km";
	$keuzeopsomming[2]["fields"]=array(
		"kmpiste_tot100km"=>1,
		"kmpiste_100km"=>2,
		"kmpiste_200km"=>3,
		"kmpiste_400km"=>4
	);
	$keuzeopsomming[2]["addwhere"][1][]="s.kilometerpiste<100";
	$keuzeopsomming[2]["addwhere"][2][]="s.kilometerpiste>=100";
	$keuzeopsomming[2]["addwhere"][3][]="s.kilometerpiste>=200";
	$keuzeopsomming[2]["addwhere"][4][]="s.kilometerpiste>=400";

	if($vars["websitetype"]==8) {
		# Soort accommodatie (alleen bij SuperSki)
		$keuzeopsomming[6]["combinatiesmogelijk"]=1;
		$keuzeopsomming[6]["name"]="soortaccommodatie";
		$keuzeopsomming[6]["verfijndname"]="soortaccommodatie";
		$keuzeopsomming[6]["getname"]="vf_kenm";
		$keuzeopsomming[6]["fields"]=array(
			"chalet"=>39,
			"chaletappartement"=>40,
			"appartement"=>41,
			"hotel"=>42
		);
		$keuzeopsomming[6]["addwhere"][39][]="a.soortaccommodatie=1";
		$keuzeopsomming[6]["addwhere"][40][]="a.soortaccommodatie=4";
		$keuzeopsomming[6]["addwhere"][41][]="a.soortaccommodatie=2";
		$keuzeopsomming[6]["addwhere"][42][]="a.soortaccommodatie=3";
	}

	# Faciliteiten
	$keuzeopsomming[3]["combinatiesmogelijk"]=1;
	$keuzeopsomming[3]["name"]="faciliteiten";
	$keuzeopsomming[3]["verfijndname"]="kenmerken";
	$keuzeopsomming[3]["getname"]="vf_kenm";
	$keuzeopsomming[3]["fields"]=array(
		"catering"=>2,
		"internetwifi"=>50,
		"zwembad"=>3,
		"sauna"=>4,
		"privesauna"=>5,
		"huisdierentoegestaan"=>6,
		"openhaardhoutkachel"=>7,
		"goedvoorkids"=>43,
	);
	$keuzeopsomming[3]["addwhere"][1][]="(t.kenmerken REGEXP '[[:<:]]6[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]6[[:>:]]')";
	$keuzeopsomming[3]["addwhere"][2][]="(t.kenmerken REGEXP '[[:<:]]1[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]1[[:>:]]')";
	$keuzeopsomming[3]["addwhere"][3][]="(t.kenmerken REGEXP '[[:<:]]4[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]4[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]11[[:>:]]')";
	$keuzeopsomming[3]["addwhere"][4][]="(t.kenmerken REGEXP '[[:<:]]3[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]3[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]10[[:>:]]')";
	$keuzeopsomming[3]["addwhere"][5][]="(t.kenmerken REGEXP '[[:<:]]3[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]3[[:>:]]')";
	$keuzeopsomming[3]["addwhere"][6][]="(t.kenmerken REGEXP '[[:<:]]11[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]13[[:>:]]')";
	$keuzeopsomming[3]["addwhere"][7][]="(t.kenmerken REGEXP '[[:<:]]10[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]12[[:>:]]')";
	$keuzeopsomming[3]["addwhere"][43][]="(t.kenmerken REGEXP '[[:<:]]5[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]5[[:>:]]')";
	$keuzeopsomming[3]["addwhere"][50][]="(t.kenmerken REGEXP '[[:<:]]20[[:>:]]' OR t.kenmerken REGEXP '[[:<:]]22[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]21[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]23[[:>:]]')";


	# Aantal badkamers
	$keuzeopsomming[4]["combinatiesmogelijk"]=0;
	$keuzeopsomming[4]["name"]="aantalbadkamers";
	$keuzeopsomming[4]["verfijndname"]="aantalbadkamers";
	$keuzeopsomming[4]["getname"]="vf_badk";
	$keuzeopsomming[4]["fields"]=array(
		"minimaal2"=>1,
		"minimaal3"=>2,
		"minimaal4"=>3,
		"minimaal5"=>4,
		"minimaal6"=>5,
		"minimaal8"=>6,
		"minimaal10"=>7
	);
	$keuzeopsomming[4]["addwhere"][1][]="t.badkamers>=2";
	$keuzeopsomming[4]["addwhere"][2][]="t.badkamers>=3";
	$keuzeopsomming[4]["addwhere"][3][]="t.badkamers>=4";
	$keuzeopsomming[4]["addwhere"][4][]="t.badkamers>=5";
	$keuzeopsomming[4]["addwhere"][5][]="t.badkamers>=6";
	$keuzeopsomming[4]["addwhere"][6][]="t.badkamers>=8";
	$keuzeopsomming[4]["addwhere"][7][]="t.badkamers>=10";

	# Thema's (winter)
	$keuzeopsomming[5]["combinatiesmogelijk"]=1;
	$keuzeopsomming[5]["name"]="themas";
	$keuzeopsomming[5]["verfijndname"]="kenmerken";
	$keuzeopsomming[5]["getname"]="vf_kenm";
	$keuzeopsomming[5]["fields"]=array(
		"charmanteskidorpen"=>44,
		"10voorapresski"=>45,
		"superskistations"=>47,
		"winterwellness"=>46
	);
	$keuzeopsomming[5]["addwhere"][44][]="(p.kenmerken REGEXP '[[:<:]]13[[:>:]]')";
	$keuzeopsomming[5]["addwhere"][45][]="(p.kenmerken REGEXP '[[:<:]]6[[:>:]]')";
	$keuzeopsomming[5]["addwhere"][46][]="(t.kenmerken REGEXP '[[:<:]]9[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]9[[:>:]]')";
	$keuzeopsomming[5]["addwhere"][47][]="(p.kenmerken REGEXP '[[:<:]]14[[:>:]]')";

} else {
	#
	# Verfijnd zoeken definiëren: zomer
	#

	if($vars["websitetype"]==7) {
		#
		# Verfijnd zoeken Italissima
		#

		# Soort vakantiehuis
		$keuzeopsomming[3]["combinatiesmogelijk"]=1;
		$keuzeopsomming[3]["name"]="soortaccommodatie";
		$keuzeopsomming[3]["verfijndname"]="kenmerken";
		$keuzeopsomming[3]["getname"]="vf_kenm";

		$keuzeopsomming[3]["fields"]=array(
			"agriturismo"=>56,
			"appartement"=>51,
			"domein"=>57,
			"kasteel"=>54,
			"vakantiehuis"=>52,
			"vakantiepark"=>55,
			"villa"=>53,
			"vrijstaand"=>58,
		);

		$keuzeopsomming[3]["addwhere"][51][]="a.soortaccommodatie=2";
		$keuzeopsomming[3]["addwhere"][52][]="a.soortaccommodatie=6";
		$keuzeopsomming[3]["addwhere"][53][]="a.soortaccommodatie=7";
		$keuzeopsomming[3]["addwhere"][54][]="a.soortaccommodatie=8";
		$keuzeopsomming[3]["addwhere"][55][]="a.soortaccommodatie=9";
		$keuzeopsomming[3]["addwhere"][56][]="(a.soortaccommodatie=10 OR a.kenmerken REGEXP '[[:<:]]41[[:>:]]')";
		$keuzeopsomming[3]["addwhere"][57][]="a.soortaccommodatie=11";
		$keuzeopsomming[3]["addwhere"][58][]="(t.kenmerken REGEXP '[[:<:]]2[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]22[[:>:]]' OR t.kenmerken REGEXP '[[:<:]]15[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]27[[:>:]]')";

		# Faciliteiten ter plaatse
		$keuzeopsomming[2]["combinatiesmogelijk"]=1;
		$keuzeopsomming[2]["name"]="faciliteitenterplaatse";
		$keuzeopsomming[2]["verfijndname"]="kenmerken";
		$keuzeopsomming[2]["getname"]="vf_kenm";
		$keuzeopsomming[2]["fields"]=array(
			"zwembad"=>8,
			"privezwembad"=>18,
			"tuinterras"=>49,
			"priveterras"=>15,
			"balkon"=>16,
			"restaurant"=>37,
			"speeltoestellen"=>10,
			"tennisbaan"=>9,
			"wasmachine"=>11,
			"internetwifi"=>50,
		);
		$keuzeopsomming[2]["addwhere"][8][]="(a.kenmerken REGEXP '[[:<:]]11[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][9][]="(a.kenmerken REGEXP '[[:<:]]19[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][10][]="(a.kenmerken REGEXP '[[:<:]]26[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][11][]="(t.kenmerken REGEXP '[[:<:]]18[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]32[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][15][]="(t.kenmerken REGEXP '[[:<:]]17[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]30[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][16][]="(t.kenmerken REGEXP '[[:<:]]19[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]33[[:>:]]' OR t.kenmerken REGEXP '[[:<:]]20[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]34[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][18][]="(t.kenmerken REGEXP '[[:<:]]4[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]4[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][37][]="(a.kenmerken REGEXP '[[:<:]]40[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][49][]="(t.kenmerken REGEXP '[[:<:]]20[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]34[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][50][]="(t.kenmerken REGEXP '[[:<:]]22[[:>:]]' OR t.kenmerken REGEXP '[[:<:]]24[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]36[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]42[[:>:]]')";

#		if(check_kenmerken($db->f("tkenmerken"),22) or check_kenmerken($db->f("tkenmerken"),24) or check_kenmerken($db->f("akenmerken"),36) or check_kenmerken($db->f("akenmerken"),42)) {


#		$keuzeopsomming[2]["addwhere"][24][]="(t.kenmerken REGEXP '[[:<:]]9[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]9[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]4[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]3[[:>:]]')";

	// 	# Faciliteiten accommodatie
	// 	$keuzeopsomming[4]["combinatiesmogelijk"]=1;
	// 	$keuzeopsomming[4]["name"]="faciliteitenaccommodatie";
	// 	$keuzeopsomming[4]["verfijndname"]="kenmerken";
	// 	$keuzeopsomming[4]["getname"]="vf_kenm";
	// 	$keuzeopsomming[4]["fields"]=array(
	// 		"priveterras"=>15,
	// 		"privezwembad"=>18,
	// 		"balkon"=>16,
	// 	);
	// #	$keuzeopsomming[4]["fields"]=array(
	// #		"priveterras"=>15,
	// #		"balkon"=>16,
	// #		"balkonofterras"=>17,
	// #		"privezwembad"=>18
	// #	);
	// 	$keuzeopsomming[4]["addwhere"][15][]="(t.kenmerken REGEXP '[[:<:]]17[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]30[[:>:]]')";
	// 	$keuzeopsomming[4]["addwhere"][16][]="(t.kenmerken REGEXP '[[:<:]]19[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]33[[:>:]]')";
	// 	$keuzeopsomming[4]["addwhere"][17][]="(t.kenmerken REGEXP '[[:<:]]20[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]34[[:>:]]')";
	// 	$keuzeopsomming[4]["addwhere"][18][]="(t.kenmerken REGEXP '[[:<:]]4[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]4[[:>:]]')";

		# Huisdieren
		$keuzeopsomming[5]["combinatiesmogelijk"]=1;
		$keuzeopsomming[5]["name"]="huisdieren";
		$keuzeopsomming[5]["verfijndname"]="kenmerken";
		$keuzeopsomming[5]["getname"]="vf_kenm";
		$keuzeopsomming[5]["fields"]=array(
			"huisdierentoegestaan"=>19,
			"huisdierenniettoegestaan"=>20,
		);
		$keuzeopsomming[5]["addwhere"][19][]="(t.kenmerken REGEXP '[[:<:]]11[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]13[[:>:]]')";
		$keuzeopsomming[5]["addwhere"][20][]="(t.kenmerken_nee REGEXP '[[:<:]]11[[:>:]]' OR a.kenmerken_nee REGEXP '[[:<:]]13[[:>:]]')";

		# Kenmerken
		$keuzeopsomming[6]["combinatiesmogelijk"]=1;
		$keuzeopsomming[6]["name"]="themas";
		$keuzeopsomming[6]["verfijndname"]="kenmerken";
		$keuzeopsomming[6]["getname"]="vf_kenm";
		$keuzeopsomming[6]["fields"]=array(
			"goedvoorkids"=>21,
			"grotegroepen"=>28,
			"huisjevoor2"=>27,
			"wijndomein"=>35,
			"bijzonder"=>22,
			"topselectie"=>25,
		);

		// "huisjemetzwembad"=>32,
		// "greenfeeproof"=>29,
		// "actiefindebergen"=>30,
		// "stekjebijhetwater"=>31,
		// "boerderij"=>34,

		$keuzeopsomming[6]["addwhere"][21][]="(t.kenmerken REGEXP '[[:<:]]5[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]5[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][22][]="(t.kenmerken REGEXP '[[:<:]]16[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]28[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][23][]="(a.kenmerken REGEXP '[[:<:]]17[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]8[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]5[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][24][]="(t.kenmerken REGEXP '[[:<:]]9[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]9[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]4[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]3[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][25][]="(t.kenmerken REGEXP '[[:<:]]8[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]8[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][26][]="(t.kenmerken REGEXP '[[:<:]]7[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]7[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]2[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]2[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][27][]="(t.kenmerken REGEXP '[[:<:]]1[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]18[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][28][]="(t.kenmerken REGEXP '[[:<:]]6[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]6[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][29][]="(a.kenmerken REGEXP '[[:<:]]2[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]6[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][30][]="(a.kenmerken REGEXP '[[:<:]]1[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]5[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]4[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][31][]="(a.kenmerken REGEXP '[[:<:]]16[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][32][]="(t.kenmerken REGEXP '[[:<:]]4[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]4[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]11[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][33][]="(a.kenmerken REGEXP '[[:<:]]24[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][34][]="(a.kenmerken REGEXP '[[:<:]]25[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][35][]="(a.kenmerken REGEXP '[[:<:]]37[[:>:]]')";

		# Ligging
		$keuzeopsomming[1]["combinatiesmogelijk"]=1;
		$keuzeopsomming[1]["name"]="ligging";
		$keuzeopsomming[1]["verfijndname"]="kenmerken";
		$keuzeopsomming[1]["getname"]="vf_kenm";
		$keuzeopsomming[1]["fields"]=array(
			"zwemwater"=>1,
			"golfbaan"=>2,
			"centrumloopafstand"=>36,
		);

		// "tennisbaan10km"=>3,
		// "paardrijden"=>4,
		// "indebergen"=>5,
		// "wijnstreek"=>6,

		$keuzeopsomming[1]["addwhere"][1][]="(a.kenmerken REGEXP '[[:<:]]16[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]7[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][2][]="(a.kenmerken REGEXP '[[:<:]]2[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]6[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][3][]="(a.kenmerken REGEXP '[[:<:]]29[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]19[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][4][]="(a.kenmerken REGEXP '[[:<:]]31[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][5][]="(a.kenmerken REGEXP '[[:<:]]1[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]5[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]4[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][6][]="(a.kenmerken REGEXP '[[:<:]]20[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]9[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]6[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][7][]="(a.kenmerken REGEXP '[[:<:]]24[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][36][]="(a.kenmerken REGEXP '[[:<:]]39[[:>:]]')";


		# Afstand vanaf Utrecht
		$keuzeopsomming[7]["combinatiesmogelijk"]=0;
		$keuzeopsomming[7]["name"]="afstandvanafutrecht";
		$keuzeopsomming[7]["verfijndname"]="afstandvanafutrecht";
		$keuzeopsomming[7]["getname"]="vf_afst";
		$keuzeopsomming[7]["fields"]=array(
			"tot1250"=>1,
			"12501500"=>2,
			"meerdan1500"=>3,
		);
		$keuzeopsomming[7]["addwhere"][1][]="p.afstandtotutrecht>0";
		$keuzeopsomming[7]["addwhere"][1][]="p.afstandtotutrecht<=1250";
		$keuzeopsomming[7]["addwhere"][2][]="p.afstandtotutrecht>1250";
		$keuzeopsomming[7]["addwhere"][2][]="p.afstandtotutrecht<=1500";
		$keuzeopsomming[7]["addwhere"][3][]="p.afstandtotutrecht>1500";

	} else {

		#
		# Verfijnd zoeken Zomerhuisje
		#

		# Ligging
		$keuzeopsomming[1]["combinatiesmogelijk"]=1;
		$keuzeopsomming[1]["name"]="ligging";
		$keuzeopsomming[1]["verfijndname"]="kenmerken";
		$keuzeopsomming[1]["getname"]="vf_kenm";
		$keuzeopsomming[1]["fields"]=array(
			"zwemwater"=>1,
			"golfbaan"=>2,
			"tennisbaan10km"=>3,
			"paardrijden"=>4,
			"centrumloopafstand"=>36,
			"opeenvakantiepark"=>7,
		);

		$keuzeopsomming[1]["addwhere"][1][]="(a.kenmerken REGEXP '[[:<:]]16[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]7[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][2][]="(a.kenmerken REGEXP '[[:<:]]2[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]6[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][3][]="(a.kenmerken REGEXP '[[:<:]]29[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]19[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][4][]="(a.kenmerken REGEXP '[[:<:]]31[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][5][]="(a.kenmerken REGEXP '[[:<:]]1[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]5[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]4[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][6][]="(a.kenmerken REGEXP '[[:<:]]20[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]9[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]6[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][7][]="(a.kenmerken REGEXP '[[:<:]]24[[:>:]]')";
		$keuzeopsomming[1]["addwhere"][36][]="(a.kenmerken REGEXP '[[:<:]]39[[:>:]]')";


		# Faciliteiten ter plaatse
		$keuzeopsomming[2]["combinatiesmogelijk"]=1;
		$keuzeopsomming[2]["name"]="faciliteitenterplaatse";
		$keuzeopsomming[2]["verfijndname"]="kenmerken";
		$keuzeopsomming[2]["getname"]="vf_kenm";
		$keuzeopsomming[2]["fields"]=array(
			"zwembad"=>8,
			"tennisbaan"=>9,
			"speeltoestellen"=>10,
			"wasmachine"=>11,
			"restaurant"=>37
		);
		$keuzeopsomming[2]["addwhere"][8][]="(a.kenmerken REGEXP '[[:<:]]11[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][9][]="(a.kenmerken REGEXP '[[:<:]]19[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][10][]="(a.kenmerken REGEXP '[[:<:]]26[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][11][]="(t.kenmerken REGEXP '[[:<:]]18[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]32[[:>:]]')";
		$keuzeopsomming[2]["addwhere"][37][]="(a.kenmerken REGEXP '[[:<:]]40[[:>:]]')";

		# Soort accommodatie
		$keuzeopsomming[3]["combinatiesmogelijk"]=1;
		$keuzeopsomming[3]["name"]="soortaccommodatie";
		$keuzeopsomming[3]["verfijndname"]="kenmerken";
		$keuzeopsomming[3]["getname"]="vf_kenm";
		$keuzeopsomming[3]["fields"]=array(
			"vrijstaandhuis"=>12,
			"vrijstaandhuismetmeerdere"=>13,
			"geschakeldewoning"=>14
		);

		$keuzeopsomming[3]["addwhere"][12][]="(t.kenmerken REGEXP '[[:<:]]2[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]22[[:>:]]')";
		$keuzeopsomming[3]["addwhere"][13][]="(t.kenmerken REGEXP '[[:<:]]15[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]27[[:>:]]')";
		$keuzeopsomming[3]["addwhere"][14][]="(t.kenmerken REGEXP '[[:<:]]14[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]23[[:>:]]')";
		$keuzeopsomming[3]["addwhere"][38][]="(a.kenmerken REGEXP '[[:<:]]41[[:>:]]')";

		# Faciliteiten accommodatie
		$keuzeopsomming[4]["combinatiesmogelijk"]=1;
		$keuzeopsomming[4]["name"]="faciliteitenaccommodatie";
		$keuzeopsomming[4]["verfijndname"]="kenmerken";
		$keuzeopsomming[4]["getname"]="vf_kenm";
		$keuzeopsomming[4]["fields"]=array(
			"priveterras"=>15,
			"privezwembad"=>18
		);
	#	$keuzeopsomming[4]["fields"]=array(
	#		"priveterras"=>15,
	#		"balkon"=>16,
	#		"balkonofterras"=>17,
	#		"privezwembad"=>18
	#	);
		$keuzeopsomming[4]["addwhere"][15][]="(t.kenmerken REGEXP '[[:<:]]17[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]30[[:>:]]')";
		$keuzeopsomming[4]["addwhere"][16][]="(t.kenmerken REGEXP '[[:<:]]19[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]33[[:>:]]')";
		$keuzeopsomming[4]["addwhere"][17][]="(t.kenmerken REGEXP '[[:<:]]20[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]34[[:>:]]')";
		$keuzeopsomming[4]["addwhere"][18][]="(t.kenmerken REGEXP '[[:<:]]4[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]4[[:>:]]')";

		# Huisdieren
		$keuzeopsomming[5]["combinatiesmogelijk"]=1;
		$keuzeopsomming[5]["name"]="huisdieren";
		$keuzeopsomming[5]["verfijndname"]="kenmerken";
		$keuzeopsomming[5]["getname"]="vf_kenm";
		$keuzeopsomming[5]["fields"]=array(
			"huisdierentoegestaan"=>19,
			"huisdierenniettoegestaan"=>20
		);
		$keuzeopsomming[5]["addwhere"][19][]="(t.kenmerken REGEXP '[[:<:]]11[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]13[[:>:]]')";
		$keuzeopsomming[5]["addwhere"][20][]="(t.kenmerken_nee REGEXP '[[:<:]]11[[:>:]]' OR a.kenmerken_nee REGEXP '[[:<:]]13[[:>:]]')";

		# Thema's
		$keuzeopsomming[6]["combinatiesmogelijk"]=1;
		$keuzeopsomming[6]["name"]="themas";
		$keuzeopsomming[6]["verfijndname"]="kenmerken";
		$keuzeopsomming[6]["getname"]="vf_kenm";
		$keuzeopsomming[6]["fields"]=array(
			"vleugjewellness"=>24,
			"metznallen"=>28,
			"vakantieparken"=>33,
			"bijzonder"=>22,
			"topselectie"=>25,
			"huisjevoor2"=>27,
			"greenfeeproof"=>29,
			"goedvoorkids"=>21,
			"stekjebijhetwater"=>31,
			"boerderij"=>34
		);

		$keuzeopsomming[6]["addwhere"][21][]="(t.kenmerken REGEXP '[[:<:]]5[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]5[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][22][]="(t.kenmerken REGEXP '[[:<:]]16[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]28[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][23][]="(a.kenmerken REGEXP '[[:<:]]17[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]8[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]5[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][24][]="(a.kenmerken REGEXP '[[:<:]]9[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]3[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][25][]="(t.kenmerken REGEXP '[[:<:]]8[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]8[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][26][]="(t.kenmerken REGEXP '[[:<:]]7[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]7[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]2[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]2[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][27][]="(t.kenmerken REGEXP '[[:<:]]1[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]18[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][28][]="(t.kenmerken REGEXP '[[:<:]]6[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]6[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][29][]="(a.kenmerken REGEXP '[[:<:]]2[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]6[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][30][]="(a.kenmerken REGEXP '[[:<:]]1[[:>:]]' OR p.kenmerken REGEXP '[[:<:]]5[[:>:]]' OR s.kenmerken REGEXP '[[:<:]]4[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][31][]="(a.kenmerken REGEXP '[[:<:]]16[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][32][]="(t.kenmerken REGEXP '[[:<:]]4[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]4[[:>:]]' OR a.kenmerken REGEXP '[[:<:]]11[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][33][]="(a.kenmerken REGEXP '[[:<:]]24[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][34][]="(a.kenmerken REGEXP '[[:<:]]25[[:>:]]')";
		$keuzeopsomming[6]["addwhere"][35][]="(a.kenmerken REGEXP '[[:<:]]37[[:>:]]')";

		# Afstand vanaf Utrecht
		$keuzeopsomming[7]["combinatiesmogelijk"]=0;
		$keuzeopsomming[7]["name"]="afstandvanafutrecht";
		$keuzeopsomming[7]["verfijndname"]="afstandvanafutrecht";
		$keuzeopsomming[7]["getname"]="vf_afst";
		$keuzeopsomming[7]["fields"]=array(
			"tot600"=>1,
			"6001000"=>2,
			"10001500"=>3,
			"meerdan1500"=>4
		);
		$keuzeopsomming[7]["addwhere"][1][]="p.afstandtotutrecht>0";
		$keuzeopsomming[7]["addwhere"][1][]="p.afstandtotutrecht<=600";
		$keuzeopsomming[7]["addwhere"][2][]="p.afstandtotutrecht>600";
		$keuzeopsomming[7]["addwhere"][2][]="p.afstandtotutrecht<=1000";
		$keuzeopsomming[7]["addwhere"][3][]="p.afstandtotutrecht>1000";
		$keuzeopsomming[7]["addwhere"][3][]="p.afstandtotutrecht<=1500";
		$keuzeopsomming[7]["addwhere"][4][]="p.afstandtotutrecht>1500";

	}
}

unset($vars["skigebied"]);

# "Geen voorkeur" aan arrays toevoegen
$vars["skigebied"]["00AAAAA___".$vars["geenvoorkeur"]]=0;


# ID van geselecteerd skigebied bepalen
if($_GET["fsg"] and ereg("^[0-9]+-([0-9]+)$",$_GET["fsg"],$regs)) {
	$gekozen_skigebied=$regs[1];
	$skigebied_inquery=$gekozen_skigebied;
	$koppeling[$gekozen_skigebied]="00000";
}

# Skigebied-array vullen
unset($landgehad);
if($vars["seizoentype"]==1) {
	# landen in de winter niet op alfabet sorteren
	// $landen_sort[1]="01";
	// $landen_sort[2]="02";
	// $landen_sort[3]="03";
	// $landen_sort[5]="04";
	// $landen_sort[4]="05";
	// $landen_sort[7]="06";
	// $landen_sort[6]="07";
}
$db->query("SELECT DISTINCT s.skigebied_id, s.naam".$vars["ttv"]." AS naam, l.naam".$vars["ttv"]." AS land, l.naam AS landnl, l.land_id, s.kortenaam1, s.kortenaam2, s.kortenaam3, s.kortenaam4, s.koppeling_1_1, s.koppeling_1_2, s.koppeling_1_3, s.koppeling_1_4, s.koppeling_1_5, s.koppeling_2_1, s.koppeling_2_2, s.koppeling_2_3, s.koppeling_2_4, s.koppeling_2_5, s.koppeling_3_1, s.koppeling_3_2, s.koppeling_3_3, s.koppeling_3_4, s.koppeling_3_5, s.koppeling_4_1, s.koppeling_4_2, s.koppeling_4_3, s.koppeling_4_4, s.koppeling_4_5, s.koppeling_5_1, s.koppeling_5_2, s.koppeling_5_3, s.koppeling_5_4, s.koppeling_5_5 FROM skigebied s, plaats p, land l, type t, accommodatie a WHERE t.accommodatie_id=a.accommodatie_id AND t.tonen=1 AND t.tonenzoekformulier=1 AND a.tonen=1 AND a.tonenzoekformulier=1 AND ".$vars["where_websites_query_t"]." AND a.plaats_id=p.plaats_id AND l.land_id=p.land_id AND s.skigebied_id=p.skigebied_id".($themalandinfo["soort"]=="land" ? " AND l.land_id='".addslashes($themalandinfo["id"])."'" : "")." ORDER BY l.naam".$vars["ttv"].", s.naam".$vars["ttv"].";");

// echo $db->lq;

while($db->next_record()) {
	$vars["skigebied_nl"][$db->f("land_id")."-".$db->f("skigebied_id")]=$db->f("naam");
}
$db->seek();
while($db->next_record()) {
	// $landen[$db->f("land_id")]=$db->f("land");

	if($landen_sort[$db->f("land_id")]) {
		$sorteer=$landen_sort[$db->f("land_id")];
	} else {
		$sorteer=$db->f("land");
	}

	if(!$landgehad[$db->f("land_id")]) {
		$vars["skigebied"][$sorteer."AAAAA___".$db->f("land")]=$db->f("land_id")."-0";

		$landnaam[$db->f("land_id")]=$db->f("land");
		$landgehad[$db->f("land_id")]=true;
	}
	$skigebied_naam=$db->f("naam");

	// komt het skigebied in meerdere landen voor?
	if(in_array($skigebied_naam, $vars["skigebied_nl"])) {
		$skigebied_aantal=count(array_keys($vars["skigebied_nl"], $skigebied_naam));
		if($skigebied_aantal>1) {
			$skigebied_naam.=" (".$db->f("land").")";
		}
	}

	$vars["skigebied"][$sorteer."ZZZZZ___".$skigebied_naam]=$db->f("land_id")."-".$db->f("skigebied_id");

	# Koppelingen met andere skigebieden bepalen
	if($db->f("skigebied_id")==$gekozen_skigebied) {
		for($i=1;$i<=5;$i++) {
			for($j=1;$j<=5;$j++) {
				if($db->f("koppeling_".$i."_".$j)) {
					$skigebied_inquery.=",".$db->f("koppeling_".$i."_".$j);
					$koppeling[$db->f("koppeling_".$i."_".$j)]=substr("00000".$i,-5);
				}
			}
		}
	}
}

# Sorteren skigebieden
setlocale(LC_COLLATE,"nl_NL.ISO8859-1");
ksort($vars["skigebied"],SORT_LOCALE_STRING);
setlocale(LC_COLLATE,"C");

if(!function_exists("addwhere")) {
	function addwhere($string) {
		global $wherequery;
		$wherequery.=" AND ".$string;
	}
}

# aantalpersonen-array vullen
unset($vars["aantalpersonen"]);
$vars["aantalpersonen"][0]=$vars["geenvoorkeur"];
for($i=1;$i<=39;$i++) {
	$vars["aantalpersonen"][$i]=$i;
}
# laatste keuze: "40 of meer"
$vars["aantalpersonen"][$i]=txt("aantalpersonenofmeer","zoek-en-boek",array("v_aantalpersonen"=>$i));



if(!$_GET["page"]) $_GET["page"]=1;
echo "<div class=\"datadiv\" data-websitetype=\"".intval($vars["websitetype"])."\" data-paginanummer=\"".intval($_GET["page"])."\" data-nieuwezoekopdracht=\"".intval($nieuwe_zoekopdracht)."\" data-referer_zoekenboek=\"".intval($referer_zoekenboek)."\" data-analytics_zoekopdracht=\"".wt_he($analytics_zoekopdracht)."\"></div>";

if($vars["verfijnen_aanbieden"] or $_GET["filled"] or ($vars["websitetype"]==6 and $id=="zoek-en-boek") or $vars["zoekform_thema"] or $vars["zoekform_weekendski"] or $vars["zoekform_vallandrychalets"] or $vars["zoekform_italissima_nieuwe_tarieven"]) {

	$resultaten_tonen=true;

	#
	# Zoek-query samenstellen
	#

	# Bestemming

	# Multiple-bestemmingen
	if(preg_match("/,/",$_GET["fsg"])) {
		$multiple_bestemming=preg_split("/,/",$_GET["fsg"]);
		while(list($key,$value)=each($multiple_bestemming)) {
			if(preg_match("/^pl([0-9]+)$/",$value,$regs)) {
				# plaats
				$multiple_plaats.=",".$regs[1];
			} elseif(preg_match("/^[0-9]+-[0-9]+/",$value)) {
				# skigebied
				$landgebied=explode("-",$value);
				$multiple_skigebied.=",".intval($landgebied[1]);
				if($landgebied[1]==0) {
					$multiple_land.=",".intval($landgebied[0]);
				}
			}
		}
		if($multiple_plaats) {
			$multiple_or.=" OR p.plaats_id IN (".substr($multiple_plaats,1).") OR p.hoortbij_plaats_id IN (".substr($multiple_plaats,1).")";
		}
		if($multiple_skigebied) {
			$multiple_or.=" OR p.skigebied_id IN (".substr($multiple_skigebied,1).")";
		}
		if($multiple_land) {
			$multiple_or.=" OR l.land_id IN (".substr($multiple_land,1).")";
		}
		if($multiple_or) {
			addwhere("(".substr($multiple_or,4).")");
		}
	} else {
		if(preg_match("/^pl([0-9]+)$/",$_GET["fsg"],$regs)) {
			if($regs[1]>0) {
				addwhere("(p.plaats_id IN (".intval($regs[1]).") OR p.hoortbij_plaats_id IN (".intval($regs[1])."))");
			}
		} elseif($_GET["fsg"]>0) {
			$landgebied=explode("-",$_GET["fsg"]);
			if($skigebied_inquery) {
				addwhere("p.skigebied_id IN (".addslashes($skigebied_inquery).")");
				if($landgebied[0]>0) addwhere("l.land_id='".addslashes($landgebied[0])."'");
			} else {
				if($landgebied[1]>0) addwhere("p.skigebied_id='".addslashes($landgebied[1])."'");
				if($landgebied[0]>0) addwhere("l.land_id='".addslashes($landgebied[0])."'");
			}
		}
	}

	# Aantal personen
	if($_GET["fap"]>0) {
		if($_GET["fap"]>=40) {
			$min=$_GET["fap"];
			$max=1000;
		} elseif($_GET["fap"]>20) {
			$min=$_GET["fap"];
			$max=50;
		} else {
			$min=$_GET["fap"];
			$max=$vars["maxpersonen"][$_GET["fap"]];
		}
		addwhere("t.maxaantalpersonen>=".intval($min));
		addwhere("t.maxaantalpersonen<=".intval($max));

		if($vars["website"]<>"Z") {
			# Maximaal 1 slaapkamer per persoon (niet bij Zomerhuisje)
			addwhere("t.slaapkamers<=".intval($_GET["fap"]));
		}
	}

	# Aantal slaapkamers
	if($_GET["fas"]>0) {
		if($_GET["fas"]>=9) {
			$min=$_GET["fas"];
		} else {
			$min=$_GET["fas"];
		}
		if($min) addwhere("t.slaapkamers>=".addslashes($min));
	}

	# Verfijn: searchquery aanpassen
	@reset($keuzeopsomming);
	while(list($key,$value)=@each($keuzeopsomming)) {
		while(list($key2,$value2)=each($value["fields"])) {
			if($value["combinatiesmogelijk"]) {
				$getnumber=$value2;
				$getvalue=1;
			} else {
				$getnumber=1;
				$getvalue=$value2;
			}
			if($_GET[$value["getname"].$getnumber]==$getvalue) {
				reset($value["addwhere"][$value2]);
				while(list($key3,$value3)=each($value["addwhere"][$value2])) {
					addwhere($value3);
				}
			}
		}
	}

	#
	# Kenmerken
	#

	unset($kenmerk);
	# Thema's (via thema-pagina): type-kenmerk
	if($vars["themainfo"]["typekenmerk"]) {
		$kenmerk.=" OR t.kenmerken REGEXP '[[:<:]]".addslashes($vars["themainfo"]["typekenmerk"])."[[:>:]]'";
	}

	# Thema's (via thema-pagina): accommodatie-kenmerk
	if($vars["themainfo"]["accommodatiekenmerk"]) {
		$kenmerk.=" OR a.kenmerken REGEXP '[[:<:]]".addslashes($vars["themainfo"]["accommodatiekenmerk"])."[[:>:]]'";
	}

	# Thema's (via thema-pagina): plaats-kenmerk
	if($vars["themainfo"]["plaatskenmerk"]) {
		$kenmerk.=" OR p.kenmerken REGEXP '[[:<:]]".addslashes($vars["themainfo"]["plaatskenmerk"])."[[:>:]]'";
	}

	# Thema's (via thema-pagina): plaats-kenmerk
	if($vars["themainfo"]["plaatskenmerk"]) {
		$kenmerk.=" OR s.kenmerken REGEXP '[[:<:]]".addslashes($vars["themainfo"]["skigebiedkenmerk"])."[[:>:]]'";
	}

	# Thema's (via thema-pagina): zoekterm
	if($vars["themainfo"]["zoekterm"]) {
		$kenmerk.=" OR a.altnaam LIKE '%".addslashes(trim($vars["themainfo"]["zoekterm"]))."%'";
		$kenmerk.=" OR a.altnaam_zichtbaar LIKE '%".addslashes(trim($vars["themainfo"]["zoekterm"]))."%'";
		$kenmerk.=" OR a.bestelnaam LIKE '%".addslashes(trim($vars["themainfo"]["zoekterm"]))."%'";
		$kenmerk.=" OR t.altnaam LIKE '%".addslashes(trim($vars["themainfo"]["zoekterm"]))."%'";
		$kenmerk.=" OR t.altnaam_zichtbaar LIKE '%".addslashes(trim($vars["themainfo"]["zoekterm"]))."%'";
	}

	if($kenmerk) {
		addwhere("(".substr($kenmerk,4).")");
	}

	# Tarieven nieuwe seizoen bekend
	if($vars["themainfo"]["tarievenbekend_seizoen_id"]) {
		$db0->query("SELECT type_id FROM tarief WHERE (bruto>0 OR c_bruto>0) AND seizoen_id='".addslashes($vars["themainfo"]["tarievenbekend_seizoen_id"])."' GROUP BY type_id HAVING count(type_id)>=4;");
		while($db0->next_record()) {
			$tarievenbekend_seizoen_id_inquery.=",".$db0->f("type_id");
		}
		if(!$tarievenbekend_seizoen_id_inquery) $tarievenbekend_seizoen_id_inquery=",0";
		addwhere("t.type_id IN (".substr($tarievenbekend_seizoen_id_inquery,1).")");
	}

	# Weekendski
	if($vars["zoekform_weekendski"]) {
		addwhere("a.weekendski=1");
	} else {
		addwhere("a.weekendski=0");
	}

	# Vallandry: juist chaletpark + seizoen
	if($vars["zoekform_vallandrychalets"]) {
		addwhere("a.wzt='".$vars["seizoentype"]."'");
		if($_GET["chaletpark"]=="overigechalets") {
			addwhere("a.naam NOT LIKE '%bellecote%'");
			addwhere("a.naam NOT LIKE '%de vallandry%'");
		} else {
			addwhere("a.naam LIKE '%".addslashes($_GET["chaletpark"])."%'");
		}
	}

	# Tekstzoeken
	if($_GET["fzt"]) {
		if(ereg("^[0-9]+$",$_GET["fzt"])) {
			addwhere("t.type_id='".addslashes($_GET["fzt"])."'");
		} else {
			$zoektekst_opslaan=strtolower($_GET["fzt"]);
			$zoektekst=ereg_replace("[',+]"," ",strtolower($_GET["fzt"]));
#			$zoektekst=ereg_replace("-"," ",strtolower($zoektekst));
			$zoektekst=split("[ \+,/]",$zoektekst);
			while(list($key,$value)=each($zoektekst)) {
				if($value) {
					if($value=="apartement" and $vars["taal"]=="nl") $value="appartement";
					$value=addslashes(strtolower($value));
					if($value==txt("chalet","vars")) {
						if($zoektekst[$key+1]==txt("appartement","vars")) {
							if(!$soortacc) addwhere("a.soortaccommodatie=4");
						} else {
							if(!$soortacc) addwhere("(a.soortaccommodatie=1 OR a.soortaccommodatie=4)");
						}
						$soortacc=true;
					} elseif($value==txt("appartement","vars")) {
						if(!$soortacc) addwhere("(a.soortaccommodatie=2 OR a.soortaccommodatie=4)");
						$soortacc=true;
					} elseif($value==txt("hotel","vars")) {
						if(!$soortacc) addwhere("a.soortaccommodatie=3");
						$soortacc=true;
					} else {
						# Zoeken naar gekoppelde plaatsen
						unset($hoortbij);
						$db->query("SELECT plaats_id, hoortbij_plaats_id FROM plaats WHERE naam LIKE '%".$value."%' OR altnaam LIKE '%".$value."%' OR altnaam_zichtbaar LIKE '%".$value."%';");
						while($db->next_record()) {
							$db2->query("SELECT plaats_id FROM plaats WHERE hoortbij_plaats_id='".$db->f("plaats_id")."';");
							while($db2->next_record()) {
								if($hoortbij) $hoortbij.=",".$db2->f("plaats_id"); else $hoortbij=$db2->f("plaats_id");
							}
							if($hoortbij) $hoortbij.=",".$db->f("hoortbij_plaats_id"); else $hoortbij=$db->f("hoortbij_plaats_id");
						}

						$zoektekst_where[]="t.altnaam LIKE '%".$value."%' OR t.altnaam_zichtbaar LIKE '%".$value."%' OR t.naam".$vars["ttv"]." LIKE '%".$value."%' OR t.naam LIKE '%".$value."%' OR t.naam_de LIKE '%".$value."%' OR t.naam_en LIKE '%".$value."%' OR t.naam_fr LIKE '%".$value."%' OR t.omschrijving".$vars["ttv"]." LIKE '%".$value."%' OR t.indeling".$vars["ttv"]." LIKE '%".$value."%' OR t.inclusief".$vars["ttv"]." LIKE '%".$value."%' OR a.naam LIKE '%".$value."%' ".$extraaddwhere." OR a.altnaam LIKE '%".$value."%' OR a.altnaam_zichtbaar LIKE '%".$value."%' OR a.bestelnaam LIKE '%".$value."%' OR a.inclusief".$vars["ttv"]." LIKE '%".$value."%' OR a.indeling".$vars["ttv"]." LIKE '%".$value."%' OR a.omschrijving".$vars["ttv"]." LIKE '%".$value."%' OR p.naam".$vars["ttv"]." LIKE '%".$value."%' OR p.altnaam LIKE '%".$value."%' OR p.altnaam_zichtbaar LIKE '%".$value."%' OR s.naam".$vars["ttv"]." LIKE '%".$value."%' OR s.altnaam LIKE '%".$value."%' OR s.altnaam_zichtbaar LIKE '%".$value."%' OR l.naam".$vars["ttv"]." LIKE '%".$value."%'".($hoortbij ? " OR p.plaats_id IN (".$hoortbij.")" : "");

						# Opties doorzoeken
						$optie_where.=" AND (os.naam".$vars["ttv"]." LIKE '%".$value."%' OR os.naam_enkelvoud".$vars["ttv"]." LIKE '%".$value."%' OR oo.naam".$vars["ttv"]." LIKE '%".$value."%' OR oo.omschrijving_voucher LIKE '%".$value."%' OR og.omschrijving".$vars["ttv"]." LIKE '%".$value."%')";
					}
				}
			}
			if($optie_where) {
				$db->query("SELECT DISTINCT oa.accommodatie_id FROM optie_accommodatie oa, optie_soort os, optie_groep og, optie_onderdeel oo WHERE ".($vars["seizoentype"]==1 ? "os.winter=1" : "os.zomer=1")." AND og.optie_soort_id=os.optie_soort_id AND oo.optie_groep_id=og.optie_groep_id AND oa.optie_soort_id=os.optie_soort_id AND oa.optie_groep_id=og.optie_groep_id AND (".substr($optie_where,5).");");
				while($db->next_record()) {
					if($optie_inquery) $optie_inquery.=",".$db->f("accommodatie_id"); else $optie_inquery=$db->f("accommodatie_id");
				}
			}
			while(list($key,$value)=@each($zoektekst_where)) {
				if($optie_inquery) {
					addwhere("(".$value." OR a.accommodatie_id IN (".$optie_inquery."))");
				} else {
					addwhere("(".$value.")");
				}
			}
		}
	}


	# Alleen accommodaties van een specifieke aanbieding tonen
	if($_GET["abid"]) {
		# aanbieding_accommodatie
		$db->query("SELECT t.type_id FROM type t, aanbieding_accommodatie aa WHERE t.accommodatie_id=aa.accommodatie_id AND aa.aanbieding_id='".addslashes($_GET["abid"])."';");
		while($db->next_record()) {
			$abid_inquery.=",".$db->f("type_id");
		}

		# aanbieding_type
		$db->query("SELECT type_id FROM aanbieding_type WHERE aanbieding_id='".addslashes($_GET["abid"])."';");
		while($db->next_record()) {
			$abid_inquery.=",".$db->f("type_id");
		}

		# aanbieding_leverancier
		$db->query("SELECT t.type_id FROM type t, aanbieding_leverancier al WHERE t.leverancier_id=al.leverancier_id AND al.aanbieding_id='".addslashes($_GET["abid"])."';");
		while($db->next_record()) {
			$abid_inquery.=",".$db->f("type_id");
		}

		if($abid_inquery) {
			addwhere("t.type_id IN (".substr($abid_inquery,1).")");
		}
	}

	if($_GET["lev"]) {
		addwhere("t.leverancier_id='".addslashes($_GET["lev"])."'");
	}

	// soort accommodatie (intern)
	if($voorkant_cms and is_array($_GET["sac"])) {
		foreach ($_GET["sac"] as $key => $value) {
			$soortaccommodatie_query.=" OR ".$keuzeopsomming[3]["addwhere"][$key][0];
		}
		if($soortaccommodatie_query) {
			addwhere("(".substr($soortaccommodatie_query, 4).")");
		}
	}

	if($_GET["gmaps"]) {
		addwhere("a.gps_lat<>''");
	}

	unset($query);


	if($vars["flexibel_toegestaan"] and $_GET["fadf_d"] and $_GET["fadf_m"] and $_GET["fadf_y"]) {


		// Italissima verblijfsduur

		$flex_aankomstdatum=mktime(0,0,0,$_GET["fadf_m"],$_GET["fadf_d"],$_GET["fadf_y"]);

		// bij geen verblijfsduur: uitgaan van verblijfsduur van 1 week
		if($_GET["fdu"]) {
			$gekozen["fdu"]=$_GET["fdu"];
		} else {
			$gekozen["fdu"]=1;
		}

		if(preg_match("/([0-9]+)n/",$gekozen["fdu"],$regs)) {
			$aantalnachten=$regs[1];
		} else {
			$aantalnachten=$gekozen["fdu"]*7;
		}

		# aankomstdatum in het verleden: geen resultaten tonen
		if($flex_aankomstdatum and $flex_aankomstdatum<time()) $flex_aankomstdatum=mktime(0,0,0,1,1,1999);

		# originele aankomst+verblijfsduur vastelggen
		$org_flex_aankomstdatum=$flex_aankomstdatum;
		$org_aantalnachten=$aantalnachten;

		# kijken of dit een alternatieve zoekopdracht betreft. Zo ja: zoeken met alternatieve aankomst+verblijfsduur
		if($_GET["altad"] and $_GET["altvd"]) {
			$flex_aankomstdatum=$_GET["altad"];
			$aantalnachten=$_GET["altvd"];
		}

		# Aankomstdatum een zaterdag en verblijfsduur in weken: dan omzetten naar ouderwetse systeem
		if(date("w",$flex_aankomstdatum)==6 and fmod($aantalnachten,7)==0) {
			$_GET["fad"]=$flex_aankomstdatum;
			$gekozen["fdu"]=floor($aantalnachten/7);
			unset($flex_aankomstdatum);
		}
	} elseif($vars["seizoentype"]==2) {

		// Zomerhuisje verblijfsduur

		// bij geen verblijfsduur: uitgaan van verblijfsduur van 1 week
		if($_GET["fdu"]) {
			$gekozen["fdu"]=$_GET["fdu"];
		} else {
			$gekozen["fdu"]=1;
		}
	}

	if($vars["webtastic"]) {
		$starttime_query=microtime(true);
	}

	if($_GET["aab"] and $_GET["faab"] and !$_GET["fad"] and !$flex_aankomstdatum) {
		# bij "zoek alleen naar aanbiedingen" en geen aankomstdatum: nagaan welke accommodaties allemaal een aanbieding hebben

		$geen_datum_alleen_aanbiedingen=true;

		# aanbiedingen
		$db->query("SELECT seizoen_id FROM seizoen WHERE tonen".($voorkant_cms ? ">=" : "=")."3 AND type='".addslashes($vars["seizoentype"])."' AND eind>='".date("Y-m-d")."' ORDER BY begin;");
		while($db->next_record()) {
			# gewone aanbiedingen
			unset($temp_aanbieding);
			$temp_aanbieding=aanbiedinginfo(0,$db->f("seizoen_id"));

			while(list($key,$value)=@each($temp_aanbieding["typeid_sort"])) {
				$geen_datum_alleen_aanbiedingen_inquery.=",".$key;
			}
		}

		# kortingen
		$db->query("SELECT DISTINCT ta.type_id FROM seizoen s, tarief ta WHERE ta.korting_toon_als_aanbieding=1 AND ta.kortingactief=1 AND ta.seizoen_id=s.seizoen_id AND s.tonen".($voorkant_cms ? ">=" : "=")."3 AND s.type='".addslashes($vars["seizoentype"])."' AND s.eind>='".date("Y-m-d")."' AND ta.week>'".time()."';");
		while($db->next_record()) {
			$geen_datum_alleen_aanbiedingen_inquery.=",".$db->f("type_id");
		}

		if(!$geen_datum_alleen_aanbiedingen_inquery) $geen_datum_alleen_aanbiedingen_inquery=",0";
		addwhere("t.type_id IN (".substr($geen_datum_alleen_aanbiedingen_inquery,1).")");
	}

	$wherequery_zondertarieven=$wherequery;

	$op_te_vragen_velden="a.wzt, t.type_id, t.websites, a.accommodatie_id, a.toonper, a.naam, a.kenmerken AS akenmerken, a.kenmerken_nee AS akenmerken_nee, a.afstandpiste, a.kwaliteit AS akwaliteit, t.kwaliteit AS tkwaliteit, a.korteomschrijving".$vars["ttv"]." AS korteomschrijving, t.korteomschrijving".$vars["ttv"]." AS tkorteomschrijving, t.naam".$vars["ttv"]." AS tnaam, a.zoekvolgorde AS azoekvolgorde, t.zoekvolgorde AS tzoekvolgorde, t.apart_tonen_in_zoekresultaten, lv.zoekvolgorde AS lzoekvolgorde, t.optimaalaantalpersonen, t.maxaantalpersonen, a.soortaccommodatie, t.slaapkamers, t.badkamers, t.kenmerken AS tkenmerken, t.kenmerken_nee AS tkenmerken_nee, a.gps_lat, a.gps_long, t.gps_lat AS tgps_lat, t.gps_long AS tgps_long, p.kenmerken AS pkenmerken, p.afstandtotutrecht, s.kenmerken AS skenmerken, s.skigebied_id, s.naam".$vars["ttv"]." AS skigebied, s.kilometerpiste, l.naam".$vars["ttv"]." AS land, l.begincode, p.naam".$vars["ttv"]." AS plaats";
	if($_GET["fad"]>0 and !$_GET["altflexberekenen"]) {

		# Kijken of korting van toepassing is (om "aanbieding" bij zoekresultaat te kunnen tonen)
		$op_te_vragen_velden.=", tr.aanbiedingskleur , tr.korting_toon_als_aanbieding, tr.toonexactekorting, tr.aanbieding_acc_percentage, tr.aanbieding_acc_euro";

		if($voorkant_cms) {
			$op_te_vragen_velden.=", tr.voorraad_garantie, tr.voorraad_allotment, tr.voorraad_optie_leverancier, tr.voorraad_xml, tr.voorraad_request, tr.voorraad_optie_klant, tr.voorraad_vervallen_allotment";
		}
		# Bij wederverkoop winter: alleen niet geblokkeerde accommodaties en accommodaties met wederverkoop-tarief
		if($vars["wederverkoop"] and $vars["seizoentype"]==1) {
			addwhere("tr.blokkeren_wederverkoop=0");
			addwhere("tr.wederverkoop_verkoopprijs>0");
			$op_te_vragen_velden.=", tr.wederverkoop_verkoopprijs";

			if(!$_GET["fap"]) {
				#
				# Aanbiedingen uit database halen
				#
				$db->query("SELECT seizoen_id FROM seizoen WHERE tonen".($voorkant_cms ? ">=" : "=")."3 AND type='".addslashes($vars["seizoentype"])."' AND eind>='".date("Y-m-d")."' ORDER BY begin;");
				while($db->next_record()) {
					$aanbieding[$db->f("seizoen_id")]=aanbiedinginfo(0,$db->f("seizoen_id"),$_GET["fad"]);
				}
			}
		}

		if($gekozen["fdu"]>1) {
			# Verblijfsduur van meerdere weken: beschikbare accommodaties opvragen
			$verblijfsduur_meerdere_weken=true;
			unset($weekinquery);
			for($i=0;$i<$gekozen["fdu"];$i++) {
				$unixtime=mktime(0,0,0,date("m",$_GET["fad"]),date("d",$_GET["fad"])+(7*$i),date("Y",$_GET["fad"]));
				addwhere("t.type_id IN (SELECT DISTINCT type_id FROM tarief WHERE beschikbaar=1 AND week='".$unixtime."' AND (bruto>0 OR c_bruto>0 OR arrangementsprijs>0))");
				$weekinquery.=",".$unixtime;
				$verblijfsduur_meerdere_weken_array[$unixtime]=true;
			}
			# bij verblijfsduur van meerdere weken: totaalprijs berekenen
			$db->query("SELECT DISTINCT t.type_id, tr.week, tr.wederverkoop_verkoopprijs, sz.seizoen_id FROM accommodatie a, plaats p, skigebied s, land l, leverancier lv, type t, tarief tr, seizoen sz WHERE a.toonper=3 AND lv.leverancier_id=t.leverancier_id AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND l.land_id=p.land_id AND p.plaats_id=a.plaats_id AND p.skigebied_id=s.skigebied_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1 AND tr.week IN (".substr($weekinquery,1).")".$wherequery.";");
			while($db->next_record()) {
				$tarief_meerdere_weken[$db->f("type_id")][$db->f("week")]=$db->f("wederverkoop_verkoopprijs");
			}

			# aanbiedingen voor alle seizoenen ophalen
			unset($aanbieding);
			$db->query("SELECT seizoen_id FROM seizoen WHERE tonen".($voorkant_cms ? ">=" : "=")."3 AND type='".addslashes($vars["seizoentype"])."' AND eind>='".date("Y-m-d")."' ORDER BY begin;");
			while($db->next_record()) {
				$aanbieding[$db->f("seizoen_id")]=aanbiedinginfo(0,$db->f("seizoen_id"));
#				$aanbieding[$key]=aanbiedinginfo(0,$key);
			}
		}
		if($vars["websitetype"]==6) {
			$temp_seizoentype="1,2";
		} else {
			$temp_seizoentype=$vars["seizoentype"];
		}
		if($_GET["fap"] or ($vars["seizoentype"]==2 and $vars["websitetype"]<>6)) {
			#
			# Tarieven opzoeken
			#

			$tarieven_opgezocht=true;

			# Kijken of korting van toepassing is (om "aanbieding" bij zoekresultaat te kunnen tonen)
#			$op_te_vragen_velden.=", tr.toonexactekorting, tr.aanbieding_acc_percentage, tr.aanbieding_acc_euro";

			if($vars["seizoentype"]==1 or $vars["websitetype"]==6) {

				# alleen in de winter

				# toonper = 1 en 2
				if($verblijfsduurquery) {
	#				$query[1]="SELECT DISTINCT ".$op_te_vragen_velden.", sz.seizoen_id, tp.prijs AS prijs_per_persoon FROM accommodatie a, plaats p, skigebied s, land l, leverancier lv, type t, tarief tr, tarief_personen tp, seizoen sz WHERE (a.toonper=1 OR a.toonper=2) AND lv.leverancier_id=t.leverancier_id AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND tp.type_id=t.type_id AND tp.seizoen_id=sz.seizoen_id AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND tr.week='".addslashes($_GET["fad"])."' AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND tp.week='".addslashes($_GET["fad"])."' AND tp.prijs>0 AND tp.personen='".addslashes($_GET["fap"])."' AND t.accommodatie_id=a.accommodatie_id AND l.land_id=p.land_id AND p.plaats_id=a.plaats_id AND p.skigebied_id=s.skigebied_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".$verblijfsduurquery.$wherequery.";";
				} else {
					$query[1]="SELECT DISTINCT ".$op_te_vragen_velden.", sz.seizoen_id, tp.prijs AS prijs_per_persoon FROM accommodatie a, plaats p, skigebied s, land l, leverancier lv, type t, tarief tr, tarief_personen tp, seizoen sz WHERE (a.toonper=1 OR a.toonper=2) AND lv.leverancier_id=t.leverancier_id AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND tp.type_id=t.type_id AND tp.seizoen_id=sz.seizoen_id AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND tr.week='".addslashes($_GET["fad"])."' AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND tp.week='".addslashes($_GET["fad"])."' AND tp.prijs>0 AND tp.personen='".addslashes($_GET["fap"])."' AND t.accommodatie_id=a.accommodatie_id AND l.land_id=p.land_id AND p.plaats_id=a.plaats_id AND p.skigebied_id=s.skigebied_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".$wherequery.";";
				}
			}

			# toonper = 3
			if($verblijfsduurquery) {
#				$query[2]="SELECT DISTINCT ".$op_te_vragen_velden.", sz.seizoen_id, tr.c_verkoop_site FROM accommodatie a, plaats p, skigebied s, land l, leverancier lv, type t, tarief tr, seizoen sz WHERE a.toonper=3 AND lv.leverancier_id=t.leverancier_id AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND tr.week='".addslashes($_GET["fad"])."' AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND l.land_id=p.land_id AND p.plaats_id=a.plaats_id AND p.skigebied_id=s.skigebied_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".$verblijfsduurquery.$wherequery.";";
			} else {
				$query[2]="SELECT DISTINCT ".$op_te_vragen_velden.", sz.seizoen_id, tr.c_verkoop_site FROM accommodatie a, plaats p, skigebied s, land l, leverancier lv, type t, tarief tr, seizoen sz WHERE a.toonper=3 AND lv.leverancier_id=t.leverancier_id AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND tr.week='".addslashes($_GET["fad"])."' AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND l.land_id=p.land_id AND p.plaats_id=a.plaats_id AND p.skigebied_id=s.skigebied_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".$wherequery.";";
			}

			#
			# Aanbiedingen uit database halen
			#
			$db->query("SELECT seizoen_id FROM seizoen WHERE tonen".($voorkant_cms ? ">=" : "=")."3 AND type IN (".addslashes($temp_seizoentype).") AND eind>='".date("Y-m-d")."' ORDER BY begin;");
			while($db->next_record()) {
				$aanbieding[$db->f("seizoen_id")]=aanbiedinginfo(0,$db->f("seizoen_id"),$_GET["fad"]);
			}
		} else {
			# aantal personen niet ingevuld
			if($verblijfsduurquery) {
#				$query[1]="SELECT DISTINCT ".$op_te_vragen_velden.", sz.seizoen_id FROM accommodatie a, plaats p, skigebied s, land l, leverancier lv, type t, tarief tr, seizoen sz WHERE lv.leverancier_id=t.leverancier_id AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND tr.week='".addslashes($_GET["fad"])."' AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND l.land_id=p.land_id AND p.plaats_id=a.plaats_id AND p.skigebied_id=s.skigebied_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".$verblijfsduurquery.$wherequery.";";
			} else {
				$query[1]="SELECT DISTINCT ".$op_te_vragen_velden.", sz.seizoen_id FROM accommodatie a, plaats p, skigebied s, land l, leverancier lv, type t, tarief tr, seizoen sz WHERE lv.leverancier_id=t.leverancier_id AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND tr.week='".addslashes($_GET["fad"])."' AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND l.land_id=p.land_id AND p.plaats_id=a.plaats_id AND p.skigebied_id=s.skigebied_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".$wherequery.";";
			}
		}
	} elseif($flex_aankomstdatum and $vars["flexibel_toegestaan"]) {
		# Flexibele aankomst
		unset($andquery);
		for($i=0;$i<$aantalnachten;$i++) {
			$dag=mktime(0,0,0,date("m",$flex_aankomstdatum),date("d",$flex_aankomstdatum)+$i,date("Y",$flex_aankomstdatum));
			if($i==0) {
				$andquery.=" OR (dag='".$dag."' AND aankomstdag=1 AND minimum_aantal_nachten<=".$aantalnachten." AND verkoop_site>0 AND beschikbaar=1)";
			} else {
				$andquery.=" OR (dag='".$dag."' AND verkoop_site>0 AND beschikbaar=1)";
			}
		}

		unset($inquery);
		$db->query("SELECT type_id, count(type_id) AS aantal, sum(verkoop_site) AS verkoop_site FROM tarief_flex WHERE 1=2".$andquery." GROUP BY type_id;");
		while($db->next_record()) {
			if($db->f("aantal")==$aantalnachten) {
				$inquery.=",".$db->f("type_id");

				$flex_tarief[$db->f("type_id")]=$db->f("verkoop_site");
			}
		}
		if($inquery) {
			$inquery=substr($inquery,1);
		} else {
			$inquery="0";
		}

		# Accommodaties doorzoeken op basis van inquery
		$query[1]="SELECT DISTINCT ".$op_te_vragen_velden." FROM accommodatie a, plaats p, skigebied s, land l, leverancier lv, type t WHERE t.type_id IN (".$inquery.") AND lv.leverancier_id=t.leverancier_id AND t.accommodatie_id=a.accommodatie_id AND l.land_id=p.land_id AND p.plaats_id=a.plaats_id AND p.skigebied_id=s.skigebied_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".$wherequery.";";

	} else {
        $query_tarief = "SELECT DISTINCT type_id, seizoen_id, aanbiedingskleur , korting_toon_als_aanbieding, toonexactekorting, aanbieding_acc_percentage, aanbieding_acc_euro FROM tarief WHERE korting_toon_als_aanbieding=1 AND (bruto > 0 OR c_bruto > 0) AND beschikbaar=1 AND week >= UNIX_TIMESTAMP(CURDATE()) ORDER BY week DESC";
		$db->query($query_tarief);
        while($db->next_record()){
            $discount_list[$db->f("type_id")]["percentage"] = $db->f("aanbieding_acc_percentage");
            $discount_list[$db->f("type_id")]["euro"] = $db->f("aanbieding_acc_euro");
        }
		# Alle accommodaties doorzoeken
		$query[1]="SELECT DISTINCT ".$op_te_vragen_velden." FROM accommodatie a, plaats p, skigebied s, land l, leverancier lv, type t WHERE lv.leverancier_id=t.leverancier_id AND t.accommodatie_id=a.accommodatie_id AND l.land_id=p.land_id AND p.plaats_id=a.plaats_id AND p.skigebied_id=s.skigebied_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".$wherequery.";";
	}

	if(!$tarieven_opgezocht and !$flex_aankomstdatum) {
		if($vars["seizoentype"]==1 and !$vars["wederverkoop"] and !$vars["zoekform_weekendski"]) {
			#
			# Vanaf-prijzen winter uit database halen
			#

			# winter - arrangement + accommodatie

			$vanaf_prijzen_tonen=true;

			if(!$_GET["fap"] and !$_GET["fad"] and !$vars["themainfo"]["tarievenbekend_seizoen_id"]) {
				if($voorkant_cms) {
					$prijs_field="prijs_intern";
				} elseif($vars["themainfo"]["tarievenbekend_seizoen_id"]) {
					$prijs_field="prijs_nieuw_seizoen";
				} else {
					$prijs_field="prijs";
				}
				$tarief_from_cache = true;
				$db->query("SELECT t.type_id, a.toonper, c.".$prijs_field." AS prijs FROM accommodatie a, type t, ".$table_name_cache_vanafprijs." c WHERE t.accommodatie_id=a.accommodatie_id AND c.type_id=t.type_id AND a.wzt IN (".$temp_seizoentype.");");

				while($db->next_record()) {
					if($db->f("toonper")==1) {
						$vanafprijs_12[$db->f("type_id")]=$db->f("prijs");
					} else {
						$vanafprijs_3[$db->f("type_id")]=$db->f("prijs");
					}
				}
			} else {
				# toonper = 1 en 2 (arrangement)
				$db->query("SELECT tp.type_id, MIN(tp.prijs) AS prijs_per_persoon FROM tarief tr, tarief_personen tp, seizoen sz WHERE tr.seizoen_id=sz.seizoen_id AND tp.type_id=tr.type_id AND tp.seizoen_id=sz.seizoen_id AND tp.week=tr.week AND tr.week>".time()." AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND tp.prijs>0".($_GET["fap"] ? " AND tp.personen='".addslashes($_GET["fap"])."'" : "").($_GET["fad"] ? " AND tr.week='".addslashes($_GET["fad"])."'" : "").($vars["themainfo"]["tarievenbekend_seizoen_id"] ? " AND sz.seizoen_id='".intval($vars["themainfo"]["tarievenbekend_seizoen_id"])."'" : "")." GROUP BY tp.type_id;");
				while($db->next_record()) {
					$vanafprijs_12[$db->f("type_id")]=$db->f("prijs_per_persoon");
				}

				// toonper = 3 (accommodatie)
				if(!$_GET["fad"] and $_GET["fap"] and $bk_all_persons) {

					//
					// minimum-price (vanaf-prijs) combined with surcharge extra persons
					//

					$db->query("SELECT tr.type_id, tr.c_verkoop_site AS c_verkoop_site, tr.week FROM accommodatie a, type t, tarief tr, seizoen sz WHERE a.toonper=3 AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND tr.week>".time()." AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".($_GET["fad"] ? " AND tr.week='".addslashes($_GET["fad"])."'" : "").($vars["themainfo"]["tarievenbekend_seizoen_id"] ? " AND sz.seizoen_id='".intval($vars["themainfo"]["tarievenbekend_seizoen_id"])."'" : "").";");
					while($db->next_record()) {

						if($db->f("c_verkoop_site")>0) {
							$vanafprijs_3_temp[$db->f("type_id")][$db->f("week")] = $db->f("c_verkoop_site");
							if($bk_all_persons[$db->f("type_id")][$db->f("week")]) {
								$vanafprijs_3_temp[$db->f("type_id")][$db->f("week")] += $bk_all_persons[$db->f("type_id")][$db->f("week")];
							}
						}
					}
					if(is_array($vanafprijs_3_temp)) {
						foreach ($vanafprijs_3_temp as $key => $value) {
							$vanafprijs_3[$key]=min($value);

						}
					}
				} else {
					// toonper = 3 (accommodatie)
					$db->query("SELECT tr.type_id, MIN(tr.c_verkoop_site) AS c_verkoop_site FROM accommodatie a, type t, tarief tr, seizoen sz WHERE a.toonper=3 AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND tr.week>".time()." AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".($_GET["fad"] ? " AND tr.week='".addslashes($_GET["fad"])."'" : "").($vars["themainfo"]["tarievenbekend_seizoen_id"] ? " AND sz.seizoen_id='".intval($vars["themainfo"]["tarievenbekend_seizoen_id"])."'" : "")." GROUP BY tr.type_id;");
					while($db->next_record()) {
						$vanafprijs_3[$db->f("type_id")]=$db->f("c_verkoop_site");
					}
				}
			}
		} elseif($vars["seizoentype"]==1 and $vars["wederverkoop"] and !$vars["zoekform_weekendski"] and !$_GET["fad"]) {

			# winter - alleen accommodatie (wederverkoop)

			$vanaf_prijzen_tonen=true;

			if(!$_GET["fap"] and !$_GET["fad"] and !$vars["themainfo"]["tarievenbekend_seizoen_id"]) {

				if($voorkant_cms) {
					$prijs_field="prijs_wederverkoop_intern";
				} else {
					$prijs_field="prijs_wederverkoop";
				}

				if($temp_seizoentype=="1,2") {
					// ChaletsinVallandry: also get summer prices
					if($voorkant_cms) {
						$prijs_field_vallandry=", prijs_intern AS prijs_vallandry";
					} else {
						$prijs_field_vallandry=", prijs AS prijs_vallandry";
					}
				}

				$tarief_from_cache = true;
				$db->query("SELECT a.wzt, t.type_id, a.toonper, c.".$prijs_field." AS prijs".$prijs_field_vallandry." FROM accommodatie a, type t, ".$table_name_cache_vanafprijs." c WHERE t.accommodatie_id=a.accommodatie_id AND c.type_id=t.type_id AND a.wzt IN (".$temp_seizoentype.");");

				while($db->next_record()) {
					if($temp_seizoentype=="1,2") {
						// ChaletsinVallandry: also use summer prices
						if($db->f("wzt")==2) {
							$vanafprijs_3[$db->f("type_id")]=$db->f("prijs_vallandry");
						} else {
							$vanafprijs_3[$db->f("type_id")]=$db->f("prijs");
						}
					} else {
						$vanafprijs_3[$db->f("type_id")]=$db->f("prijs");
					}
				}
			} else {

				if(!$_GET["fad"] and $_GET["fap"] and $bk_all_persons) {

					//
					// minimum-price (vanaf-prijs) combined with surcharge extra persons
					//

					# toonper = 3 (accommodatie)
					$db->query("SELECT tr.type_id, tr.wederverkoop_verkoopprijs AS wederverkoop_verkoopprijs, tr.week FROM accommodatie a, type t, tarief tr, seizoen sz WHERE (a.toonper=1 OR a.toonper=3) AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND tr.blokkeren_wederverkoop=0 AND tr.week>".time()." AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".($_GET["fad"] ? " AND tr.week='".addslashes($_GET["fad"])."'" : "").($vars["themainfo"]["tarievenbekend_seizoen_id"] ? " AND sz.seizoen_id='".intval($vars["themainfo"]["tarievenbekend_seizoen_id"])."'" : "").";");

					while($db->next_record()) {

						if($db->f("wederverkoop_verkoopprijs")>0) {
							$vanafprijs_3_temp[$db->f("type_id")][$db->f("week")] = $db->f("wederverkoop_verkoopprijs");
							if($bk_all_persons[$db->f("type_id")][$db->f("week")]) {
								$vanafprijs_3_temp[$db->f("type_id")][$db->f("week")] += $bk_all_persons[$db->f("type_id")][$db->f("week")];
							}
						}
					}
					if(is_array($vanafprijs_3_temp)) {
						foreach ($vanafprijs_3_temp as $key => $value) {
							$vanafprijs_3[$key]=min($value);

						}
					}

				} else {

					# toonper = 3 (accommodatie)
					$db->query("SELECT tr.type_id, MIN(tr.wederverkoop_verkoopprijs) AS wederverkoop_verkoopprijs FROM accommodatie a, type t, tarief tr, seizoen sz WHERE (a.toonper=1 OR a.toonper=3) AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND tr.blokkeren_wederverkoop=0 AND tr.week>".time()." AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".($_GET["fad"] ? " AND tr.week='".addslashes($_GET["fad"])."'" : "").($vars["themainfo"]["tarievenbekend_seizoen_id"] ? " AND sz.seizoen_id='".intval($vars["themainfo"]["tarievenbekend_seizoen_id"])."'" : "")." GROUP BY tr.type_id;");

					while($db->next_record()) {
						$vanafprijs_3[$db->f("type_id")]=$db->f("wederverkoop_verkoopprijs");
					}
				}
			}

		} elseif($vars["seizoentype"]==2 and (!$gekozen["fdu"] or $gekozen["fdu"]==1)) {
			#
			# Vanaf-prijzen zomer uit database halen (alleen bij geen verblijfsduur, of verblijfsduur van 1 week)
			#

			$vanaf_prijzen_tonen=true;

			if(!$_GET["fap"] and !$_GET["fad"] and !$vars["themainfo"]["tarievenbekend_seizoen_id"]) {
				if($voorkant_cms) {
					$prijs_field="prijs_intern";
				} elseif($vars["themainfo"]["tarievenbekend_seizoen_id"]) {
					$prijs_field="prijs_nieuw_seizoen";
				} else {
					$prijs_field="prijs";
				}

				$tarief_from_cache = true;
				$db->query("SELECT t.type_id, a.toonper, c.".$prijs_field." AS prijs FROM accommodatie a, type t, ".$table_name_cache_vanafprijs." c WHERE t.accommodatie_id=a.accommodatie_id AND c.type_id=t.type_id AND a.wzt IN (".$temp_seizoentype.");");
				while($db->next_record()) {
					$vanafprijs_3[$db->f("type_id")]=$db->f("prijs");
				}
			} else {

				if(!$_GET["fad"] and $_GET["fap"] and $bk_all_persons) {

					//
					// minimum-price (vanaf-prijs) combined with surcharge extra persons
					//
					$db->query("SELECT tr.type_id, tr.c_verkoop_site AS c_verkoop_site, tr.week FROM accommodatie a, type t, tarief tr, seizoen sz WHERE a.toonper=3 AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND tr.week>".time()." AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".($_GET["fad"] ? " AND tr.week='".addslashes($_GET["fad"])."'" : "").($vars["themainfo"]["tarievenbekend_seizoen_id"] ? " AND sz.seizoen_id='".intval($vars["themainfo"]["tarievenbekend_seizoen_id"])."'" : "").";");
					while($db->next_record()) {

						if($db->f("c_verkoop_site")>0) {
							$vanafprijs_3_temp[$db->f("type_id")][$db->f("week")] = $db->f("c_verkoop_site");
							if($bk_all_persons[$db->f("type_id")][$db->f("week")]) {
								$vanafprijs_3_temp[$db->f("type_id")][$db->f("week")] += $bk_all_persons[$db->f("type_id")][$db->f("week")];
							}
						}
					}
					if(is_array($vanafprijs_3_temp)) {
						foreach ($vanafprijs_3_temp as $key => $value) {
							$vanafprijs_3[$key]=min($value);

						}
					}


				} else {

					# toonper = 3 (accommodatie)
					$db->query("SELECT tr.type_id, MIN(tr.c_verkoop_site) AS c_verkoop_site FROM accommodatie a, type t, tarief tr, seizoen sz WHERE a.toonper=3 AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND tr.week>".time()." AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".($_GET["fad"] ? " AND tr.week='".addslashes($_GET["fad"])."'" : "").($vars["themainfo"]["tarievenbekend_seizoen_id"] ? " AND sz.seizoen_id='".intval($vars["themainfo"]["tarievenbekend_seizoen_id"])."'" : "")." GROUP BY tr.type_id;");
					while($db->next_record()) {
						$vanafprijs_3[$db->f("type_id")]=$db->f("c_verkoop_site");
					}
				}
			}
		}
	}

	if($vars["flexibel_toegestaan"]) {

		# Alternatieve periode bekijken
		$dagmin3=mktime(0,0,0,date("m",$org_flex_aankomstdatum),date("d",$org_flex_aankomstdatum)-3,date("Y",$org_flex_aankomstdatum));
		$dag=mktime(0,0,0,date("m",$org_flex_aankomstdatum),date("d",$org_flex_aankomstdatum)+$org_aantalnachten-1,date("Y",$org_flex_aankomstdatum));
		$dagplus3=mktime(0,0,0,date("m",$org_flex_aankomstdatum),date("d",$org_flex_aankomstdatum)+3+$org_aantalnachten,date("Y",$org_flex_aankomstdatum));

		$doorloop_array_van=array(
			1=>mktime(0,0,0,date("m",$org_flex_aankomstdatum),date("d",$org_flex_aankomstdatum)-3,date("Y",$org_flex_aankomstdatum)),
			2=>mktime(0,0,0,date("m",$org_flex_aankomstdatum),date("d",$org_flex_aankomstdatum)-2,date("Y",$org_flex_aankomstdatum)),
			3=>mktime(0,0,0,date("m",$org_flex_aankomstdatum),date("d",$org_flex_aankomstdatum)-1,date("Y",$org_flex_aankomstdatum)),
			4=>mktime(0,0,0,date("m",$org_flex_aankomstdatum),date("d",$org_flex_aankomstdatum),date("Y",$org_flex_aankomstdatum)),
			5=>mktime(0,0,0,date("m",$org_flex_aankomstdatum),date("d",$org_flex_aankomstdatum)+1,date("Y",$org_flex_aankomstdatum)),
			6=>mktime(0,0,0,date("m",$org_flex_aankomstdatum),date("d",$org_flex_aankomstdatum)+2,date("Y",$org_flex_aankomstdatum)),
			7=>mktime(0,0,0,date("m",$org_flex_aankomstdatum),date("d",$org_flex_aankomstdatum)+3,date("Y",$org_flex_aankomstdatum))
		);
		$doorloop_array_tot=array(
			1=>mktime(0,0,0,date("m",$dag),date("d",$dag)-3,date("Y",$dag)),
			2=>mktime(0,0,0,date("m",$dag),date("d",$dag)-2,date("Y",$dag)),
			3=>mktime(0,0,0,date("m",$dag),date("d",$dag)-1,date("Y",$dag)),
			4=>mktime(0,0,0,date("m",$dag),date("d",$dag),date("Y",$dag)),
			5=>mktime(0,0,0,date("m",$dag),date("d",$dag)+1,date("Y",$dag)),
			6=>mktime(0,0,0,date("m",$dag),date("d",$dag)+2,date("Y",$dag)),
			7=>mktime(0,0,0,date("m",$dag),date("d",$dag)+3,date("Y",$dag))
		);
		$doorloop_array_aantalnachten=array(
			1=>$org_aantalnachten,
			2=>$org_aantalnachten,
			3=>$org_aantalnachten,
			4=>$org_aantalnachten,
			5=>$org_aantalnachten,
			6=>$org_aantalnachten
		);
		$db->query("SELECT type_id, dag, aankomstdag, minimum_aantal_nachten FROM tarief_flex WHERE beschikbaar=1 AND verkoop_site>0 AND dag>='".$dagmin3."' AND dag<='".$dagplus3."' ORDER BY type_id, dag;");
		while($db->next_record()) {
			for($i=1;$i<=6;$i++) {
				if($db->f("dag")>=$doorloop_array_van[$i] and $db->f("dag")<=$doorloop_array_tot[$i]) {
					if($db->f("dag")==$doorloop_array_van[$i]) {
						# eerste dag van de reis
						if($db->f("aankomstdag") and $db->f("minimum_aantal_nachten")<=$doorloop_array_aantalnachten[$i]) {
							$flextype_beschikbaar[$i][$db->f("type_id")]++;
						}
					} else {
						# alle andere dagen
						$flextype_beschikbaar[$i][$db->f("type_id")]++;
					}
				}
			}
		}
		for($i=1;$i<=6;$i++) {
			while(list($key,$value)=@each($flextype_beschikbaar[$i])) {
				if($value==$doorloop_array_aantalnachten[$i]) {
					$alt_types[$i][$key]=true;
				}
			}
		}

		# Aantal resultaten uit database halen
		$db->query("SELECT DISTINCT type_id FROM accommodatie a, plaats p, skigebied s, land l, leverancier lv, type t WHERE lv.leverancier_id=t.leverancier_id AND t.accommodatie_id=a.accommodatie_id AND l.land_id=p.land_id AND p.plaats_id=a.plaats_id AND p.skigebied_id=s.skigebied_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".$wherequery_zondertarieven.";");
		while($db->next_record()) {
			for($i=1;$i<=6;$i++) {
				if($alt_types[$i][$db->f("type_id")]) {
					$alt_aantalresultaten[$i]++;
				}
			}
		}
		for($i=1;$i<=6;$i++) {
			if($alt_aantalresultaten[$i]>0 and $doorloop_array_aantalnachten[$i]<=$vars["flex_max_aantalnachten"]) {
				$qs=$_SERVER["QUERY_STRING"];
				$qs=preg_replace("/&z=[0-9]+/","",$qs);
				$qs=preg_replace("/&altad=[0-9]+/","",$qs);
				$qs=preg_replace("/&altvd=[0-9]+/","",$qs);
				$qs=preg_replace("/&altflexberekenen=[0-9]+/","",$qs);
				$qs.="&altad=".$doorloop_array_van[$i]."&altvd=".$doorloop_array_aantalnachten[$i];

				# aantal resultaten zaterdag-zaterdag opvragen
				if(date("w",$doorloop_array_van[$i])==6 and date("w",$doorloop_array_tot[$i])==5) {

					$aantalweken=round(($doorloop_array_tot[$i]-$doorloop_array_van[$i])/(86400*7));
					if($aantalweken>1) {
						for($j=0;$j<$aantalweken;$j++) {
							$unixtime=mktime(0,0,0,date("m",$doorloop_array_van[$i]),date("d",$doorloop_array_van[$i])+(7*$j),date("Y",$doorloop_array_van[$i]));
							addwhere("t.type_id IN (SELECT DISTINCT type_id FROM tarief WHERE beschikbaar=1 AND week='".$unixtime."' AND (bruto>0 OR c_bruto>0 OR arrangementsprijs>0))");
						}
					}

					$db->query("SELECT DISTINCT t.type_id FROM accommodatie a, plaats p, skigebied s, land l, leverancier lv, type t, tarief tr, seizoen sz WHERE lv.leverancier_id=t.leverancier_id AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND tr.week='".addslashes($doorloop_array_van[$i])."' AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND l.land_id=p.land_id AND p.plaats_id=a.plaats_id AND p.skigebied_id=s.skigebied_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".$wherequery.";");
#					$query[1]="SELECT DISTINCT t.type_id FROM accommodatie a, plaats p, skigebied s, land l, leverancier lv, type t, tarief tr, seizoen sz WHERE lv.leverancier_id=t.leverancier_id AND tr.type_id=t.type_id AND tr.seizoen_id=sz.seizoen_id AND sz.tonen".($voorkant_cms||$vars["themainfo"]["tarievenbekend_seizoen_id"] ? ">=" : "=")."3 AND sz.type IN (".$temp_seizoentype.") AND tr.beschikbaar=1 AND tr.week='".addslashes($_GET["fad"])."' AND (tr.bruto>0 OR tr.c_bruto>0 OR tr.arrangementsprijs>0) AND t.accommodatie_id=a.accommodatie_id AND l.land_id=p.land_id AND p.plaats_id=a.plaats_id AND p.skigebied_id=s.skigebied_id AND ".$vars["where_websites_query_t"]." AND a.tonen=1 AND a.tonenzoekformulier=1 AND t.tonen=1 AND t.tonenzoekformulier=1".$wherequery.";";

					$alt_aantalresultaten[$i]=$db->num_rows();

					$qs.="&altflexberekenen=0";
				} else {
					$qs.="&altflexberekenen=1";
				}
				if($alt_aantalresultaten[$i]>0) {
					$flex_alt[$doorloop_array_van[$i]."_".$doorloop_array_tot[$i]]="".DATUM("DAG D MAAND JJJJ",$doorloop_array_van[$i],$vars["taal"])." - ".DATUM("DAG D MAAND JJJJ",mktime(0,0,0,date("m",$doorloop_array_tot[$i]),date("d",$doorloop_array_tot[$i])+1,date("Y",$doorloop_array_tot[$i])),$vars["taal"]);
					$flex_alt_resultatenlink[$doorloop_array_van[$i]."_".$doorloop_array_tot[$i]]="<a href=\"".wt_he($vars["path"].txt("menu_zoek-en-boek").".php?".$qs)."\">".$alt_aantalresultaten[$i]." resultaten</a>";
					$flex_alt_resultatenzonderlink[$doorloop_array_van[$i]."_".$doorloop_array_tot[$i]]=$alt_aantalresultaten[$i]." resultaten";
				}
			}
		}

		// functie uitgezet op 09-10-2012; getoonde gegevens waren niet correct
		// TODO: herstellen en weer aanzetten overzicht andere beschikbare flexibele datums Italissima
		if($vars["flexibel_toegestaan"] and is_array($flex_alt) and $NU_EVEN_NIET) {
			$flex_alt_html.="<div class=\"flexalternatieven boxshadow\">";
			$flex_alt_html.="<i>".html("bekijkeventueelook","zoek-en-boek").":</i><br><br>";

			while(list($key,$value)=each($flex_alt)) {
				if(!$flex_aankomstdatum) {
					if($_GET["altad"]) {
						$flex_aankomstdatum=$_GET["altad"];
					} elseif($_GET["fad"]) {
						$flex_aankomstdatum=$_GET["fad"];
					}
				}
				if($key==$flex_aankomstdatum."_".mktime(0,0,0,date("m",$flex_aankomstdatum),date("d",$flex_aankomstdatum)+$aantalnachten-1,date("Y",$flex_aankomstdatum))) {
					$flex_alt_html.="<span style=\"font-style:italic;color:#555555;\">".$value.": ".$flex_alt_resultatenzonderlink[$key]."</span><br>";
				} else {
					$flex_alt_html.=$value.": ".$flex_alt_resultatenlink[$key]."<br>";
				}
			}
			$flex_alt_html.="</div>";
		}
	}
	while(list($key,$value)=each($query)) {
		$db->query($value);
		while($db->next_record()) {
			unset($zoekvolgorde,$soort_aanbieding,$prijsperpersoon,$prijsperaccommodatie);

			# Tarieven - tarief bepalen
			if($verblijfsduur_meerdere_weken) {
				unset($tarief);
				@reset($verblijfsduur_meerdere_weken_array);
				while(list($key,$value)=@each($verblijfsduur_meerdere_weken_array)) {
					$tarief_temp=$tarief_meerdere_weken[$db->f("type_id")][$key];

					# Zijn er aanbiedingen van toepassing?
					if($aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")]["bedrag"][$key]) {
						$tarief_org=$tarief_temp;
						$tarief_temp=verwerk_aanbieding($tarief_temp,$aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")],$key);
						if($aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")]["toon_als_aanbieding"]) {
							if($tarief_org>$tarief_temp) {
								$soort_aanbieding["onbekend"]=true;
								if($aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")]["korting_euro"][$_GET["fad"]]>0) {
									# korting in euro's
									$soort_aanbieding["euro"][]=$aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")]["korting_euro"][$_GET["fad"]];
									unset($soort_aanbieding["onbekend"]);
								}
								if($aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")]["korting_percentage"][$_GET["fad"]]>0) {
									# kortingspercentage
									$soort_aanbieding["percentage"][]=$aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")]["korting_percentage"][$_GET["fad"]];
									unset($soort_aanbieding["onbekend"]);
								}
							}
						}
					}
					$tarief=$tarief+$tarief_temp;
				}
				if(!$tarief) {
					trigger_error("tarief=0 bij tarief_meerdere_weken acc ".$db->f("begincode").$db->f("type_id"),E_USER_NOTICE);
				}
			} elseif($flex_tarief[$db->f("type_id")]>0) {
				$tarief=$flex_tarief[$db->f("type_id")];
			} elseif($db->f("wederverkoop_verkoopprijs")>0) {
				# Wederverkoop
				$tarief=$db->f("wederverkoop_verkoopprijs");
			} elseif($db->f("prijs_per_persoon")>0) {
				# Toonper = 1 en 2
				$tarief=$db->f("prijs_per_persoon");

				# Sorteer=AAA, zodat toonper1&2 (prijs per persoon) bovenaan worden getoond
				$toonper12++;

				$prijsperpersoon=true;
			} elseif($db->f("c_verkoop_site")>0) {
				# Toonper = 3
				$tarief=$db->f("c_verkoop_site");

				# Sorteer=ZZZ, zodat toonper3 (prijs per acc) onderaan wordt getoond
				$toonper3++;

				$prijsperaccommodatie=true;
			} elseif($vanafprijs_12[$db->f("type_id")]>0) {
				$tarief=$vanafprijs_12[$db->f("type_id")];

				# Sorteer=AAA, zodat toonper1&2 (prijs per persoon) bovenaan worden getoond
				$toonper12++;

				$prijsperpersoon=true;

			} elseif($vanafprijs_3[$db->f("type_id")]>0) {
				$tarief=$vanafprijs_3[$db->f("type_id")];

				# Sorteer=ZZZ, zodat toonper3 (prijs per acc) onderaan wordt getoond
				$toonper3++;

			} else {
				$tarief=0;
			}
			# Zijn er aanbiedingen van toepassing?
			if(!$verblijfsduur_meerdere_weken) {
				if($aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")]["bedrag"][$_GET["fad"]]) {
					$tarief_org=$tarief;
					$tarief=verwerk_aanbieding($tarief,$aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")],$_GET["fad"]);
					if($aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")]["toon_als_aanbieding"]) {
						if($tarief_org>$tarief) {
							$soort_aanbieding["onbekend"]=true;
							if($aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")]["korting_euro"][$_GET["fad"]]>0) {
								# korting in euro's
								$soort_aanbieding["euro"][]=$aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")]["korting_euro"][$_GET["fad"]];
								unset($soort_aanbieding["onbekend"]);
							}
							if($aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")]["korting_percentage"][$_GET["fad"]]>0) {
								# kortingspercentage
								$soort_aanbieding["percentage"][]=$aanbieding[$db->f("seizoen_id")]["typeid_sort"][$db->f("type_id")]["korting_percentage"][$_GET["fad"]];
								unset($soort_aanbieding["onbekend"]);
							}
						}
					}
				}
			}

			if(!$soort_aanbieding) {
				if($db->f("korting_toon_als_aanbieding") or $db->f("aanbiedingskleur")) {

					$soort_aanbieding["onbekend"]=true;
					if($db->f("aanbieding_acc_percentage")>0 and $db->f("toonexactekorting")) {
						$soort_aanbieding["percentage"][]=$db->f("aanbieding_acc_percentage");
						unset($soort_aanbieding["onbekend"]);
					}
					if($db->f("aanbieding_acc_euro")>0 and $db->f("toonexactekorting")) {
						$soort_aanbieding["euro"][]=$db->f("aanbieding_acc_euro");
						unset($soort_aanbieding["onbekend"]);
					}
				}
			}

            if(!$soort_aanbieding and !isset($page_uniqueID)){
                if(isset($discount_list[$db->f("type_id")]) and ($discount_list[$db->f("type_id")]["percentage"] > 0)){
                    $soort_aanbieding["percentage"] = $discount_list[$db->f("type_id")]["percentage"];
                }
               if(isset($discount_list[$db->f("type_id")]) and ($discount_list[$db->f("type_id")]["euro"] > 0)){
                    $soort_aanbieding["euro"] = $discount_list[$db->f("type_id")]["euro"];
                }
            }
			unset($tarief_float);
			if($tarief>0) {

				if($vars["websitetype"]==6) {
					if($db->f("wzt") == 2) {
						$bk = $bk_summer;
					} else {
						$bk = $bk_winter;
					}
				}

				if($db->f("seizoen_id")) {
					$temp_seizoen_id = $db->f("seizoen_id");
				} else {
					if(!$bk_seizoen_id or $vars["websitetype"]==6) {
						if($vars["themainfo"]["tarievenbekend_seizoen_id"]) {
							$bk_seizoen_id = $vars["themainfo"]["tarievenbekend_seizoen_id"];
						} else {
							# Chaletsinvallandry.nl
							if( $vars["websitetype"]==6 ) {
								$db0->query("SELECT seizoen_id FROM seizoen WHERE type IN (".intval($db->f("wzt")).") AND tonen=3 AND eind>NOW() ORDER BY seizoen_id LIMIT 0,1;");
							} else {
								$db0->query("SELECT seizoen_id FROM seizoen WHERE type IN (".$vars["seizoentype"].") AND tonen=3 AND eind>NOW() ORDER BY seizoen_id LIMIT 0,1;");
							}

							if($db0->next_record()) {
								$bk_seizoen_id = $db0->f("seizoen_id");
							}
						}
					}
					$temp_seizoen_id = $bk_seizoen_id;
				}

				if($db->f("toonper")==1) {
					// arrangement
					$temp_aantalpersonen = ($_GET["fap"] ? $_GET["fap"] : $db->f("maxaantalpersonen"));
					$bk_add_to_price = $bk[$db->f("type_id")][$temp_seizoen_id][$temp_aantalpersonen] / $temp_aantalpersonen;
				} else {
					// losse accommodatie
					$temp_aantalpersonen = ($_GET["fap"] ? $_GET["fap"] : 1);
					$bk_add_to_price = $bk[$db->f("type_id")][$temp_seizoen_id][$temp_aantalpersonen];

					// surcharge extra persons
					if($_GET["fap"] and $_GET["fad"] and $bk_all_persons[$db->f("type_id")][$_GET["fad"]]) {
						$bk_add_to_price += $bk_all_persons[$db->f("type_id")][$_GET["fad"]];
					}
				}

				$bk_used_seizoen_id[$db->f("type_id")] = $temp_seizoen_id;


				if($bk_add_to_price>0) {
					if( $tarief_from_cache and $table_name_cache_vanafprijs == "cache_vanafprijs_incl_bkk_type" ) {

					} else {
						$tarief = $tarief + $bk_add_to_price;
					}
					$tarief = ceil($tarief);
				}


				$tarief_float=$tarief;
				$tarief=number_format($tarief,0,",",".");
			}

			$accommodatie_opnemen_in_resultaten=true;

			# Prijsklasse: accommodaties lager dan van-prijs uitsluiten
			if($_GET["fpk_van"]) {
				if(!$tarief_float) {
					$accommodatie_opnemen_in_resultaten=false;
				}
				if($tarief_float<$_GET["fpk_van"]) {
					$accommodatie_opnemen_in_resultaten=false;
				}
			}

			# Prijsklasse: accommodaties hoger dan tot-prijs uitsluiten
			if($_GET["fpk_tot"] and !$_GET["fpk_enmeer"]) {
				if(!$tarief_float) {
					$accommodatie_opnemen_in_resultaten=false;
				}
				if($tarief_float>$_GET["fpk_tot"]) {
					$accommodatie_opnemen_in_resultaten=false;
				}
			}

			// bij aanbiedingenzoekopdracht: resultaat overslaan indien geen aanbieding
			if( $_GET["faab"] and !$soort_aanbieding and ($_GET["fad"]>0 or $flex_aankomstdatum) ) {
				$accommodatie_opnemen_in_resultaten = false;
			}

			if($accommodatie_opnemen_in_resultaten) {

				#
				#
				# "Verfijn je zoekopdracht" - aantallen bepalen
				#
				#

				# Aantal badkamers - aantalbadkamers
				if($db->f("badkamers")>=2) {
					$verfijnd["aantalbadkamers"][1]++;
				}
				if($db->f("badkamers")>=3) {
					$verfijnd["aantalbadkamers"][2]++;
				}
				if($db->f("badkamers")>=4) {
					$verfijnd["aantalbadkamers"][3]++;
				}
				if($db->f("badkamers")>=5) {
					$verfijnd["aantalbadkamers"][4]++;
				}
				if($db->f("badkamers")>=6) {
					$verfijnd["aantalbadkamers"][5]++;
				}
				if($db->f("badkamers")>=8) {
					$verfijnd["aantalbadkamers"][6]++;
				}
				if($db->f("badkamers")>=10) {
					$verfijnd["aantalbadkamers"][7]++;
				}

				# Afstand vanaf Utrecht
				if($vars["websitetype"]==7) {
					# andere keuzes bij Italissima
					if($db->f("afstandtotutrecht")>0 and $db->f("afstandtotutrecht")<=1250) {
						$verfijnd["afstandvanafutrecht"][1]++;
					} elseif($db->f("afstandtotutrecht")>1250 and $db->f("afstandtotutrecht")<=1500) {
						$verfijnd["afstandvanafutrecht"][2]++;
					} elseif($db->f("afstandtotutrecht")>1500) {
						$verfijnd["afstandvanafutrecht"][3]++;
					}
				} else {
					if($db->f("afstandtotutrecht")>0 and $db->f("afstandtotutrecht")<=600) {
						$verfijnd["afstandvanafutrecht"][1]++;
					} elseif($db->f("afstandtotutrecht")>600 and $db->f("afstandtotutrecht")<=1000) {
						$verfijnd["afstandvanafutrecht"][2]++;
					} elseif($db->f("afstandtotutrecht")>1000 and $db->f("afstandtotutrecht")<=1500) {
						$verfijnd["afstandvanafutrecht"][3]++;
					} elseif($db->f("afstandtotutrecht")>1500) {
						$verfijnd["afstandvanafutrecht"][4]++;
					}
				}

				if($vars["seizoentype"]==1) {

					#
					# Winter
					#

					# Afstand tot piste - afstandtotpiste
					if($db->f("afstandpiste")<>"" and $db->f("afstandpiste")<=50) {
						$verfijnd["afstandtotpiste"][1]++;
					}
					if($db->f("afstandpiste")<>"" and $db->f("afstandpiste")<=250) {
						$verfijnd["afstandtotpiste"][2]++;
					}
					if($db->f("afstandpiste")<>"" and $db->f("afstandpiste")<=500) {
						$verfijnd["afstandtotpiste"][3]++;
					}
					if($db->f("afstandpiste")<>"" and $db->f("afstandpiste")<=1000) {
						$verfijnd["afstandtotpiste"][4]++;
					}

					# Kilometer piste - aantalkmpiste
					if($db->f("kilometerpiste")<>"" and $db->f("kilometerpiste")<100) {
						$verfijnd["aantalkmpiste"][1]++;
					}
					if($db->f("kilometerpiste")<>"" and $db->f("kilometerpiste")>=100) {
						$verfijnd["aantalkmpiste"][2]++;
					}
					if($db->f("kilometerpiste")<>"" and $db->f("kilometerpiste")>=200) {
						$verfijnd["aantalkmpiste"][3]++;
					}
					if($db->f("kilometerpiste")<>"" and $db->f("kilometerpiste")>=400) {
						$verfijnd["aantalkmpiste"][4]++;
					}

					# Verfijnd zoeken: faciliteiten

					# Verfijnd zoeken: catering
					if(check_kenmerken($db->f("tkenmerken"),1) or check_kenmerken($db->f("akenmerken"),1)) {
						$verfijnd["kenmerken"][2]++;
					}

					# Verfijnd zoeken: zwembad
					if(check_kenmerken($db->f("tkenmerken"),4) or check_kenmerken($db->f("akenmerken"),4) or check_kenmerken($db->f("akenmerken"),11)) {
						$verfijnd["kenmerken"][3]++;
					}

					# Verfijnd zoeken: sauna
					if(check_kenmerken($db->f("tkenmerken"),3) or check_kenmerken($db->f("akenmerken"),3) or check_kenmerken($db->f("akenmerken"),10)) {
						$verfijnd["kenmerken"][4]++;
					}

					# Verfijnd zoeken: privesauna
					if(check_kenmerken($db->f("tkenmerken"),3) or check_kenmerken($db->f("akenmerken"),3)) {
						$verfijnd["kenmerken"][5]++;
					}

					# Verfijnd zoeken: huisdierentoegestaan
					if(check_kenmerken($db->f("tkenmerken"),11) or check_kenmerken($db->f("akenmerken"),13)) {
						$verfijnd["kenmerken"][6]++;
					}

					# Verfijnd zoeken: openhaardhoutkachel
					if(check_kenmerken($db->f("tkenmerken"),10) or check_kenmerken($db->f("akenmerken"),12)) {
						$verfijnd["kenmerken"][7]++;
					}

					# Verfijnd zoeken: goedvoorkids
					if(check_kenmerken($db->f("tkenmerken"),5) or check_kenmerken($db->f("akenmerken"),5)) {
						$verfijnd["kenmerken"][43]++;
					}

					#
					# Verfijn zoeken: soortaccommodatie
					#
					if($db->f("soortaccommodatie")==1) {
						# chalet
						$verfijnd["soortaccommodatie"][39]++;
					}
					if($db->f("soortaccommodatie")==2) {
						# appartement
						$verfijnd["soortaccommodatie"][41]++;
					}
					if($db->f("soortaccommodatie")==3) {
						# hotel
						$verfijnd["soortaccommodatie"][42]++;
					}
					if($db->f("soortaccommodatie")==4) {
						# chaletappartement
						$verfijnd["soortaccommodatie"][40]++;
					}

					#
					# Verfijn zoeken: thema's (winter)
					#
					if(check_kenmerken($db->f("pkenmerken"),13)) {
						# charmante skidorpen
						$verfijnd["kenmerken"][44]++;
					}
					if(check_kenmerken($db->f("pkenmerken"),6)) {
						# 10 voor apres ski
						$verfijnd["kenmerken"][45]++;
					}
					if(check_kenmerken($db->f("pkenmerken"),14)) {
						# super ski-stations
						$verfijnd["kenmerken"][47]++;
					}

					if(check_kenmerken($db->f("tkenmerken"),9) or check_kenmerken($db->f("akenmerken"),9)) {
						# winter-wellness
						$verfijnd["kenmerken"][46]++;
					}

					# Verfijnd zoeken: internet/Wi-Fi
					if(check_kenmerken($db->f("tkenmerken"),20) or check_kenmerken($db->f("tkenmerken"),22) or check_kenmerken($db->f("akenmerken"),21) or check_kenmerken($db->f("akenmerken"),23)) {
						$verfijnd["kenmerken"][50]++;
					}


				} else {

					#
					# Zomer
					#

					# Verfijnd zoeken: zwemwater
					if(check_kenmerken($db->f("akenmerken"),16) or check_kenmerken($db->f("pkenmerken"),7)) {
						$verfijnd["kenmerken"][1]++;
					}

					# Verfijnd zoeken: golfbaan
					if(check_kenmerken($db->f("akenmerken"),2) or check_kenmerken($db->f("pkenmerken"),6)) {
						$verfijnd["kenmerken"][2]++;
					}

					# Verfijnd zoeken: tennisbaan op max. 10 km
					if(check_kenmerken($db->f("akenmerken"),29) or check_kenmerken($db->f("akenmerken"),19)) {
						$verfijnd["kenmerken"][3]++;
					}

					# Verfijnd zoeken: paardrijden
					if(check_kenmerken($db->f("akenmerken"),31)) {
						$verfijnd["kenmerken"][4]++;
					}

					# Verfijnd zoeken: in de bergen
					if(check_kenmerken($db->f("akenmerken"),1) or check_kenmerken($db->f("pkenmerken"),5) or check_kenmerken($db->f("skenmerken"),4)) {
						$verfijnd["kenmerken"][5]++;
					}

					# Verfijnd zoeken: wijnstreek
					if(check_kenmerken($db->f("akenmerken"),20) or check_kenmerken($db->f("pkenmerken"),9) or check_kenmerken($db->f("skenmerken"),6)) {
						$verfijnd["kenmerken"][6]++;
					}

					# Verfijnd zoeken: vakantiepark
					if(check_kenmerken($db->f("akenmerken"),24)) {
						$verfijnd["kenmerken"][7]++;
					}

					# Verfijnd zoeken: centrum op loopafstand
					if(check_kenmerken($db->f("akenmerken"),39)) {
						$verfijnd["kenmerken"][36]++;
					}

					# Verfijnd zoeken: zwembad
					if(check_kenmerken($db->f("akenmerken"),11)) {
						$verfijnd["kenmerken"][8]++;
					}

					# Verfijnd zoeken: tennisbaan
					if(check_kenmerken($db->f("akenmerken"),19)) {
						$verfijnd["kenmerken"][9]++;
					}

					# Verfijnd zoeken: speeltoestellen
					if(check_kenmerken($db->f("akenmerken"),26)) {
						$verfijnd["kenmerken"][10]++;
					}

					# Verfijnd zoeken: wasmachine
					if(check_kenmerken($db->f("tkenmerken"),18) or check_kenmerken($db->f("akenmerken"),32)) {
						$verfijnd["kenmerken"][11]++;
					}

					# Verfijnd zoeken: restaurant
					if(check_kenmerken($db->f("akenmerken"),40)) {
						$verfijnd["kenmerken"][37]++;
					}


					# Verfijnd zoeken: tuin/terras
					if(check_kenmerken($db->f("tkenmerken"),20) or check_kenmerken($db->f("akenmerken"),34)) {
						$verfijnd["kenmerken"][49]++;
					}

					# Verfijnd zoeken: internet/Wi-Fi
					if(check_kenmerken($db->f("tkenmerken"),22) or check_kenmerken($db->f("tkenmerken"),24) or check_kenmerken($db->f("akenmerken"),36) or check_kenmerken($db->f("akenmerken"),42)) {
						$verfijnd["kenmerken"][50]++;
					}

					# Verfijnd zoeken: vrijstaand huis
					if(check_kenmerken($db->f("tkenmerken"),2) or check_kenmerken($db->f("akenmerken"),22)) {
						$verfijnd["kenmerken"][12]++;
					}

					# Verfijnd zoeken: vrijstaand huis, met meerdere huizen
					if(check_kenmerken($db->f("tkenmerken"),15) or check_kenmerken($db->f("akenmerken"),27)) {
						$verfijnd["kenmerken"][13]++;
					}

					# Verfijnd zoeken: geschakelde woning/appartement
					if(check_kenmerken($db->f("tkenmerken"),14) or check_kenmerken($db->f("akenmerken"),23)) {
						$verfijnd["kenmerken"][14]++;
					}

					# Verfijnd zoeken: kleinschaligvakantiepark
					if(check_kenmerken($db->f("akenmerken"),24)) {
						$verfijnd["kenmerken"][48]++;
					}

					# Verfijnd zoeken: appartement (veld soortaccommodatie)
					if($db->f("soortaccommodatie")==2) {
						$verfijnd["kenmerken"][51]++;
					}

					# Verfijnd zoeken: vakantiehuis (veld soortaccommodatie)
					if($db->f("soortaccommodatie")==6) {
						$verfijnd["kenmerken"][52]++;
					}

					# Verfijnd zoeken: villa (veld soortaccommodatie)
					if($db->f("soortaccommodatie")==7) {
						$verfijnd["kenmerken"][53]++;
					}

					# Verfijnd zoeken: kasteel (veld soortaccommodatie)
					if($db->f("soortaccommodatie")==8) {
						$verfijnd["kenmerken"][54]++;
					}

					# Verfijnd zoeken: vakantiepark (veld soortaccommodatie)
					if($db->f("soortaccommodatie")==9) {
						$verfijnd["kenmerken"][55]++;
					}

					# Verfijnd zoeken: agriturismo (veld soortaccommodatie + akenmerken==41)
					if($db->f("soortaccommodatie")==10 or check_kenmerken($db->f("akenmerken"),41)) {
						$verfijnd["kenmerken"][56]++;
					}

					# Verfijnd zoeken: domein (veld soortaccommodatie)
					if($db->f("soortaccommodatie")==11) {
						$verfijnd["kenmerken"][57]++;
					}

					# Verfijnd zoeken: vrijstaand
					if(check_kenmerken($db->f("tkenmerken"),2) or check_kenmerken($db->f("tkenmerken"),15) or check_kenmerken($db->f("akenmerken"),22) or check_kenmerken($db->f("akenmerken"),27)) {
						$verfijnd["kenmerken"][58]++;
					}

					# Verfijnd zoeken: privé-terras
					if(check_kenmerken($db->f("tkenmerken"),17) or check_kenmerken($db->f("akenmerken"),30)) {
						$verfijnd["kenmerken"][15]++;
					}

					# Verfijnd zoeken: balkon
					if(check_kenmerken($db->f("tkenmerken"),19) or check_kenmerken($db->f("tkenmerken"),20) or check_kenmerken($db->f("akenmerken"),33) or check_kenmerken($db->f("akenmerken"),34)) {
						$verfijnd["kenmerken"][16]++;
					}

					# Verfijnd zoeken: balkon of terras
					if(check_kenmerken($db->f("tkenmerken"),20) or check_kenmerken($db->f("akenmerken"),34)) {
						$verfijnd["kenmerken"][17]++;
					}

					# Verfijnd zoeken: privé-zwembad
					if(check_kenmerken($db->f("tkenmerken"),4) or check_kenmerken($db->f("akenmerken"),4)) {
						$verfijnd["kenmerken"][18]++;
					}

					# Verfijnd zoeken: huisdieren toegestaan
					if(check_kenmerken($db->f("tkenmerken"),11) or check_kenmerken($db->f("akenmerken"),13)) {
						$verfijnd["kenmerken"][19]++;
					}

					# Verfijnd zoeken: huisdieren niet toegestaan
					if(check_kenmerken($db->f("tkenmerken_nee"),11) or check_kenmerken($db->f("akenmerken_nee"),13)) {
						$verfijnd["kenmerken"][20]++;
					}

					# Verfijnd zoeken: thema goed voor kids
					if(check_kenmerken($db->f("tkenmerken"),5) or check_kenmerken($db->f("akenmerken"),5)) {
						$verfijnd["kenmerken"][21]++;
					}

					# Verfijnd zoeken: thema bijzonder
					if(check_kenmerken($db->f("tkenmerken"),16) or check_kenmerken($db->f("akenmerken"),28)) {
						$verfijnd["kenmerken"][22]++;
					}

					# Verfijnd zoeken: thema vleugje welness
					if(check_kenmerken($db->f("akenmerken"),9) or check_kenmerken($db->f("skenmerken"),3)) {
						$verfijnd["kenmerken"][24]++;
					}

					# Verfijnd zoeken: thema top selectie
					if(check_kenmerken($db->f("tkenmerken"),8) or check_kenmerken($db->f("akenmerken"),8) or check_kenmerken($db->f("pkenmerken"),3)) {
						$verfijnd["kenmerken"][25]++;
					}

					# Verfijnd zoeken: thema voordelig weg
					if(check_kenmerken($db->f("tkenmerken"),7) or check_kenmerken($db->f("akenmerken"),7) or check_kenmerken($db->f("pkenmerken"),2) or check_kenmerken($db->f("skenmerken"),2)) {
						$verfijnd["kenmerken"][26]++;
					}

					# Verfijnd zoeken: thema huisje voor 2
					if(check_kenmerken($db->f("tkenmerken"),1) or check_kenmerken($db->f("akenmerken"),18)) {
						$verfijnd["kenmerken"][27]++;
					}

					# Verfijnd zoeken: thema met z'n allen
					if(check_kenmerken($db->f("tkenmerken"),6) or check_kenmerken($db->f("akenmerken"),6)) {
						$verfijnd["kenmerken"][28]++;
					}

					# Verfijnd zoeken: thema greenfeeproof
					if(check_kenmerken($db->f("akenmerken"),2) or check_kenmerken($db->f("pkenmerken"),6)) {
						$verfijnd["kenmerken"][29]++;
					}

					# Verfijnd zoeken: thema actief in de bergen
					if(check_kenmerken($db->f("akenmerken"),1) or check_kenmerken($db->f("pkenmerken"),5) or check_kenmerken($db->f("skenmerken"),4)) {
						$verfijnd["kenmerken"][30]++;
					}

					# Verfijnd zoeken: thema stekje bij het water
					if(check_kenmerken($db->f("akenmerken"),16)) {
						$verfijnd["kenmerken"][31]++;
					}

					# Verfijnd zoeken: thema huisje met zwembad
					if(check_kenmerken($db->f("tkenmerken"),4) or check_kenmerken($db->f("akenmerken"),4) or check_kenmerken($db->f("akenmerken"),11)) {
						$verfijnd["kenmerken"][32]++;
					}

					# Verfijnd zoeken: thema vakantieparken
					if(check_kenmerken($db->f("akenmerken"),24)) {
						$verfijnd["kenmerken"][33]++;
					}

					# Verfijnd zoeken: thema boerderij
					if(check_kenmerken($db->f("akenmerken"),25)) {
						$verfijnd["kenmerken"][34]++;
					}

					# Verfijnd zoeken: thema boerderij
					if(check_kenmerken($db->f("akenmerken"),37)) {
						$verfijnd["kenmerken"][35]++;
					}
				}




				# min en max-bedragen bepalen
				if($tarief_float>$prijsklasse_max_beschikbaar) $prijsklasse_max_beschikbaar=$tarief_float;

				# Zoekvolgorde-categorie (1=hoogst, 5=laagst)
				$zoekvolgorde=$db->f("lzoekvolgorde");
				if($db->f("azoekvolgorde")<>3) $zoekvolgorde=$db->f("azoekvolgorde");
				if($db->f("tzoekvolgorde")<>3) $zoekvolgorde=$db->f("tzoekvolgorde");

				# Zoeken op kaart: GPS-gegevens bepalen + $zoeken_op_kaart_data vullen
				if($vars["zoeken_op_kaart"]) {
					if(($db->f("gps_lat")<>"" and $db->f("gps_long")<>"") or ($db->f("tgps_lat")<>"" and $db->f("tgps_long")<>"")) {
						if(($db->f("tgps_lat")<>"" and $db->f("tgps_long")<>"")) {
							$gps_lat=$db->f("tgps_lat");
							$gps_long=$db->f("tgps_long");
						} else {
							$gps_lat=$db->f("gps_lat");
							$gps_long=$db->f("gps_long");
						}
						unset($temp_afbeelding);
						# afbeelding bepalen
						if ( file_exists( "pic/cms/types_specifiek/".$db->f( "type_id" ).".jpg" ) ) {
							$temp_afbeelding=imageurl( "types_specifiek/".$db->f( "type_id" ).".jpg", 170, 127 );
						} elseif ( file_exists( "pic/cms/accommodaties/".$db->f( "accommodatie_id" ).".jpg" ) ) {
							$temp_afbeelding=imageurl( "accommodaties/".$db->f( "accommodatie_id" ).".jpg", 170, 127 );
						}

						# kijken of er al een accommodatie op deze GPS-coordinaten aanwezig is
						$use_key=$gps_lat."_".$gps_long;
						if($zoeken_op_kaart_data[$use_key]) {
							# Alleen overschrijven indien het om dezelfde accommodatie_id gaat
							if($zoeken_op_kaart_data[$use_key]["accommodatie_id"]==$db->f("accommodatie_id") or $zoeken_op_kaart_data[$use_key]["naamaccommodatie"]==$db->f("naam")) {

								# naam: alleen accommodatienaam (zonder typenaam)
								$zoeken_op_kaart_data[$use_key]["naamhtml"]=ucfirst($vars["soortaccommodatie"][$db->f("soortaccommodatie")])." ".$db->f("naam");

								# aantal personen min/max bepalen
								if($db->f("optimaalaantalpersonen")<$zoeken_op_kaart_data[$use_key]["optimaalaantalpersonen"]) {
									$zoeken_op_kaart_data[$use_key]["optimaalaantalpersonen"]=$db->f("optimaalaantalpersonen");
								}
								if($db->f("maxaantalpersonen")>$zoeken_op_kaart_data[$use_key]["maxaantalpersonen"]) {
									$zoeken_op_kaart_data[$use_key]["maxaantalpersonen"]=$db->f("maxaantalpersonen");
								}

								$zoeken_op_kaart_data[$use_key]["accommodatie_id"]=$db->f("accommodatie_id");

								if($tarief_float>0 and floatval($tarief_float)<$zoeken_op_kaart_data[$use_key]["tarief"]) {
									# tarief: goedkoopste tonen
									$zoeken_op_kaart_data[$use_key]["tarief"]=floatval($tarief_float);
									$zoeken_op_kaart_data[$use_key]["toonper"]=$db->f("toonper");
									$zoeken_op_kaart_data[$use_key]["vanaf"]=true;
									$zoeken_op_kaart_data[$use_key]["url"]=$vars["path"].txt("menu_accommodatie")."/".$db->f("begincode").$db->f("type_id")."/";
									$zoeken_op_kaart_data[$use_key]["afbeelding"]=$temp_afbeelding;

									if($db->f("tkwaliteit") && $db->f("tkwaliteit")!=0) {
										$zoeken_op_kaart_data[$use_key]["kwaliteit"]=(int)$db->f("tkwaliteit");
									} elseif($db->f("akwaliteit") && $db->f("akwaliteit")!=0) {
										$zoeken_op_kaart_data[$use_key]["kwaliteit"]=(int)$db->f("akwaliteit");
									}

									if($db->f("tkorteomschrijving") && $db->f("tkorteomschrijving")!='') {
										$zoeken_op_kaart_data[$use_key]["omschrijving"]=$db->f("tkorteomschrijving");
									} elseif($db->f("korteomschrijving") && $db->f("korteomschrijving")!=null) {
										$zoeken_op_kaart_data[$use_key]["omschrijving"]=$db->f("korteomschrijving");
									}

								} elseif(floatval($tarief_float)>$zoeken_op_kaart_data[$use_key]["tarief"]) {
									# bij meerdere tarieven: vanaf tonen
									$zoeken_op_kaart_data[$use_key]["vanaf"]=true;
								}
							} else {
								// trigger_error("FOUT accommodatie: I".$db->f("type_id")." overschrijft ".$zoeken_op_kaart_data[$use_key]["url"],E_USER_NOTICE);
								// echo "<br><br>";
							}
						} else {
							$zoeken_op_kaart_data[$use_key]["gps_lat"]=$gps_lat;
							$zoeken_op_kaart_data[$use_key]["gps_long"]=$gps_long;
							$zoeken_op_kaart_data[$use_key]["optimaalaantalpersonen"]=$db->f("optimaalaantalpersonen");
							$zoeken_op_kaart_data[$use_key]["maxaantalpersonen"]=$db->f("maxaantalpersonen");
							$zoeken_op_kaart_data[$use_key]["plaatsland"]=$db->f("plaats").", ".$db->f("skigebied");
							$zoeken_op_kaart_data[$use_key]["naamhtml"]=trim(ucfirst($vars["soortaccommodatie"][$db->f("soortaccommodatie")])." ".$db->f("naam")." ".$db->f("tnaam"));
							$zoeken_op_kaart_data[$use_key]["afbeelding"]=$temp_afbeelding;
							$zoeken_op_kaart_data[$use_key]["url"]=$vars["path"].txt("menu_accommodatie")."/".$db->f("begincode").$db->f("type_id")."/";
							if($tarief_float>0) {
								$zoeken_op_kaart_data[$use_key]["tarief"]=floatval($tarief_float);
								$zoeken_op_kaart_data[$use_key]["toonper"]=$db->f("toonper");
							}
							$zoeken_op_kaart_data[$use_key]["accommodatie_id"]=$db->f("accommodatie_id");
							$zoeken_op_kaart_data[$use_key]["naamaccommodatie"]=$db->f("naam");
							if($vanaf_prijzen_tonen) {
								$zoeken_op_kaart_data[$use_key]["vanaf"]=true;
							}

							if($db->f("tkwaliteit") && $db->f("tkwaliteit")!=0) {
								$zoeken_op_kaart_data[$use_key]["kwaliteit"]=(int)$db->f("tkwaliteit");
							} elseif($db->f("akwaliteit") && $db->f("akwaliteit")!=0) {
								$zoeken_op_kaart_data[$use_key]["kwaliteit"]=(int)$db->f("akwaliteit");
							}

							if($db->f("tkorteomschrijving") && $db->f("tkorteomschrijving")!='') {
								$zoeken_op_kaart_data[$use_key]["omschrijving"]=$db->f("tkorteomschrijving");
							} elseif($db->f("korteomschrijving") && $db->f("korteomschrijving")!=null) {
								$zoeken_op_kaart_data[$use_key]["omschrijving"]=$db->f("korteomschrijving");
							}

						}

						$gps_lat=floatval($gps_lat);
						$gps_long=floatval($gps_long);
						if($gps_lat>$gps_lat_max or !isset($gps_lat_max)) $gps_lat_max=$gps_lat;
						if($gps_lat<$gps_lat_min or !isset($gps_lat_min)) $gps_lat_min=$gps_lat;
						if($gps_long>$gps_long_max or !isset($gps_long_max)) $gps_long_max=$gps_long;
						if($gps_long<$gps_long_min or !isset($gps_long_min)) $gps_long_min=$gps_long;

						$zoeken_op_kaart=true;
					}
				}


				#
				# Sorteersysteem
				#
				unset($sorteer);

				# Sorteren op gekoppelde skigebieden
				if($koppeling[$db->f("skigebied_id")]) {
					$sorteer.=$koppeling[$db->f("skigebied_id")];
				}

				# Sortering SuperSki: altijd op prijs
				if($vars["websitetype"]==8) {
					$_GET["sort"]=2;
				}

				if($_GET["sort"]==1 or !$_GET["sort"]) {
					# standaard-sortering

					# Sorteren in geval van tekst-zoeken
					if($_GET["fzt"]) {
						$temp_naam_acc=trim(strtolower(wt_stripaccents($db->f("naam")." ".$db->f("tnaam"))));
						if($temp_naam_acc==strtolower(wt_stripaccents($_GET["fzt"]))) {
							# zoektekst is exacte de naam van accommodatie/type
							$sorteer.="1";
						} elseif(substr($temp_naam_acc,0,strlen($_GET["fzt"]))==strtolower(wt_stripaccents($_GET["fzt"]))) {
							# zoektekst begint met de naam van accommodatie/type
							$sorteer.="2";
						} elseif(strpos(" ".$temp_naam_acc,strtolower(wt_stripaccents($_GET["fzt"])))) {
							# zoektekst komt in naam accommodatie/type voor
							$sorteer.="3";
						} else {
							$sorteer.="9";
						}
					}

					# accommodaties zonder tarief: onderaan
					if($vanaf_prijzen_tonen) {
						if($tarief_float>0) {
							$sorteer.="1";
						} else {
							$sorteer.="9";
						}
					}

					# Nieuwe zoekmarge
					# Komt het aantal personen goed overeen met waar de bezoeker om vraagt?
					if($_GET["fap"]) {

						if($_GET["fap"]>20) {
							$min_zoekmarge=$_GET["fap"];
							$max_zoekmarge=50;
						} else {
							$min_zoekmarge=$_GET["fap"];
							$max_zoekmarge=$vars["optimaalmaxpersonen"][$_GET["fap"]];
						}

						if($db->f("optimaalaantalpersonen")>=$min_zoekmarge and $db->f("maxaantalpersonen")<=$max_zoekmarge) {
							$sorteer.="22-";
						} else {
							$sorteer.="88-";
						}
					}
					if($prijsperaccommodatie) {
						# zorgen dat "per accommodatie" onderaan komt (zodat arrangementen bovenaan komen)
						$sorteer.="ZZZ";
					} else {
						$sorteer.="AAA";
					}
					$sorteer.=$zoekvolgorde."-";
				} elseif($_GET["sort"]==2) {
					# prijs oplopend

					# accommodaties zonder tarief: onderaan
					if($vanaf_prijzen_tonen) {
						if($tarief_float>0) {
							$sorteer.="1";
						} else {
							$sorteer.="9";
						}
					}

					$sorteer.=substr("0000000".number_format($tarief_float,2,"",""),-7)."-";
				} elseif($_GET["sort"]==3) {
					# prijs aflopend

					# accommodaties zonder tarief: onderaan
					if($vanaf_prijzen_tonen) {
						if($tarief_float>0) {
							$sorteer.="1";
						} else {
							$sorteer.="9";
						}
					}

					$sorteer.=1000000-$tarief_float;
				}
				# ook nog altijd relevantie toevoegen
				$sorteer.=$zoekvolgorde."-";

				# Ook nog sorteren op skigebied, plaats, naam accommodatie, maxaantal personen, type_id
				$sorteer.=$db->f("skigebied")."-".$db->f("plaats")."-".$db->f("naam")."-".sprintf("%03d",$db->f("maxaantalpersonen"))."-".$db->f("type_id");


				# Sorteren op skigebied, plaats, naam accommodatie, maxaantal personen, type_id
				$sorteer.=$db->f("skigebied")."-".$db->f("plaats")."-".$db->f("naam")."-".sprintf("%03d",$db->f("maxaantalpersonen"))."-".$db->f("type_id");

				# Sorteerscore gekoppelde skigebieden
				if($koppeling[$db->f("skigebied_id")]) {
					$sorteerscore_skigebied[$sorteer]=intval($koppeling[$db->f("skigebied_id")]);
				}

				if($gekozen_skigebied) {
					if($db->f("skigebied_id")==$gekozen_skigebied) {
						$aantalresultaten_zonder_gekoppeld_skigebied++;
					}
				} else {
					$aantalresultaten_zonder_gekoppeld_skigebied++;
				}

				unset($urltoevoeging);

				$zoekresultatenteller++;

				# Toonper opslaan
				$toonper[$sorteer]=$db->f("toonper");

				unset($trclass);
				if($voorkant_cms) {
					if($db->f("voorraad_garantie")) {
						$trcolor="#00FF00";
						$trclass="zoekresultaat_voorraad_garantie";
					} elseif($db->f("voorraad_allotment")) {
						$trcolor="#CCFFCC";
						$trclass="zoekresultaat_voorraad_allotment";
					} elseif($db->f("voorraad_optie_leverancier")) {
						$trcolor="#CCFFCC";
						$trclass="zoekresultaat_voorraad_optie_leverancier";
					} elseif($db->f("voorraad_xml")) {
						$trcolor="#FF99CC";
						$trclass="zoekresultaat_voorraad_xml";
					} elseif($db->f("voorraad_vervallen_allotment")) {
						$trcolor="#F88912";
						$trclass="zoekresultaat_voorraad_vervallen_allotment";
					} elseif($db->f("voorraad_request")) {
						$trcolor="#FFCC99";
						$trclass="zoekresultaat_voorraad_request";
					} elseif($db->f("voorraad_optie_klant")) {
						$trcolor="#CCFFFF";
						$trclass="zoekresultaat_voorraad_optie_klant";
					} else {
						$trcolor="#FFFFFF";
					}
				}
				unset($trclass_vallandry);
				if($vars["websitetype"]==6 and $id=="zoek-en-boek" and (!$trcolor or $trcolor=="#FFFFFF" or !$voorkant_cms)) {
					# Achtergrondkleur Chaletsinvallandry
					if($db->f("wzt")==1) {
						# winterkleur
						$trclass_vallandry="zoekresultaat_winter";
					} elseif($db->f("wzt")==2) {
						# zomerkleur
						$trclass_vallandry="zoekresultaat_zomer";
					}
					$trcolor="";
				}

				#
				# Daadwerkelijke zoekresultaten-html samenstellen
				#

				if($db->f("apart_tonen_in_zoekresultaten")) {
					$accid=$db->f("accommodatie_id")."_".$db->f("type_id");
				} else {
					$accid=$db->f("accommodatie_id");
				}
				$newresults_acc[$sorteer]=$accid;


				# sorteren types binnen de accommodatie bepalen
				unset($acc_sorteer);
				if($tarief_float>0) {
					$tarief_sorteer=$tarief_float;
					$acc_sorteer.="1";
				} else {
					$tarief_sorteer="99999999";
					$acc_sorteer.="9";
				}
	#			$acc_sorteer=substr("0000000000".number_format($tarief_sorteer,2,"",""),-10)."_".substr("0000".$db->f("optimaalaantalpersonen"),-4)."_".substr("0000".$db->f("maxaantalpersonen"),-4)."_".$db->f("type_id");

				$acc_sorteer.=substr("0000".$db->f("optimaalaantalpersonen"),-4)."_".substr("0000".$db->f("maxaantalpersonen"),-4)."_".substr("0000000000".number_format($tarief_sorteer,2,"",""),-10)."_".$db->f("type_id");

				$newresults[$accid][$acc_sorteer]["type_id"]=$db->f("type_id");
				$newresults[$accid][$acc_sorteer]["accommodatie_id"]=$db->f("accommodatie_id");
				$newresults[$accid][$acc_sorteer]["begincode"]=$db->f("begincode");
				$newresults[$accid][$acc_sorteer]["naam"]=$db->f("naam");
				$newresults[$accid][$acc_sorteer]["tnaam"]=$db->f("tnaam");
				$newresults[$accid][$acc_sorteer]["soortaccommodatie"]=$db->f("soortaccommodatie");
				$newresults[$accid][$acc_sorteer]["slaapkamers"]=$db->f("slaapkamers");
				$newresults[$accid][$acc_sorteer]["badkamers"]=$db->f("badkamers");
				$newresults[$accid][$acc_sorteer]["optimaalaantalpersonen"]=$db->f("optimaalaantalpersonen");
				$newresults[$accid][$acc_sorteer]["maxaantalpersonen"]=$db->f("maxaantalpersonen");
				$newresults[$accid][$acc_sorteer]["plaats"]=$db->f("plaats");
				$newresults[$accid][$acc_sorteer]["skigebied"]=$db->f("skigebied");
				$newresults[$accid][$acc_sorteer]["land"]=$db->f("land");
				$newresults[$accid][$acc_sorteer]["korteomschrijving"]=$db->f("korteomschrijving");
				$newresults[$accid][$acc_sorteer]["tkorteomschrijving"]=$db->f("tkorteomschrijving");
				$newresults[$accid][$acc_sorteer]["toonper"]=$db->f("toonper");
				$newresults[$accid][$acc_sorteer]["skigebied_id"]=$db->f("skigebied_id");
				$newresults[$accid][$acc_sorteer]["tarief"]=$tarief_float;

                if (!isset($imageIds)) {
                    $imageIds = ['a' => [], 't' => []];
                }

                $imageIds['a'][(int)$db->f('accommodatie_id')] = true;
                $imageIds['t'][(int)$db->f('type_id')]         = true;

				if($tarief) {
					$tarieven_tonen=true;
				}
				# aanbieding van toepassing?
				if($soort_aanbieding or ($_GET["aab"] and $_GET["faab"])) {
					$newresults[$accid][$acc_sorteer]["aanbieding"]=true;
					$newresults[$accid][$acc_sorteer]["type_id_aanbieding"]=true;
				}

				if($trclass) {
					$newresults[$accid][$acc_sorteer]["type_id_trclass"]=trim($trclass);
				}

				# min en max aantallen bepalen
	#			if(!$newresultsminmax[$accid]["minpersonen"] or $newresultsminmax[$accid]["minpersonen"]>$db->f("optimaalaantalpersonen")) $newresultsminmax[$accid]["minpersonen"]=$db->f("optimaalaantalpersonen");
	#			if($newresultsminmax[$accid]["maxpersonen"]<$db->f("maxaantalpersonen")) $newresultsminmax[$accid]["maxpersonen"]=$db->f("maxaantalpersonen");

	#			if(!$newresultsminmax[$accid]["minslaapkamers"] or $newresultsminmax[$accid]["minslaapkamers"]>$db->f("slaapkamers")) $newresultsminmax[$accid]["minslaapkamers"]=$db->f("slaapkamers");
	#			if($newresultsminmax[$accid]["maxslaapkamers"]<$db->f("slaapkamers")) $newresultsminmax[$accid]["maxslaapkamers"]=$db->f("slaapkamers");

	#			if(!$newresultsminmax[$accid]["minbadkamers"] or $newresultsminmax[$accid]["minbadkamers"]>$db->f("badkamers")) $newresultsminmax[$accid]["minbadkamers"]=$db->f("badkamers");
	#			if($newresultsminmax[$accid]["maxbadkamers"]<$db->f("badkamers")) $newresultsminmax[$accid]["maxbadkamers"]=$db->f("badkamers");

				if($tarief_float>0) {
					if(!$newresultsminmax[$accid]["mintarief"] or $newresultsminmax[$accid]["mintarief"]>$tarief_float) {
						$newresultsminmax[$accid]["mintarief"]=$tarief_float;
						$newresults_cheapest[$accid]=$db->f("type_id");
					}
					if($newresultsminmax[$accid]["maxtarief"]<$tarief_float) {
						$newresultsminmax[$accid]["maxtarief"]=$tarief_float;
					}
				}

				if($db->f("tkwaliteit")) {
					$kwaliteit=$db->f("tkwaliteit");
				} else {
					$kwaliteit=$db->f("akwaliteit");
				}

				if(!$newresultsminmax[$accid]["minkwaliteit"] or $newresultsminmax[$accid]["minkwaliteit"]>$kwaliteit) $newresultsminmax[$accid]["minkwaliteit"]=$kwaliteit;
				if($newresultsminmax[$accid]["maxkwaliteit"]<$kwaliteit) $newresultsminmax[$accid]["maxkwaliteit"]=$kwaliteit;

				if($newresults[$accid][$acc_sorteer]["aanbieding"]) {
					# binnen deze accommodatie is een aanbieding actief
					$newresultsminmax[$accid]["aanbieding"]=true;

					if(is_array($soort_aanbieding["percentage"]) and count($soort_aanbieding["percentage"])==1 and !$soort_aanbieding["euro"]) {
						# aanbiedingspercentage per type bepalen
						if($newresults[$accid][$acc_sorteer]["aanbieding_percentage"]<$soort_aanbieding["percentage"]) {
							$newresults[$accid][$acc_sorteer]["aanbieding_percentage"]=array_shift($soort_aanbieding["percentage"]);
						}
					}
					if(is_array($soort_aanbieding["euro"]) and count($soort_aanbieding["euro"])==1 and !$soort_aanbieding["percentage"]) {
						# aanbiedingsbedrag per type bepalen
						if($newresults[$accid][$acc_sorteer]["aanbieding_euro"]<$soort_aanbieding["euro"]) {
							$newresults[$accid][$acc_sorteer]["aanbieding_euro"]=array_shift($soort_aanbieding["euro"]);
						}
					}
				}
			}
		}
	}

	$files = ['a' => [], 't' => []];

	if (isset($imageIds)) {

	    $mongodb      = $vars['mongodb']['wrapper'];
	    $cursors      = [];
	    $cursors['a'] = $mongodb->getAllMainFiles('accommodations', array_keys($imageIds['a']));
	    $cursors['t'] = $mongodb->getAllMainFiles('types', array_keys($imageIds['t']));

	    foreach ($cursors['a'] as $file) {

	        if (isset($file['type']) && $file['type'] === 'big') {
	            $files['a'][$file['file_id']] = $file['directory'] . '/' . $file['filename'];
	        }
	    }

	    foreach ($cursors['t'] as $file) {

	        if (isset($file['type']) && $file['type'] === 'big') {
	            $files['t'][$file['file_id']] = $file['directory'] . '/' . $file['filename'];
	        }
	    }
	}

	if($vars["webtastic"]) {
		$endtime_query=microtime(true);
	}

	if(@count($newresults_acc)>0) {
		ksort($newresults_acc);
		unset($results);
		unset($viewed_products);
		unset($aantalresultaten_zonder_gekoppeld_skigebied);

		# Resultaten laten afvallen bij gekoppelde skigebieden (maximaal 10 skigebieden koppelen)
		if($skigebied_inquery) {
			$tempresults=$newresults_acc;
			unset($newresults_acc);
			while(list($key,$value)=each($tempresults)) {
				if(!$sorteerscore_doorlopen[$sorteerscore_skigebied[$key]]) {
					$sorteerscore_doorlopen[$sorteerscore_skigebied[$key]]=true;
					if($sorteerscore_counter>10) {
						break;
					}
				}
				$sorteerscore_counter++;
				$newresults_acc[$key]=$value;
			}
		}

		while(list($key,$value)=each($newresults_acc)) {

			if($newresults_acc_gehad[$value]) {
				continue;
			}
			$newresults_acc_gehad[$value]=true;
			reset($newresults[$value]);
			unset($newresults_multiple);
			if(count($newresults[$value])>1) {
				$newresults_multiple=true;
			}

			ksort($newresults[$value]);

			$value2=current($newresults[$value]);

			if($gekozen_skigebied) {
				if($value2["skigebied_id"]==$gekozen_skigebied) {
					$aantalresultaten_zonder_gekoppeld_skigebied++;
				}
			} else {
				$aantalresultaten_zonder_gekoppeld_skigebied++;
			}

			$results_teller++;
			$viewed_products[$results_teller] = $value2;
			$results[$results_teller].="<tr><td colspan=\"5\">";

			$results[$results_teller].="<div class=\"zoekresultaat_block boxshadow\">";

				# Sorteerscore gekoppelde skigebieden
				if($koppeling[$value2["skigebied_id"]]) {
#					$sorteerscore_skigebied[$results_teller]=intval($koppeling[$value2["skigebied_id"]]);
				}

				# querystring bepalen (voor "back"-functie)
				$querystring="?back=".urlencode($_SERVER["REQUEST_URI"]);
				if($_GET["fap"]) $querystring.="&ap=".$_GET["fap"];
				if($_GET["fad"]) $querystring.="&d=".$_GET["fad"];
				if($_GET["fdu"]) $querystring.="&fdu=".$_GET["fdu"];
				if($flex_aankomstdatum and $_GET["fdu"]) {
					$querystring.="&flad=".$flex_aankomstdatum;
					$querystring.="&fldu=".$_GET["fdu"];
				}
				if($_GET["fpl"]) $querystring.="&fpl=".$_GET["fpl"];

				# aanbieding?
				if($value2["type_id_aanbieding"]) {
					$aanbieding_acc=true;
				} else {
					$aanbieding_acc=false;
				}


				# resultaat (gehele accommodatie)
				$results[$results_teller].="<a href=\"".wt_he($vars["path"].txt("menu_accommodatie")."/".($newresults_cheapest[$value] ? $value2["begincode"].$newresults_cheapest[$value] : $value2["begincode"].$value2["type_id"]))."/".wt_he($querystring)."\" class=\"zoekresultaat\">";
					$results[$results_teller].="<div class=\"zoekresultaat_top\">";
						$results[$results_teller].="<div class=\"zoekresultaat_titel\">".wt_he(ucfirst($vars["soortaccommodatie"][$value2["soortaccommodatie"]])." ".$value2["naam"].(!$newresults_multiple&&$value2["tnaam"] ? " ".$value2["tnaam"] : ""))."</div>";
					$results[$results_teller].="</div>";
					$results[$results_teller].="<div>";

    					# afbeelding bepalen
    					$img             = 'accommodaties/0.jpg';
                        $accommodationId = (int)$value2['accommodatie_id'];
                        $typeId          = (int)$value2['type_id'];

                        if ($newresults_multiple) {

                            if (isset($files['a'][$accommodationId])) {
                                $img = $files['a'][$accommodationId];
                            } elseif (isset($files['t'][$typeId])) {
                                $img = $files['t'][$typeId];
                            }

                        } else {

                            if (isset($files['t'][$typeId])) {
                                $img = $files['t'][$typeId];
                            } elseif (isset($files['a'][$accommodationId])) {
                                $img = $files['a'][$accommodationId];
                            }
                        }

						$results[$results_teller].="<div class=\"zoekresultaat_img\"><img src=\"".wt_he($vars["path"]."pic/cms/".$img)."\" alt=\"\"></div>";

						$results[$results_teller].="<div class=\"zoekresultaat_content\">";

							$results[$results_teller].="<div class=\"zoekresultaat_content_land\">".wt_he($value2["land"])."</div>";
							$results[$results_teller].="<div>".wt_he($value2["plaats"])."</div>";
							$results[$results_teller].="<div>".wt_he($value2["skigebied"])."</div>";

							$results[$results_teller].="<div class=\"zoekresultaat_content_sterren\">";
							if($newresultsminmax[$value]["minkwaliteit"]) {
								for($i=1;$i<=$newresultsminmax[$value]["minkwaliteit"];$i++) {
									$results[$results_teller].="<img src=\"".$vars["path"]."pic/ster_".$vars["websitetype"].".png\" alt=\"*\">";
								}
								if($newresultsminmax[$value]["maxkwaliteit"]>$newresultsminmax[$value]["minkwaliteit"]) {
									$results[$results_teller].="<img src=\"".$vars["path"]."pic/ster-scheidingsteken.gif\" alt=\" \">";
									for($i=1;$i<=$newresultsminmax[$value]["maxkwaliteit"];$i++) {
										$results[$results_teller].="<img src=\"".$vars["path"]."pic/ster_".$vars["websitetype"].".png\" alt=\"*\">";
									}
								}
							}
							$results[$results_teller].="</div>";

							$results[$results_teller].="<div class=\"zoekresultaat_omschrijving"."\">".wt_he((!$newresults_multiple&&$value2["tkorteomschrijving"] ? $value2["tkorteomschrijving"] : $value2["korteomschrijving"]))."</div>";

						if($value2["toonper"]==3 or $vars["wederverkoop"]) {
							// losse accommodatie
							$arrangement = false;
						} else {
							$arrangement = true;
						}

						if($arrangement) {
							// skipas-icon
							$results[$results_teller].="<div class=\"zoekresultaat_skipas".($newresultsminmax[$value]["aanbieding"] ? " zoekresultaat_skipas_en_aanbieding" : "")."\">".html("incl-skipas","accommodaties")."</div>";
						}

						if($newresultsminmax[$value]["aanbieding"]) {
							$results[$results_teller].="<div class=\"zoekresultaat_aanbieding".($arrangement ? " zoekresultaat_aanbieding_en_skipas" : "")."\"><img src=\"".$vars["path"]."pic/aanbieding_groot_".$vars["websitetype"].".gif\">".html("aanbieding","accommodaties")."</div>";
						}

						$results[$results_teller].="</div>";

						$results[$results_teller].="<div class=\"zoekresultaat_prijs\">";
							if($value2["tarief"]) {

								$results[$results_teller].="<div class=\"zoekresultaat_prijs_info_bijkomendekosten\" data-type_id=\"".($newresults_cheapest[$value] ? $newresults_cheapest[$value] : $value2["type_id"])."\" data-seizoen_id=\"".intval($bk_used_seizoen_id[$value2["type_id"]])."\" data-arrangement=\"".($value2["toonper"]==3 || $vars["wederverkoop"] ? "0" : "1")."\" data-ap=\"".intval($_GET["fap"])."\" data-ad=\"".intval($_GET["fad"])."\"></div>";

								unset($zoekresultaat_prijs_periode);
								$zoekresultaat_prijs_periode.="<div class=\"zoekresultaat_prijs_periode\">";
								if($vars["zoekform_weekendski"]) {
									$zoekresultaat_prijs_periode.="1 ".html("weekend","vars");
								} else {
									if(preg_match("/^([0-9]+)n$/",$gekozen["fdu"],$regs)) {
										if($regs[1]==1) {
											$zoekresultaat_prijs_periode.="1 ".html("nacht","vars");
										} else {
											$zoekresultaat_prijs_periode.=intval($regs[1])." ".html("nachten","vars");
										}
									} elseif($gekozen["fdu"]>1) {
										$zoekresultaat_prijs_periode.=$gekozen["fdu"]." ".html("weken","vars");
									} elseif($vanaf_prijzen_tonen and $_GET["fdu"] and $_GET["fdu"]<>"1") {
										$zoekresultaat_prijs_periode.=html("per")." ".html("week","vars");
									} else {
										$zoekresultaat_prijs_periode.="1 ".html("week","vars");
									}
								}
								$zoekresultaat_prijs_periode.="</div>";

								if(($newresults_multiple and $newresultsminmax[$value]["maxtarief"]>$newresultsminmax[$value]["mintarief"]) or $vanaf_prijzen_tonen) {
									$results[$results_teller].=$zoekresultaat_prijs_periode;
									$results[$results_teller].="<div class=\"zoekresultaat_prijs_vanaf\">".html("vanaf")."</div>";
								} else {
									$results[$results_teller].="<div class=\"zoekresultaat_prijs_vanaf\">&nbsp;</div>";
									$results[$results_teller].=$zoekresultaat_prijs_periode;
								}

								$results[$results_teller].="<div class=\"zoekresultaat_prijs_bedrag".($aanbieding_acc ? " zoekresultaat_prijs_bedrag_aanbieding" : "")."\">&euro;&nbsp;".number_format($newresultsminmax[$value]["mintarief"],0,",",".")."</div>";
								$results[$results_teller].="<div class=\"zoekresultaat_prijs_per\">";
								if($value2["toonper"]==3 or $vars["wederverkoop"]) {
									$results[$results_teller].=html("peraccommodatie","zoek-en-boek");
								} else {
									$results[$results_teller].=html("perpersoon","zoek-en-boek")."<br>".html("inclusiefskipas","zoek-en-boek");
								}
								$results[$results_teller].="</div>";
							}
						$results[$results_teller].="</div>";
						$results[$results_teller].="<div class=\"clear\"></div>";
					$results[$results_teller].="</div>";

				if($newresults_multiple) {
					$results[$results_teller].="</a>";
				}

				# resultaten type-regels
				reset($newresults[$value]);
				while(list($key2,$value2)=each($newresults[$value])) {
					if($gekozen_skigebied) {
						if($value2["skigebied_id"]==$gekozen_skigebied) {
							$toon_aantalresultaten_verschillende_types++;
						} else {
							$toon_aantalresultaten_anderskigebied++;
						}
					} else {
						$toon_aantalresultaten_verschillende_types++;
					}

#					$results[$results_teller].="<div>".wt_he($value2["naam"])."</div>";
					if($newresults_multiple) {
						$results[$results_teller].="<a href=\"".wt_he($vars["path"].txt("menu_accommodatie")."/".$value2["begincode"].$value2["type_id"])."/".wt_he($querystring)."\" class=\"zoekresultaat_type\">";
					} else {
						$results[$results_teller].="<div class=\"zoekresultaat_type_een_resultaat\">";
					}
					$results[$results_teller].="<div class=\"zoekresultaat_type_titel".($value2["type_id_trclass"] ? " ".$value2["type_id_trclass"] : "")."\">";
						$results[$results_teller].="<div class=\"zoekresultaat_type_personen\">".$value2["optimaalaantalpersonen"].($value2["maxaantalpersonen"]>$value2["optimaalaantalpersonen"] ? " - ".$value2["maxaantalpersonen"] : "")." ".($value2["maxaantalpersonen"]==1 ? html("persoon") : html("personen"))."</div>";
						$results[$results_teller].="<div class=\"zoekresultaat_type_slaapkamers\">".$value2["slaapkamers"]." ".($value2["slaapkamers"]==1 ? html("slaapkamer") : html("slaapkamers"))."</div>";
						$results[$results_teller].="<div class=\"zoekresultaat_type_badkamers\">".$value2["badkamers"]." ".($value2["badkamers"]==1 ? html("badkamer") : html("badkamers"))."</div>";
						$results[$results_teller].="<div class=\"zoekresultaat_type_typenaam".($value2["type_id_aanbieding"] ? " zoekresultaat_type_typenaam_aanbieding" : "")."\">".wt_he(($value2["tnaam"] ? $value2["tnaam"] : ""))."</div>";

						if($value2["type_id_aanbieding"]) {
#							$results[$results_teller].="<div class=\"zoekresultaat_type_aanbieding\"><img src=\"".$vars["path"]."pic/aanbieding_klein_".$vars["websitetype"].".png\"></div>";
							$results[$results_teller].="<div class=\"zoekresultaat_type_aanbieding\">";
							if($value2["tarief"]) {
								if(floatval($value2["aanbieding_percentage"])>0 and !$value2["aanbieding_euro"]) {
									$results[$results_teller].=floor($value2["aanbieding_percentage"])."% ".html("korting","vars");
								} elseif(floatval($value2["aanbieding_euro"])>0 and !$value2["aanbieding_percentage"]) {
									$results[$results_teller].="&euro;&nbsp;".number_format(floor($value2["aanbieding_euro"]),0,",",".")." ".html("korting","vars");
								} else {
									$results[$results_teller].=html("aanbieding","accommodaties");
								}
							}
							$results[$results_teller].="</div>";
#							$newresults[$accid][$acc_sorteer]["aanbieding_percentage"]
						}

					$results[$results_teller].="</div>";

					$prijs_div_title = "";
					$prijs_div_class = "zoekresultaat_type_prijs";
					if($value2["tarief"]) {
						if($value2["toonper"]<>3 && !$vars["wederverkoop"]) {
							$prijs_div_title = txt("ppinclusiefskipas", "zoek-en-boek");
						} else {
							$prijs_div_title = txt("peraccommodatie", "zoek-en-boek");
						}
					}


					if($value2["type_id_aanbieding"]) {
						$prijs_div_class .= " zoekresultaat_type_prijs_aanbieding";
					}
					$results[$results_teller].="<div class=\"".trim($prijs_div_class)."\" title=\"".wt_he($prijs_div_title)."\">";
					if($value2["tarief"]) {
						$results[$results_teller].="&euro;&nbsp;".number_format($value2["tarief"],0,",",".");
						if($value2["toonper"]==3 or $vars["wederverkoop"]) {

						} else {
							$results[$results_teller].=" ".html("pp");
						}

						if(constant("include_bkk")===false) {
							$results[$results_teller].="<div class=\"zoekresultaat_prijs_info_bijkomendekosten zoekresultaat_prijs_info_bijkomendekosten_exclude_bkk\" data-type_id=\"".intval($value2["type_id"])."\" data-seizoen_id=\"".intval($bk_used_seizoen_id[$value2["type_id"]])."\" data-arrangement=\"".($value2["toonper"]==3 || $vars["wederverkoop"] ? "0" : "1")."\" data-ap=\"".intval($_GET["fap"])."\" data-ad=\"".intval($_GET["fad"])."\"></div>";
						}


					} else {
						$results[$results_teller].="&nbsp;";
					}
					$results[$results_teller].="</div>";
					if(!$newresults_multiple) {
						$results[$results_teller].="</div>"; # afsluiten .zoekresultaat_type_een_resultaat
					}

					$results[$results_teller].="<div class=\"clear\"></div>";
					$results[$results_teller].="</a>";
				}
			$results[$results_teller].="</div>";

			$results[$results_teller].="</td></tr>";

			# skigebied_id van dit resultaten bepalen
			$results_ander_skigebied[$results_teller]=$sorteerscore_skigebied[$key];
		}
	}
}


if($vars["zoekform_thema"] or $vars["zoekform_weekendski"] or $vars["zoekform_vallandrychalets"] or $vars["zoekform_aanbiedingen"] or $vars["zoekform_italissima_nieuwe_tarieven"]) {
	echo "<a name=\"form\"></a>";
	if($vars["zoekform_aanbiedingen"]) {
		echo "<p>".html("inleidingaanbiedingen","zoek-en-boek",array("l1"=>"aanbiedingen","l2"=>"top10","v_websitenaam"=>$vars["websitenaam"]))."</p>";
	}
}

# Verwerking m.b.t. tonen zoekformulier op andere pagina dan zoek-en-boek.php
if($vars["zoekform_thema"] or $vars["zoekform_weekendski"] or $vars["zoekform_vallandrychalets"] or $vars["zoekform_italissima_nieuwe_tarieven"]) {

	if($vars["themainfo"]["tarievenbekend_seizoen_id"] and $vars["themainfo"]["toelichting"]) {
		# Inleidende tekst bij tarieven volgend seizoen tonen
		echo "<h1>".wt_he($vars["themainfo"]["naam"])."</h1>\n";
		echo htmlentities_uitgebreid(trim($vars["themainfo"]["toelichting"]));
	}

	if($_GET["filled"] or strlen($_GET["scrolly"])>0 or $vars["themainfo"]["tarievenbekend_seizoen_id"]) {
		echo "<div>&nbsp;</div>";
		echo "<div>";
	} else {
		echo "<div style=\"padding-bottom:20px;".(!$uitgebreid ? "padding-top:10px;" : "")."\">";
		if($vars["themainfo"]["uitgebreidzoeken_url"]) {

#			echo "<div class=\"button\" onclick=\"document.location.href='".$vars["path"].txt("menu_zoek-en-boek").".php?".wt_he($vars["themainfo"]["uitgebreidzoeken_url"])."';\">";
#			echo html("uitgebreidzoeken","thema");
#			echo "</div>";

			echo "<a href=\"".wt_he($vars["path"].txt("menu_zoek-en-boek").".php?filled=1&".$vars["themainfo"]["uitgebreidzoeken_url"])."&amp;referer=5\" class=\"button\" style=\"float:left;\" rel=\"nofollow\">";
			echo html("uitgebreidzoeken","thema");
			echo "</a>";

		} else {
			echo "<div class=\"showlink\" style=\"float:left;\">";
			if(!$vars["themainfo"]["tarievenbekend_seizoen_id"]) {
				echo "<div class=\"button\">";
				echo html("zoekcriteriaopgeven","thema");
				echo "</div>";
			}
			echo "</div>";
		}
		if($vars["zoekform_thema"] and $vars["seizoentype"]==1) {
			echo "<div class=\"button\" style=\"margin-left:10px;margin-right:45px;float:right;\" onclick=\"document.location.href='".$vars["path"].txt("menu_themas").".php'\">".html("meerinspiratie","thema")."</div>";
		}
		echo "<div style=\"clear:both;\"></div>";

		echo "</div>";
		if($vars["themainfo"]["tarievenbekend_seizoen_id"] or $_GET["filled"]) {
			echo "<div class=\"showlinkdiv\">";
		} else {
			echo "<div class=\"showlinkdiv\" style=\"display:none;\">";
		}
	}
}

# hulpmiddeltje om hover-kleur door te geven aan jQuery
echo "<div id=\"hulp_zoekresultaat_hover\"></div>";


echo "<div id=\"zoekblok\" class=\"boxshadow\">";


# formulier-declaratie
echo "<form method=\"get\" action=\"";
if($vars["zoekform_thema"]) {
	if($vars["zoekform_italissima_nieuwe_tarieven"]) {
		// pagina Italissima: Nu al te boeken voor 2014
		$urlself=preg_replace("@\?.*$@","",$_SERVER["REQUEST_URI"]);
	} else {
		if($themalandinfo["soort"]=="land") {
			$urlself=$vars["path"].txt("menu_land")."/".wt_he($_GET["land"])."/";
		} else {
			$urlself=$vars["path"].txt("menu_thema")."/".wt_he($_GET["thema"])."/";
		}
	}
} elseif($vars["zoekform_weekendski"]) {
	$urlself=$vars["path"].txt("menu_weekendski").".php";
} elseif($vars["zoekform_vallandrychalets"]) {
	$urlself=$vars["path"]."chalets/".$_GET["chaletpark"]."/".$_GET["seizoen"]."/";
} elseif($vars["zoekform_aanbiedingen"]) {
	$urlself=$vars["path"].txt("menu_aanbiedingen").".php";
} else {
	$urlself=txt("menu_zoek-en-boek").".php";
}
echo $urlself;
#$urlself=ereg_replace("#form","",$urlself);
echo "\" name=\"zoeken\" id=\"zoeken\">";



#
# Hidden fields
#
if($_GET["abid"]) {
	# abid = aanbiedingid = toon alleen accommodaties van een specifieke aanbieding
	echo "<input type=\"hidden\" name=\"abid\" value=\"".wt_he($_GET["abid"])."\">\n";
}
if($_GET["aab"]) {
	# aab = alleen aanbiedingen
	echo "<input type=\"hidden\" name=\"aab\" value=\"".wt_he($_GET["aab"])."\">\n";
}
if($_GET["testsysteem"]) {
	# testsysteem
	echo "<input type=\"hidden\" name=\"testsysteem\" value=\"".intval($_GET["testsysteem"])."\">\n";
}
if($_GET["sort"] and $vars["websitetype"]<>8) {
	# gekozen sortering meesturen met het formulier
	echo "<input type=\"hidden\" name=\"sort\" value=\"".wt_he($_GET["sort"])."\">\n";
}
if($vars["zoeken_op_kaart"]) {

	// always show map by default
	if(!isset($_GET["map"])) {
		$_GET["map"]=1;
	}

	# doorgeven of bij zoeken op kaart de kaart zichtbaar is
	echo "<input type=\"hidden\" name=\"map\" value=\"".intval($_GET["map"])."\">\n";
}

if($_GET["pagetype"] and $_GET["pagecontent"]) {
	# zoek-en-boek-pre-query
	echo "<input type=\"hidden\" name=\"pagetype\" value=\"".wt_he($_GET["pagetype"])."\">\n";
	echo "<input type=\"hidden\" name=\"pagecontent\" value=\"".wt_he($_GET["pagecontent"])."\">\n";
}


# Scrollpositie kunnen onthouden
echo "<input type=\"hidden\" name=\"scrolly\" value=\"".intval($_GET["scrolly"])."\" />\n";

echo "<input type=\"hidden\" name=\"filled\" value=\"1\">";

# Hidden fields m.b.t. verfijnen zoekopdracht
if($vars["verfijnen_aanbieden"]) {
	@reset($keuzeopsomming);
	while(list($key,$value)=@each($keuzeopsomming)) {
		if($value["combinatiesmogelijk"]) {
			while(list($key2,$value2)=@each($value["fields"])) {
				if($_GET[$value["getname"].$value2] or $_GET[$value["getname"].$value2]=="0") {
					echo "<input type=\"hidden\" name=\"".$value["getname"].$value2."\" value=\"".wt_he($_GET[$value["getname"].$value2])."\">\n";
				}
			}
		} else {
			if($_GET[$value["getname"]."1"] or $_GET[$value["getname"]."1"]=="0") {
				echo "<input type=\"hidden\" name=\"".$value["getname"]."1\" value=\"".wt_he($_GET[$value["getname"]."1"])."\">\n";
			}
		}
	}
}

if(!$vars["zoek-en-boek-functions-init"]) {

	function zoekblok_tekst($settings=array("")) {
		# zoekformulier: zoeken op tekst

		echo "<div class=\"zoekblok_item zoekblok_tekst\">";

		echo "<div class=\"zoekblok_titel\">";
		echo html("zoekenmbvtekst","accommodaties");
		echo "</div>"; # afsluiten .zoekblok_titel

		echo "<div class=\"zoekblok_field\">";
		echo "<input type=\"text\" name=\"fzt\" value=\"".wt_he($_GET["fzt"])."\" data-placeholder=\"".html("tekstzoeken","zoek-en-boek")."\" class=\"".($_GET["fzt"] ? "geen_vergrootglas" : "")."\">";

		# wis-icoontje tonen
		echo "<a href=\"#\" id=\"wis_zoekblok_tekst\" style=\"".($_GET["fzt"] ? "display:block;" : "")."\"></a>";


		echo "</div>"; # afsluiten .zoekblok_field

		// echo "<div class=\"zoekblok_subtitel\">";
		// echo "(".html("tekstzoeken","zoek-en-boek").")";
		// echo "</div>"; # afsluiten .zoekblok_subtitel

		echo "<div class=\"clear\"></div>";
		echo "</div>"; # afsluiten .zoekblok_item
	}

	function zoekblok_bestemming($settings=array("")) {
		#
		# zoekformulier: bestemming
		#
		global $vars, $landnaam, $themalandinfo, $save_query, $landen;

		$db=new DB_sql;

		# plaatsen uit database halen
		if($settings["zonder_plaatsen"]) {
			$selectquery="land_id, skigebied_id";
		} else {
			$selectquery="land_id, skigebied_id, plaats_id, plaats";
		}
		$db->query("SELECT DISTINCT ".$selectquery." FROM view_accommodatie WHERE ".$vars["where_websites_query"]." AND weekendski='".intval($vars["zoekform_weekendski"])."' AND atonen=1 AND ttonen=1 AND archief=0 AND wzt='".$vars["seizoentype"]."' ORDER BY skigebied_id, plaats;");
		while($db->next_record()) {
			if(!$settings["zonder_plaatsen"]) {
				$plaatsen[$db->f("land_id")."_".$db->f("skigebied_id")][$db->f("plaats_id")]=$db->f("plaats");
				$bestemmingen_actief["pl".$db->f("plaats_id")]=$db->f("plaats");
			}
			$skigebied_bevat_accommodaties[$db->f("skigebied_id")]=true;
			$land_bevat_accommodaties[$db->f("land_id")]=true;
		}

		echo "<div class=\"zoekblok_item zoekblok_bestemming\" data-search-placeholder=\"".html("kiesoftypbestemming","zoek-en-boek")."\">";

		echo "<div class=\"zoekblok_titel\">";
		echo html("bestemming","zoek-en-boek");
		echo "</div>"; # afsluiten .zoekblok_titel

		echo "<div class=\"zoekblok_field".($_GET["fsg"] ? " zoekblok_field_extrabestemming" : "")."\">";

		echo "<input type=\"hidden\" name=\"fsg\" value=\"".wt_he($_GET["fsg"])."\">";

		if($_GET["fsg"]) {
			$placeholder=txt("extrabestemming","zoek-en-boek");
		} else {
			$placeholder="- ".txt("geenvoorkeur","vars")." -";
		}

		echo "<select name=\"fsg_invoer\" class=\"zoekblok_select\" id=\"zoekblok_field_bestemming\" data-placeholder=\"".wt_he($placeholder)."\" data-no_results_text=\"".html("geenresultatenmet","zoek-en-boek")."\">";
		echo "<option> </option>";
		unset($vars["skigebied"]["00AAAAA___".$vars["geenvoorkeur"]]);
		while(list($key,$value)=each($vars["skigebied"])) {

			if($vars["websitetype"]==7 and $value=="5-0") {
				# geen land bij Italissima vermelden (want: alles ligt in Italië)
				continue;
			}

			if(preg_match("/^([0-9]+)-([0-9]+)/",$value,$regs) and $regs[2]=="0") {
				$optionclass="option_land";

				// land zonder accommodaties: niet tonen
				if($regs[1] and !$land_bevat_accommodaties[$regs[1]]) {
					continue;
				}
			} else {
				$optionclass="option_regio";

				// skigebied zonder accommodaties: niet tonen
				if($regs[2] and !$skigebied_bevat_accommodaties[$regs[2]]) {
					continue;
				}
			}


			echo "<option class=\"".$optionclass."\" value=\"".$value."\"";
			echo ">";
			$skigebied=preg_replace("/^.*___/","",$key);
			echo wt_he($skigebied);
			echo "</option>";

			$bestemmingen_actief[$value]=preg_replace("/^.*___/","",$key);

			if($regs[1]>0 and $regs[2]>0) {
				# Plaatsen tonen
				if(is_array($plaatsen[$regs[1]."_".$regs[2]])) {
					reset($plaatsen[$regs[1]."_".$regs[2]]);
					while(list($key2,$value2)=each($plaatsen[$regs[1]."_".$regs[2]])) {
						echo "<option class=\"option_plaats\" value=\"pl".$key2."\"";
						echo ">".wt_he($value2)."</option>";
					}
				}
			}

		}
		echo "</select>";
		echo "</div>"; # afsluiten .zoekblok_field

		echo "<div class=\"clear\"></div>";

		# al ingevulde bestemmingen tonen
		if($_GET["fsg"]) {
			echo "<div class=\"zoekblok_bestemming_actief\">";
			$doorloop_array_fsg=preg_split("/,/",$_GET["fsg"]);
			while(list($key,$value)=each($doorloop_array_fsg)) {
				if($value and $bestemmingen_actief[$value]) {
					echo "<div class=\"zoekblok_bestemming_actief_item\" data-bestemming_actief_value=\"".wt_he($value)."\" data-bestemming_actief_name=\"".wt_he($bestemmingen_actief[$value])."\">";
					if(preg_match("/^pl/",$value)) {
						# plaats
						echo wt_he($bestemmingen_actief[$value]);
					} elseif(preg_match("/^[0-9]+-0$/",$value)) {
						# land
						echo txt("heel","zoek-en-boek")." ".wt_he($bestemmingen_actief[$value]);
					} else {
						# regio/skigebied
						echo wt_he($bestemmingen_actief[$value]);
					}
					echo "<a href=\"#\" rel=\"".wt_he($value)."\" title=\"".html("wisdezebestemming","zoek-en-boek")."\"></a>";
					echo "</div>";
				}
			}
			echo "<div class=\"clear\"></div>";
			echo "</div>"; # afsluiten .zoekblok_item_geen_titel
		}

		echo "</div>"; # afsluiten .zoekblok_item
	}

	function zoekblok_aantalpersonen($settings=array("")) {
		#
		# zoekformulier: aantal personen
		#
		global $vars;

		echo "<div class=\"zoekblok_item zoekblok_aantalpersonen\">";

		echo "<div class=\"zoekblok_titel\">";
		echo html("aantalpersonen","accommodaties");
		echo "</div>"; # afsluiten .zoekblok_titel

		echo "<div class=\"zoekblok_field\">";
	#		echo "<select name=\"fap\" class=\"zoekblok_select onchangesubmit\">";

		echo "<select name=\"fap\" class=\"zoekblok_select onchangesubmit\" data-placeholder=\"- ".html("geenvoorkeur","vars")." -\">";
		echo "<option value=\"0\"".(!$_GET["fap"] ? " selected" : "")."> </option>";
		unset($vars["aantalpersonen"][0]);
		reset($vars["aantalpersonen"]);
		while(list($key,$value)=each($vars["aantalpersonen"])) {
			echo "<option value=\"".$key."\"";
			if($_GET["filled"] and $_GET["fap"]==$key) {
				echo " selected";
				if($key) $save_query["aantal personen"]=$value;
			}
			echo ">".$value."</option>";
		}
		echo "</select>";
		echo "</div>"; # afsluiten .zoekblok_field

		echo "<div class=\"clear\"></div>";
		echo "</div>"; # afsluiten .zoekblok_item
	}

	function zoekblok_aantalslaapkamers($settings=array("")) {
		#
		# zoekformulier: aantal slaapkamers
		#
		global $vars;

		echo "<div class=\"zoekblok_item zoekblok_aantalslaapkamers\">";

		echo "<div class=\"zoekblok_titel\">";
		echo html("aantalslaapkamers","accommodaties");
		echo "</div>"; # afsluiten .zoekblok_titel

		echo "<div class=\"zoekblok_field\">";

		echo "<select name=\"fas\" class=\"zoekblok_select onchangesubmit\" data-placeholder=\"- ".html("geenvoorkeur","vars")." -\">";
		echo "<option value=\"0\"".(!$_GET["fas"] ? " selected" : "")."> </option>";
		unset($vars["aantalslaapkamers"][0]);
		reset($vars["aantalslaapkamers"]);
		while(list($key,$value)=each($vars["aantalslaapkamers"])) {
			echo "<option value=\"".$key."\"";
			if($_GET["filled"] and $_GET["fas"]==$key) {
				echo " selected";
				if($key) $save_query["aantal slaapkamers"]=$value;
			}
			echo ">".$value."</option>";
		}
		echo "</select>";
		echo "</div>"; # afsluiten .zoekblok_field

		echo "<div class=\"clear\"></div>";
		echo "</div>"; # afsluiten .zoekblok_item
	}

	function zoekblok_aankomstdatum($settings=array("")) {
		#
		#
		# zoekformulier: aankomstdatum
		#
		global $vars;
		$db=new DB_sql;

		echo "<div class=\"zoekblok_item zoekblok_aankomstdatum\">";

		echo "<div class=\"zoekblok_titel\">";
		echo html("aankomstdatum","accommodaties");
		echo "</div>"; # afsluiten .zoekblok_titel

		echo "<div class=\"zoekblok_field\">";

		if($vars["flexibel_toegestaan"]) {
			#
			# Flexibel
			#
			# Kalender
			echo "<div style=\"float:left;margin-top:5px;\">";
			echo "<img src=\"".$vars["path"]."pic/class.form_calendar.gif\" style=\"border:0;\" onClick=\"window.open('".$vars["path"]."calendar.php?nm=zoeken&amp;lang=".$vars["taal"]."&amp;justonevar=1&amp;input=fadf&amp;month='+document.zoeken.elements['fadf_m'].value+'&amp;year='+document.zoeken.elements['fadf_y'].value, '_blank', 'scrollbars=no,width=345,height=320,left=0,top=0');\" width=\"16\" height=\"15\" alt=\"Kalender\" class=\"zoekblok_aankomstdatum_calendar\">";
			echo "</div>";

			# dag
			echo "<select name=\"fadf_d\" class=\"flexibel_datum\">";
			echo "<option value=\"\"".(!$_GET["fadf_d"] ? " selected" : "").">&nbsp;</option>";
			for($i=1;$i<=31;$i++) {
				echo "<option value=\"".$i."\"".($_GET["fadf_d"]==$i ? " selected" : "").">".$i."</option>";
			}
			echo "</select>";

			echo "&nbsp;&nbsp;";

			# maand
			echo "<select name=\"fadf_m\" class=\"flexibel_datum\">";
			echo "<option value=\"\"".(!$_GET["fadf_m"] ? " selected" : "").">&nbsp;</option>";
			for($i=1;$i<=12;$i++) {
				echo "<option value=\"".$i."\"".($_GET["fadf_m"]==$i ? " selected" : "").">".DATUM("MAAND",mktime(0,0,0,$i,1,2010),$vars["taal"])."</option>";
			}
			echo "</select>";

			echo "&nbsp;&nbsp;";

			# jaar
			echo "<select name=\"fadf_y\" class=\"flexibel_datum\">";
			echo "<option value=\"\"".(!$_GET["fadf_y"] ? " selected" : "").">&nbsp;</option>";
			for($i=date("Y");$i<=date("Y")+1;$i++) {
				echo "<option value=\"".$i."\"".($_GET["fadf_y"]==$i ? " selected" : "").">".$i."</option>";
			}
			echo "</select>";

			if($_GET["fadf_d"] or $_GET["fadf_m"] or $_GET["fadf_y"]) {
				# wis-icoontje tonen
				echo "<a href=\"#\" id=\"wis_aankomstdatum_flex\"></a>";
			}
		} else {
			if(is_array($vars["aankomstdatum_weekend"])) {

				echo "<select name=\"fad\" class=\"zoekblok_select onchangesubmit\" data-placeholder=\"- ".html("geenvoorkeur","vars")." -\">";
				echo "<option value=\"0\"".(!$_GET["fad"] ? " selected" : "")."> </option>";
				unset($vars["aankomstdatum_weekend"][0]);
				reset($vars["aankomstdatum_weekend"]);
				while(list($key,$value)=each($vars["aankomstdatum_weekend"])) {
					# Weken die al voorbij zijn niet tonen (2 dagen na aankomstdatum niet meer tonen)
					if(mktime(0,0,0,date("m"),date("d")-2,date("Y"))<$key or !$key) {
						echo "<option value=\"".$key."\"";
						if($_GET["filled"] and $_GET["fad"]==$key) {
							echo " selected";
							if($key) $save_query["aankomstdatum"]=$value;
						}
						echo ">".$value."</option>\n";
					}
				}
				echo "</select>";
			}
		}
		echo "</div>"; # afsluiten .zoekblok_field

		# Bepalen of opmerking "omdat een groot deel van de accommodaties nog niet geprijsd is ..." getoond moet worden
		$db->query("SELECT zoekformulier_weinig_tarieven_".$vars["seizoentype"]." AS zoekformulier_weinig_tarieven FROM diverse_instellingen WHERE diverse_instellingen_id=1;");
		if($db->next_record() and $db->f("zoekformulier_weinig_tarieven")==1) {
			echo "<div class=\"zoekblok_subtitel\">";
			echo "(".html("aankomstdatum_opm","accommodaties").")";
			echo "</div>"; # afsluiten .zoekblok_subtitel
			$vars["zoekformulier_weinig_tarieven"]=true;
		}

		echo "<div class=\"clear\"></div>";
		echo "</div>"; # afsluiten .zoekblok_item
	}

	function zoekblok_verblijfsduur($settings=array("")) {
		#
		# zoekformulier: verblijfsduur
		#

		global $vars;

		echo "<div class=\"zoekblok_item zoekblok_verblijfsduur\">";

		echo "<div class=\"zoekblok_titel\">";
		echo html("verblijfsduur","accommodaties");
		echo "</div>"; # afsluiten .zoekblok_titel

		echo "<div class=\"zoekblok_field\">";

		unset($vars["verblijfsduur"]);
		$vars["verblijfsduur"]["1"]="1 ".txt("week","vars");
		$vars["verblijfsduur"]["2"]="2 ".txt("weken","vars");
		$vars["verblijfsduur"]["3"]="3 ".txt("weken","vars");
		$vars["verblijfsduur"]["4"]="4 ".txt("weken","vars");
		if($vars["flexibel_toegestaan"]) {
			// $vars["verblijfsduur"]["1n"]="1 ".txt("nacht","vars");
			for($i=3;$i<=$vars["flex_max_aantalnachten"];$i++) {
				$vars["verblijfsduur"][$i."n"]=$i." ".txt("nachten","vars");
			}
		}
		echo "<select name=\"fdu\" class=\"zoekblok_select onchangesubmit\" data-placeholder=\"- ".html("geenvoorkeur","vars")." -\">";
		echo "<option value=\"0\"".(!$_GET["fdu"] ? " selected" : "")."> </option>";

		reset($vars["verblijfsduur"]);
		while(list($key,$value)=each($vars["verblijfsduur"])) {
			if(preg_match("/n/",$key)) {
				if(!$key_gehad["nachten"]) {
					echo "</optgroup><optgroup label=\"".html("aantalnachten")."\">\n";
					$key_gehad["nachten"]=true;
				}
			} else {
				if(!$key_gehad["weken"]) {
					echo "<optgroup label=\"".html("aantalweken")."\">\n";
					$key_gehad["weken"]=true;
				}
			}

			echo "<option value=\"".$key."\"";
			if($_GET["filled"] and $_GET["fdu"]==$key) {
				echo " selected";
				if($key) $save_query["verblijfsduur"]=$vars["verblijfsduur"][$key];
			}
			echo ">".wt_he($value)."</option>";
		}
		echo "</optgroup></select>";
		echo "</div>"; # afsluiten .zoekblok_field

		echo "<div class=\"clear\"></div>";
		echo "</div>"; # afsluiten .zoekblok_item
	}

	function zoekblok_prijsklasse($settings=array("")) {
		#
		# zoekformulier: prijsklasse (via slider)
		#

		global $prijsklasse_max_beschikbaar;

		$prijsklasse_min=0;

		if($_GET["fpk_tot"]) {
			$prijsklasse_max=$_GET["fpk_max"];
		} else {
			# Andere zoekopdracht is uitgevoerd: min en max bepalen aan de hand van zoekresultaten

			if($prijsklasse_max_beschikbaar<=500) {
				$prijsklasse_max=500;
			} elseif($prijsklasse_max_beschikbaar<=1000) {
				$prijsklasse_max=1000;
			} elseif($prijsklasse_max_beschikbaar<=2000) {
				$prijsklasse_max=2000;
			} else {
				$prijsklasse_max=5000;
			}
		}

		if($prijsklasse_max==500) {
			$prijsklasse_stappen=10;
		} elseif($prijsklasse_max==1000) {
			$prijsklasse_stappen=10;
		} elseif($prijsklasse_max==2000) {
			$prijsklasse_stappen=20;
		} elseif($prijsklasse_max==5000) {
			$prijsklasse_stappen=50;
		} else {
			$prijsklasse_stappen=50;
		}

		$prijsklasse_min=intval($prijsklasse_min);
		$prijsklasse_max=intval($prijsklasse_max);

		echo "<div class=\"zoekblok_item zoekblok_prijsklasse\" data-min=\"".$prijsklasse_min."\" data-max=\"".$prijsklasse_max."\" data-stappen=\"".$prijsklasse_stappen."\" data-enmeer=\"".intval($_GET["fpk_enmeer"])."\">";

		echo "<div class=\"zoekblok_titel\">";
		echo html("prijsklasse","zoek-en-boek");
		echo "</div>"; # afsluiten .zoekblok_titel

		echo "<div class=\"zoekblok_field\">";

		echo "<div class=\"zoekblok_prijsklasse_min\">&euro;&nbsp;".$prijsklasse_min."</div>";
		echo "<div class=\"noUiSlider\"></div><div class=\"zoekblok_prijsklasse_max\">&euro;&nbsp;".$prijsklasse_max."</div>";
		echo "<div class=\"clear\"></div>";

		echo "<input type=\"hidden\" name=\"fpk_enmeer\" value=\"".intval($_GET["fpk_enmeer"])."\">";
		echo "<input type=\"hidden\" name=\"fpk_max\" value=\"".intval($prijsklasse_max)."\">";

		echo html("prijs_van", "zoek-en-boek")."&nbsp;&nbsp;&euro;&nbsp;<input type=\"text\" name=\"fpk_van\" id=\"fpk_van\" value=\"".($_GET["fpk_van"]||$_GET["fpk_van"]=="0" ? intval($_GET["fpk_van"]) : "")."\">";
		echo "&nbsp;&nbsp;";
		echo html("prijs_tot", "zoek-en-boek")."&nbsp;&nbsp;&euro;&nbsp;<input type=\"text\" name=\"fpk_tot\" id=\"fpk_tot\" value=\"".($_GET["fpk_tot"] ? intval($_GET["fpk_tot"]) : "")."\">";

		echo "<span id=\"zoekblok_prijsklasse_enmeer\" style=\"".($_GET["fpk_enmeer"]||!$_GET["fpk_tot"] ? "" : "display:none;")."\">&nbsp;".html("prijs_en_meer", "zoek-en-boek")."</span>";


		if($_GET["fpk_enmeer"]) {
			if($_GET["fpk_tot"]) {
				$_GET["fpk_tot"]+=$prijsklasse_stappen;
			} else {
				$prijsklasse_max+=$prijsklasse_stappen;
			}
		}
		echo "<input type=\"hidden\" id=\"fpk_van_hidden\" value=\"".($_GET["fpk_van"] ? intval($_GET["fpk_van"]) : $prijsklasse_min)."\">";
		echo "<input type=\"hidden\" id=\"fpk_tot_hidden\" value=\"".($_GET["fpk_tot"] ? intval($_GET["fpk_tot"]) : $prijsklasse_max+$prijsklasse_stappen)."\">";

		echo "&nbsp;&nbsp;(".html("per_vakantiehuis", "zoek-en-boek").")";

		echo "</div>"; # afsluiten .zoekblok_field

		echo "<div class=\"clear\"></div>";

		echo "</div>"; # afsluiten .zoekblok_item
	}

	function zoekblok_intern($settings=array("")) {
		#
		# zoekformulier: interne velden (leverancier + soort accommodatie)
		#

		global $vars, $voorkant_cms, $keuzeopsomming;

		$db=new DB_sql;

		if($voorkant_cms) {

			# Zoeken op leverancier

			echo "<div class=\"zoekblok_item zoekblok_leverancier\">";

			echo "<div class=\"zoekblok_titel intern\">";
			echo "Leverancier";
			echo "</div>"; # afsluiten .zoekblok_titel

			echo "<div class=\"zoekblok_field\">";

			echo "<select name=\"lev\" class=\"zoekblok_select onchangesubmit\" data-placeholder=\"- ".html("geenvoorkeur","vars")." -\">";
			echo "<option value=\"0\"".(!$_GET["lev"] ? " selected" : "")."> </option>";
			$db->query("SELECT DISTINCT l.leverancier_id, l.naam FROM leverancier l, accommodatie a, type t WHERE t.accommodatie_id=a.accommodatie_id AND t.leverancier_id=l.leverancier_id AND a.wzt='".$vars["seizoentype"]."' AND ".$vars["where_websites_query_t"]." ORDER BY naam;");
			while($db->next_record()) {
				echo "<option value=\"".$db->f("leverancier_id")."\"";
				if($_GET["filled"] and $_GET["lev"]==$db->f("leverancier_id")) {
					echo " selected";
				}
				echo ">".wt_he($db->f("naam"))."</option>\n";
			}
			echo "</select>";

			echo "</div>"; # afsluiten .zoekblok_field

			echo "<div class=\"clear\"></div>";
			echo "</div>"; # afsluiten .zoekblok_item


			if($vars["websitetype"]==7) {
				# Soort accommodatie Italissima

				echo "<div class=\"zoekblok_item zoekblok_soortaccommodatie\">";

				echo "<div class=\"zoekblok_titel intern\">";
				echo "Soort accommodatie";
				echo "</div>"; # afsluiten .zoekblok_titel

				echo "<div class=\"zoekblok_field\">";



				echo "<div class=\"zoekblok_field_float\">";

				$doorloop_array = array(
					"agriturismo"=>56,
					"appartement"=>51,
					"vakantiehuis"=>52,
					"vakantiepark"=>55,
					"villa"=>53,
					"domein"=>57,
					"kasteel"=>54,
				);


				foreach ($doorloop_array as $key => $value) {

					if($soortaccommodatie_teller==2 or $soortaccommodatie_teller==4 or $soortaccommodatie_teller==6) {
						echo "</div>";
						echo "<div class=\"zoekblok_field_float\">";
					}

					echo "<input type=\"checkbox\" name=\"sac[".$value."]\" value=\"1\" id=\"soortaccommodatie_".$value."\"".($_GET["sac"][$value] ? " checked" : "")."><label for=\"soortaccommodatie_".$value."\">&nbsp;".wt_he($key)."</label><br/>";
					$soortaccommodatie_teller++;
				}
				echo "<div class=\"clear\"></div>";

				echo "</div>"; # afsluiten .zoekblok_field_float

				echo "</div>"; # afsluiten .zoekblok_field

				echo "<div class=\"clear\"></div>";
				echo "</div>"; # afsluiten .zoekblok_item
			}
		}
	}

	function zoekblok_verfijnd_gekozen($settings=array("")) {
		#
		# zoekformulier: opsomming verfijnde zoekopdracht
		#

		global $vars,$keuzeopsomming;

		@reset($keuzeopsomming);
		while(list($key,$value)=@each($keuzeopsomming)) {
			unset($getvalue,$getnumber);
			while(list($key2,$value2)=each($value["fields"])) {
				if($value["combinatiesmogelijk"]) {
					$getnumber=$value2;
					$getvalue=1;
				} else {
					$getnumber=1;
					$getvalue=$value2;
				}
				if($_GET[$value["getname"].$getnumber]==$getvalue) {
					$toonactief_verfijn[$key][$getnumber]=$key2;
				}
			}
			if($toonactief_verfijn[$key]) {
				if(!$verfijn_hr_getoond) {
					echo "<hr class=\"zoekblok_hr_boven\">";
					$verfijn_hr_getoond=true;
				}
				echo "<div class=\"zoekblok_item_verfijn\">";
				echo "<div class=\"zoekblok_titel zoekblok_verfijn_actief_categorie\" data-verfijn-categorie=\"".html($value["name"],"zoek-en-boek")."\">";
				echo html($value["name"],"zoek-en-boek");
				echo "</div>"; # afsluiten .zoekblok_titel

				echo "<div class=\"zoekblok_verfijn_actief\">";
				while(list($key2,$value2)=each($toonactief_verfijn[$key])) {
					$qs=wt_stripget($_GET,array("page",$value["getname"].$key2));
					echo "<div class=\"zoekblok_verfijn_actief_item\" data-verfijn-item=\"".html($value2,"zoek-en-boek")."\">".html($value2,"zoek-en-boek")." - <a href=\"".wt_he($urlself.($qs ? "?".$qs : ""))."\">".html("wis","zoek-en-boek")."</a></div>";
				}
				echo "</div>"; # afsluiten .zoekblok_field

				echo "<div class=\"clear\"></div>";
				echo "</div>"; # afsluiten .zoekblok_item
			}
		}

		if($verfijn_hr_getoond) {
			echo "<hr class=\"zoekblok_hr_boven\">";
		}
	}

	function zoekblok_alleen_aanbiedingen($settings=array("")) {
		if($_GET["aab"]) {
			# keuze "zoek alleen naar aanbiedingen" tonen
			echo "<div class=\"zoekblok_item zoekblok_item_geen_titel\">";

			echo "<div class=\"zoekblok_zoek_alleen_aanbiedingen\"><input type=\"checkbox\" name=\"faab\" value=\"1\" id=\"faab\"".(!$_GET["filled"]||$_GET["faab"]||$_GET["saved"] ? " checked" : "")." class=\"onchangesubmit\"><label for=\"faab\">&nbsp;".html("zoekalleenaanbiedingen","zoek-en-boek")."</label></div>";

			echo "<div class=\"clear\"></div>";
			echo "</div>"; # afsluiten .zoekblok_item

		}
	}

	function zoekblok_submit($settings=array("")) {
		#
		# zoekformulier: submit
		#

		global $vars,$urlself;

		echo "<div class=\"zoekblok_item zoekblok_item_geen_titel\">";
		echo "<input type=\"submit\" value=\" ".strtoupper(html("zoeken","accommodaties"))." \" id=\"submit1zoeken\" class=\"submitbutton\">";

		# "alles wissen"-link
		if(strpos($_SERVER["REQUEST_URI"],"filled=1")) {
			echo "<div class=\"zoekblok_alleswissen\">";
			echo "<a href=\"".wt_he($urlself.(strpos($_SERVER["REQUEST_URI"],"&aab=1") ? "?filled=1&amp;aab=1&amp;faab=1" : "")).($_GET["testsysteem"] ? "?testsysteem=1" : "")."\"><i class=\"icon-remove-sign\"></i><span>".html("alleswissen","zoek-en-boek")."</span></a>";
			echo "</div>"; # afsluiten .zoekblok_alleswissen
		}

		echo "</div>"; # afsluiten .zoekblok_item
	}

	$vars["zoek-en-boek-functions-init"]=true;
}

if($voorkant_cms and $vars["seizoen_alleen_intern"]) {
	echo "<div class=\"zoekblok_interne_opmerking\">Niet zichtbaar bij zoek-en-boek voor gewone bezoekers: <b>".substr($vars["seizoen_alleen_intern"],4)."</b></div>";
}

if($vars["websitetype"]==1) {
	# Chalet
	zoekblok_bestemming();
	zoekblok_aankomstdatum();
	zoekblok_aantalpersonen();
	zoekblok_aantalslaapkamers();
	zoekblok_tekst();
	zoekblok_intern();
	zoekblok_verfijnd_gekozen();
	zoekblok_alleen_aanbiedingen();
	zoekblok_submit();
} elseif($vars["websitetype"]==3) {
	# Zomerhuisje
	zoekblok_bestemming();
	zoekblok_aantalpersonen();
	zoekblok_aankomstdatum();
	zoekblok_verblijfsduur();
	zoekblok_aantalslaapkamers();
	zoekblok_tekst();
	zoekblok_intern();
	zoekblok_verfijnd_gekozen();
	zoekblok_alleen_aanbiedingen();
	zoekblok_submit();
} elseif($vars["websitetype"]==4) {
	# Chalettour
	zoekblok_bestemming();
	zoekblok_aankomstdatum();
	zoekblok_aantalpersonen();
	zoekblok_aantalslaapkamers();
	zoekblok_tekst();
	zoekblok_intern();
	zoekblok_verfijnd_gekozen();
	zoekblok_alleen_aanbiedingen();
	zoekblok_submit();
} elseif($vars["websitetype"]==6) {
	# ChaletsinVallandry
	zoekblok_aankomstdatum();
	zoekblok_aantalpersonen();
	zoekblok_aantalslaapkamers();
	zoekblok_tekst();
	zoekblok_intern();
	zoekblok_verfijnd_gekozen();
	zoekblok_alleen_aanbiedingen();
	zoekblok_submit();
} elseif($vars["websitetype"]==7) {
	# Italissima
	zoekblok_bestemming(array("zonder_plaatsen"=>true));
	zoekblok_aantalpersonen();
	zoekblok_aankomstdatum();
	zoekblok_verblijfsduur();
	zoekblok_aantalslaapkamers();
	zoekblok_prijsklasse();
	zoekblok_tekst();
	zoekblok_intern();
	zoekblok_verfijnd_gekozen();
	zoekblok_alleen_aanbiedingen();
	zoekblok_submit();
} elseif($vars["websitetype"]==8) {
	# SuperSki
	zoekblok_bestemming();
	zoekblok_aantalpersonen();
	zoekblok_aankomstdatum();
	zoekblok_aantalslaapkamers();
	zoekblok_tekst();
	zoekblok_intern();
	zoekblok_verfijnd_gekozen();
	zoekblok_alleen_aanbiedingen();
	zoekblok_submit();
} elseif($vars["websitetype"]==9) {
	# Venturasol
	zoekblok_bestemming();
	zoekblok_aantalpersonen();
	zoekblok_aankomstdatum();
	zoekblok_aantalslaapkamers();
	zoekblok_tekst();
	zoekblok_intern();
	zoekblok_verfijnd_gekozen();
	zoekblok_alleen_aanbiedingen();
	zoekblok_submit();
}

#
# "Aantal gevonden resultaten" tonen
#
if($aantalresultaten_zonder_gekoppeld_skigebied<count($results)) {
	$toon_aantalresultaten=$aantalresultaten_zonder_gekoppeld_skigebied;
} else {
	$toon_aantalresultaten=count($results);
}
echo "<div class=\"aantalgevonden\" id=\"aantalgevonden\" data-aantalgevonden=\"".intval($toon_aantalresultaten_verschillende_types)."\">";
echo html("gevondenaccommodaties".($toon_aantalresultaten_verschillende_types==1 ? "_1" : ""),"zoek-en-boek",array("v_aantal"=>number_format($toon_aantalresultaten_verschillende_types,0,",","."),"h_1"=>"<strong>","h_2"=>"</strong>"));

if($vars["zoeken_op_kaart"] and $zoeken_op_kaart) {
	echo "&nbsp;&nbsp;<span class=\"toonopkaart\">(<i class=\"icon-location-arrow\"></i>&nbsp;<a href=\"#kaart\" data-org=\"".html("toonopkaart","zoek-en-boek")."\" data-toggle=\"".html("verbergkaart","zoek-en-boek")."\">";
	if($_GET["map"]) {
		echo html("verbergkaart","zoek-en-boek");
	} else {
		echo html("toonopkaart","zoek-en-boek");
	}
	echo "</a>)</span>";
}
echo "</div>";


//
// link to next season ("nu al te boeken")
//
if($vars["seizoentype"]==1 and $vars["websitetype"]<>6 and !$vars["zoekform_thema"] and !$vars["zoekform_weekendski"] and !$vars["zoekform_vallandrychalets"] and !$vars["zoekform_italissima_nieuwe_tarieven"] and !$vars["zoekform_aanbiedingen"]) {
	$db3->query("SELECT naam".$vars["ttv"]." AS naam FROM seizoen WHERE type IN (".$temp_seizoentype.") AND tonen=4 ORDER BY begin DESC LIMIT 0,1;");
	if($db3->next_record()) {
		$thema_url = $db3->f("naam");
		$thema_url = preg_replace("@/@", "-", $thema_url);
		$thema_url = preg_replace("@[^0-9-]@", "", $thema_url);
		$querystring_thema = wt_stripget($_GET, array("fad", "scrolly", "page", "sort"));
		echo "<a href=\"".$vars["path"].txt("menu_thema")."/".$thema_url."/".($querystring_thema ? "?".$querystring_thema : "")."\" class=\"zoekresultaten_nieuwseizoen analytics_track_internal_click\" data-description=\"button 'nu al te boeken'\">";
		echo html("bekijknutarievenvolgendseizoen", "zoek-en-boek", array("v_seizoennaam"=>$db3->f("naam")));
		echo "&nbsp;&raquo;&nbsp;";
		echo "</a>";
	}
}

echo "</form>";
echo "</div>"; # afsluiten #zoekblok


if($vars["zoekform_thema"] or $vars["zoekform_weekendski"] or $vars["zoekform_vallandrychalets"] or $vars["zoekform_italissima_nieuwe_tarieven"]) {
	echo "</div>";
}

// initialize theme year
$thema_jaar = date('Y');
if($resultaten_tonen) {
	if(@count($results)>0) {
		#
		# Zoekresultaten tonen
		#
		$vars["resultsperpage"]=50;

		$startresult=(($_GET["page"]-1)*$vars["resultsperpage"])+1;
		if(count($results)>($startresult+$vars["resultsperpage"]-1)) $endresult=$startresult+$vars["resultsperpage"]-1; else $endresult=count($results);

		// bepalen of de balk "Aantal accommodaties voor 2013/2014 met tarieven" getoond moet worden: alleen tonen als het formulier leeg is
		if(!$_GET["filled"] or (!$_GET["fsg"] and !$_GET["fad"] and !$_GET["fap"] and !$_GET["fdu"] and !$_GET["fzt"] and !$_GET["scrolly"] and $_GET["scrolly"]<>"0" and $_GET["referer"])) {

			$toon_aantalaccommodatiesmettarieven=true;

			// here we create a new datetime object set to CET time, then we fetch the current year and add an interval of P1Y (equiv. of +1Year)
			$thema_jaar = new DateTime('now', new DateTimeZone('Europe/Amsterdam'));
			$thema_jaar = ($thema_jaar->format('Y') . '/' . $thema_jaar->add(new DateInterval('P1Y'))->format('Y'));
		}

#		echo "<div style=\"height:13px;\"></div>";
		if($vars["zoekform_thema"] or $vars["zoekform_weekendski"] or $vars["zoekform_vallandrychalets"] or $vars["zoekform_italissima_nieuwe_tarieven"]) {
			#
			# Thema-pagina's (of pagina 'tarieven nieuw seizoen'): aantal accommodaties tonen
			#
			if($vars["themainfo"]["tarievenbekend_seizoen_id"] and $totaal_tarievenbekend_seizoen_id and $toon_aantalaccommodatiesmettarieven) {
				$totaal_tarievenbekend_percentage=round(($toon_aantalresultaten_verschillende_types/$totaal_tarievenbekend_seizoen_id)*100);
				if($totaal_tarievenbekend_percentage<1) $totaal_tarievenbekend_percentage=1;
				echo "<div class=\"zoekresultaten_aantalgevonden boxshadow\" id=\"aantalgevonden\">".html("aantalaccommodatiesmettarieven","thema",array("v_aantal"=>number_format($toon_aantalresultaten_verschillende_types,0,",","."),"v_totaal"=>$totaal_tarievenbekend_seizoen_id,"v_percentage"=>$totaal_tarievenbekend_percentage."%","v_themajaar" => $thema_jaar))."</div>";
				if($_GET["save_tarievenbekend"]) {
					save_data_to_file($unixdir."cache/tarievenbekend_".$vars["website"].".txt",$toon_aantalresultaten_verschillende_types."-".$totaal_tarievenbekend_percentage);
				}
			} else {
				echo "<div class=\"zoekresultaten_aantalgevonden boxshadow\" id=\"aantalgevonden\" data-aantalgevonden=\"".intval($toon_aantalresultaten_verschillende_types)."\">".html("aantalgevonden","accommodaties").": ".number_format($toon_aantalresultaten_verschillende_types,0,",",".")."</div>";
			}
		} else {
			#
			# Balk met tekst "Aantal accommodaties voor [nieuw seizoen] met tarieven: X (= X% van ons totale aanbod)"
			#
			if($vars["zoekformulier_weinig_tarieven"] and $vars["seizoentype"]==1 and (@filemtime($unixdir."cache/tarievenbekend_".$vars["website"].".txt")>(time()-86400) or $vars["lokale_testserver"]) and $toon_aantalaccommodatiesmettarieven) {
				#
				# melding "Aantal accommodaties met tarieven: xxx (= xx% van ons totale winteraanbod)" tonen
				#
				$a=split("-",@file_get_contents($unixdir."cache/tarievenbekend_".$vars["website"].".txt"));
				if($a[0]>=1) {
					if($a[1]<1) $a[1]=1;
					echo "<div class=\"zoekresultaten_aantalgevonden boxshadow\" style=\"margin-bottom:25px;\">";
					echo html("aantalaccommodatiesmettarieven","thema",array("v_aantal"=>$a[0],"v_percentage"=>$a[1]."%", 'v_themajaar' => $thema_jaar));
					echo "</div>";
				}
			} else {

				// // link to next season ("nu al te boeken")
				// $db3->query("SELECT naam".$vars["ttv"]." AS naam FROM seizoen WHERE type IN (".$temp_seizoentype.") AND tonen=4 ORDER BY begin DESC LIMIT 0,1;");
				// if($db3->next_record() and ($vars["lokale_testserver"] or $vars["acceptatie_testserver"] or $_GET["test"]==1)) {
				// 	$thema_url = $db3->f("naam");
				// 	$thema_url = preg_replace("@/@", "-", $thema_url);
				// 	$thema_url = preg_replace("@[^0-9-]@", "", $thema_url);
				// 	echo "<a href=\"".$vars["path"].txt("menu_thema")."/".$thema_url."/\" class=\"zoekresultaten_nieuwseizoen boxshadow analytics_track_internal_click\" data-description=\"button 'nu al te boeken'\">";
				// 	echo html("bekijknutarievenvolgendseizoen", "zoek-en-boek", array("v_seizoennaam"=>$db3->f("naam")));
				// 	echo "&nbsp;&raquo;&nbsp;";
				// 	echo "</a>";
				// }
			}
		}

		if($_GET["save_aantalaccommodaties"] and $toon_aantalresultaten_verschillende_types>0) {
			# Opslaan hoeveel accommodaties er zijn
			save_data_to_file($unixdir."cache/aantal_accommodaties_".$vars["website"].".txt",$toon_aantalresultaten_verschillende_types);
		}

		echo "<table id=\"zoekresultatentable\" class=\"table\">";
		echo "<tr><td></td><td></td><td></td><td></td><td></td></tr>";
		if($vars["flexibel_toegestaan"]) {
			echo "<tr><td colspan=\"5\" style=\"text-align:left;\">";
		} else {
			echo "<tr><td colspan=\"4\" style=\"text-align:left;\">";
		}

		# Flexibel: alternatieven tonen
		if($vars["flexibel_toegestaan"] and $flex_alt_html) echo $flex_alt_html;

		# Zoeken op kaart: kaart + javascript-vars plaatsen
		if($vars["zoeken_op_kaart"] and $zoeken_op_kaart) {

			$gps_lat_midden=($gps_lat_min+$gps_lat_max)/2;
			$gps_long_midden=($gps_long_min+$gps_long_max)/2;
			echo "<script>\n";
			echo "var mapOptions = {};\n";

			if($_SERVER["DOCUMENT_ROOT"]=="/home/webtastic/html") {
				echo "mapOptions.googlemaps_base='/chalet/';\n";
			}
			echo "mapOptions.googlemaps_zoekenboek=true;\n mapOptions.googlemaps_lat=".$gps_lat_midden.";\n mapOptions.googlemaps_long=".$gps_long_midden.";\n mapOptions.googlemaps_lat_min=".$gps_lat_min.";\n mapOptions.googlemaps_long_min=".$gps_long_min.";\n mapOptions.googlemaps_lat_max=".$gps_lat_max.";\n mapOptions.googlemaps_long_max=".$gps_long_max.";\n mapOptions.googlemaps_selected_icon=".$vars["websitetype"].";\n mapOptions.zoomlevel=11;\n mapOptions.gps_coordinaten_bekend=1;\n";
			echo "</script>\n";

#			echo "<div class=\"zoekresultaten_zoeken_op_kaart zoekresultaten_aantalgevonden boxshadow\">".html("bekijkopkaart","zoek-en-boek")."&nbsp;&nbsp;<i class=\"icon-arrow-down\"></i></div>";

			echo "<div class=\"zoekresultaten_zoeken_op_kaart_map boxshadow\"".($_GET["map"]==1 ? " style=\"display:block;\"" : "").">";
			echo "<div id=\"map_canvas\" class=\"zoekresultaten_zoeken_op_kaart_map_canvas\"></div>";
			echo "</div>";
		}

		echo "</td>";
		if(!$vars["flexibel_toegestaan"]) {
			echo "<td></td>";
		}
		echo "</tr>";

		if($voorkant_cms) {
			echo "<tr><td colspan=\"5\" style=\"color:#888888;text-align:right;padding-right:15px;padding-top: 8px;\">(intern: zoektijd <span id=\"zoektijd\"></span> sec.)</td></tr>";
		}

		echo "<tr>";

		# Sorteren alleen aanbiedingen:
		#- als er tarieven worden getoond
		# - niet bij SuperSki
		# - niet op thema-pagina
		if($tarieven_tonen and $vars["websitetype"]<>8 and !$vars["themainfo"]["uitgebreidzoeken_url"]) {
			echo "<td colspan=\"5\" style=\"padding-right:10px;text-align:right;vertical-align:bottom;\">";
			echo "<div id=\"zoekresultaten_sorteer\">";
			$vars["sorteerkeuzes"][3]=txt("sorteer_prijsaflopend","zoek-en-boek");
			$vars["sorteerkeuzes"][2]=txt("sorteer_prijsoplopend","zoek-en-boek");
			$vars["sorteerkeuzes"][1]=txt("sorteer_standaard","zoek-en-boek");
			$sorteer_url=$_SERVER["REQUEST_URI"];
			$sorteer_url=preg_replace("/page=[0-9]{1,}/","page=",$sorteer_url);
			if(preg_match("/sort=[0-9]/",$sorteer_url)) {
				$sorteer_url=preg_replace("/sort=[0-9]/","sort=SORT",$sorteer_url);
			} elseif(preg_match("/\?/",$sorteer_url)) {
				$sorteer_url=$sorteer_url."&sort=SORT";
			} else {
				$sorteer_url=$sorteer_url."?sort=SORT";
			}
			while(list($key,$value)=each($vars["sorteerkeuzes"])) {
				if($_GET["sort"]==$key or (!$_GET["sort"] and $key==1)) {
					echo "<div class=\"active\">".wt_he($value)."</div>";
				} else {
					echo "<a href=\"".wt_he(preg_replace("/sort=SORT/","sort=".$key,$sorteer_url))."\">".wt_he($value)."</a>";
				}
			}
			echo "<div id=\"zoekresultaten_sorteer_tekst\">".html("sorteer","zoek-en-boek").":</div>";
			echo "</div>";
			echo "</td>";
		}

		echo "</tr>";

		echo "<tr><td colspan=\"5\">&nbsp;</td></tr>";
		$product_impressions = array();
		unset($resultcounter);
		unset($product_impressions);
		while(list($key,$value)=each($results)) {
			$resultcounter++;

			if($resultcounter>=$startresult and $resultcounter<($startresult+$vars["resultsperpage"])) {

				# Toon tekst "onderstaande acc's zijn per acc zonder skipas"
				if(!$onderstaandeprijzen_getoond and $vars["seizoentype"]==1 and $toonper[$key]==3 and ($lasttoonper==1 or $lasttoonper==2) and $toonper12) {
					echo "<tr><td colspan=\"5\"><br><b>";
					echo html("onderstaandeprijzen","accommodaties");
					echo "</b><hr></td></tr>";
					$onderstaandeprijzen_getoond=true;
				}
				$lasttoonper=$toonper[$key];

				# Toon tekst "onderstaande acc's bevinden zich in een ander, maar vergelijkbaar skigebied"
				if(!$onderstaandeanderskigebied and $results_ander_skigebied[$key]>0) {
					echo "<tr><td colspan=\"5\">";

					echo "<div class=\"zoekresultaten_opmerking_tussen_resultaten boxshadow\">";

					if($_GET["page"]>1) {
						echo html("onderstaandeanderskigebied","accommodaties");
					} else {
						if($toon_aantalresultaten_anderskigebied==1) {
							echo html("onderstaandeeenanderskigebied","accommodaties");
						} else {
							echo html("onderstaandeaantalanderskigebied","accommodaties",array("v_aantal"=>$toon_aantalresultaten_anderskigebied));
						}
					}
					echo "</div>";

					echo "</td></tr>";
					$onderstaandeanderskigebied=true;
				}
				$product_impressions[] =$viewed_products[$key];
				echo $value;
			}
		}
		echo "</table>";


		if (isset($product_impressions) and count($product_impressions) > 0) {
			$google_tagmanager = new google_tagmanager;
			$list = ($vars["zoekform_aanbiedingen"]) ? 'Aanbiedingen' : 'Zoek en boek';
			echo $google_tagmanager->product_impressions($product_impressions, $list);
		}

		if(ceil(count($results)/$vars["resultsperpage"])>1) {

			# links naar pagina's met meer resultaten pagination
			echo "<p>".$resultatenmelding."</p>";

			echo "<div class=\"zoekresultaten_paginas\">";

			# pagina
			echo "<div class=\"zoekresultaten_paginas_active\">";
			echo html("pagina","accommodaties");
			echo "</div>";

			$temp_qs=$_SERVER["QUERY_STRING"];
			$temp_qs=ereg_replace("&page=[0-9]{1,}","",$temp_qs);
			$temp_qs=ereg_replace("&scrolly=[0-9\.]{1,}","",$temp_qs);
			$temp_qs=ereg_replace("\?scrolly=[0-9\.]{1,}&","?",$temp_qs);
			$temp_qs=ereg_replace("\?scrolly=[0-9\.]{1,}$","",$temp_qs);
			$temp_qs=ereg_replace("scrolly=[0-9\.]{1,}","",$temp_qs);
			$temp_qs=ereg_replace("thema=[a-zA-Z0-9-]{1,}","",$temp_qs);
			if(substr($temp_qs,0,1)=="&") $temp_qs=substr($temp_qs,1);

			$zoekurl="<a href=\"".$urlself."?".($temp_qs ? $temp_qs."&amp;" : "")."page=";

			echo "<div class=\"zoekresultaten_paginas_nummers\">";

			# vorige
			if($_GET["page"]>1) {
				echo $zoekurl.($_GET["page"]-1)."\" title=\"".html("vorige","accommodaties")."\">&lt;</a>";
			} else {
				echo "<div class=\"zoekresultaten_paginas_active zoekresultaten_paginas_disabled\">&lt;</div>";
			}

			for($i=1;$i<=ceil(count($results)/$vars["resultsperpage"]);$i++) {
				$laatstepage=15;
				if($_GET["page"]>7) {
					$laatstepage=$_GET["page"]+7;
					if($laatstepage>ceil(count($results)/$vars["resultsperpage"])) {
						$laatstepage=ceil(count($results)/$vars["resultsperpage"]);
					}
				}
				$eerstepage=$laatstepage-14;
				if($i>=$eerstepage and $i<=$laatstepage) {
					if($_GET["page"]==$i) {
						echo "<div class=\"zoekresultaten_paginas_active\">";
					} else {
						echo $zoekurl.$i."\" title=\"".html("pagina","accommodaties")." ".$i."\">";
					}
					echo $i;
					if($_GET["page"]==$i) {
						echo "</div>";
					} else {
						echo "</a>";
					}
				}
			}

			# volgende
			if(ceil(count($results)/$vars["resultsperpage"])>$_GET["page"]) {
				echo $zoekurl.($_GET["page"]+1)."\" title=\"".html("volgende","accommodaties")."\">&gt;</a>";
			} else {
				echo "<div class=\"zoekresultaten_paginas_active zoekresultaten_paginas_disabled\">&gt;</div>";
			}
			echo "</div>"; # afsluiten .zoekresultaten_paginas_nummers

			echo "</div>"; # afsluiten .zoekresultaten_paginas

			echo "<div style=\"clear:both;\"></div>";
		}

		if(count($results)<=3) {
			echo "<br>&nbsp;<br>&nbsp;<br>&nbsp;<br>&nbsp;<br>";
			if(count($results)<=2) {
				echo "<br>&nbsp;<br>&nbsp;<br>&nbsp;<br>&nbsp;";
			}
		}
	} else {
#		if(!$vars["zoekform_thema"] and !$vars["zoekform_weekendski"]) {
		if($_GET["filled"]) {
			if($_GET["faab"]) {
				// bij alleen aanbiedingen doorzoeken
				echo "<div id=\"geenresultaten\"><b>";
				if(preg_match("@\?@",$_SERVER["REQUEST_URI"])) {
					echo html("helaasgeenresultaten_aanbiedingen2","accommodaties",array("h_1"=>"<span style=\"color:#d40139;font-size:1.2em;\">","h_2"=>"</span>"));
				} else {
					echo html("helaasgeenresultaten_aanbiedingen1","accommodaties",array("h_1"=>"<span style=\"color:#d40139;font-size:1.2em;\">","h_2"=>"</span>"));
				}
				echo "</b></p>";

				echo "<p class=\"zoekresultaten_opvalmelding\">".html("helaasgeenresultaten_aanbiedingen_toelichting","accommodaties",array("l1"=>"contact","l2"=>"vraag-ons-advies"))."</p>";
				echo "<p>".html("paszoekcriteriaaan_aanbiedingen","accommodaties",array("l1"=>"contact","l2"=>"vraag-ons-advies"))."</p>";

				echo html("probeernieuwezoekopdracht","accommodaties",array("h_1"=>"<i>","h_2"=>"</i>"));
			} else {
				echo "<div id=\"geenresultaten\"><b>";
				echo html("helaasgeenresultaten","accommodaties",array("h_1"=>"<span style=\"color:#d40139;font-size:1.2em;\">","h_2"=>"</span>"));
				echo "</b></p>";

				echo "<p>".html("paszoekcriteriaaan","accommodaties",array("l1"=>"contact","l2"=>"vraag-ons-advies"))."</p>";

				echo html("probeernieuwezoekopdracht","accommodaties",array("h_1"=>"<i>","h_2"=>"</i>"));
			}
			if($vars["flexibel_toegestaan"] and $flex_alt_html) echo $flex_alt_html;

			echo "</div>";
		}
	}
}

#
# Zoeken op kaart: data-div vullen
#
if($vars["zoeken_op_kaart"] and is_array($zoeken_op_kaart_data)) {
	while(list($key,$value)=each($zoeken_op_kaart_data)) {

		unset($zoeken_op_kaart_tarief);
		if(floatval($value["tarief"])>0) {
			if($value["vanaf"]) {
				$zoeken_op_kaart_tarief.=html("vanaf")." ";
			}
			$zoeken_op_kaart_tarief.="&euro;&nbsp;".number_format($value["tarief"],0,",",".");
			if($value["toonper"]==3 or $vars["wederverkoop"]) {
				$zoeken_op_kaart_tarief.= " ". html("peraccommodatie","zoek-en-boek");
			} else {
				$zoeken_op_kaart_tarief.= " " . html("perpersoon","zoek-en-boek")."<br>".html("inclusiefskipas","zoek-en-boek");
			}
		}

		echo "<div class=\"data_zoeken_op_kaart\" data-gps_lat=\"".wt_he($value["gps_lat"])."\" data-gps_long=\"".wt_he($value["gps_long"])."\" data-plaatsland=\"".wt_he($value["plaatsland"])."\" data-aantalpersonen=\"".$value["optimaalaantalpersonen"].($value["maxaantalpersonen"]>$value["optimaalaantalpersonen"] ? " - ".$value["maxaantalpersonen"] : "")." ".($value["maxaantalpersonen"]==1 ? html("persoon") : html("personen"))."\" data-naamhtml=\"".wt_he($value["naamhtml"])."\" data-afbeelding=\"".wt_he($value["afbeelding"])."\" data-url=\"".wt_he($value["url"])."\" data-tarief=\"".wt_he($zoeken_op_kaart_tarief)."\" data-key=\"".wt_he($value["accommodatie_id"])."\" data-kwaliteit=\"".wt_he($value["kwaliteit"])."\" data-omschrijving=\"".wt_he($value["omschrijving"])."\"></div>";
	}
}

if($vars["verfijnen_aanbieden"]) {
	if($results) {
		$lhtml="<div id=\"verfijn\" class=\"\">";
		$lhtml.="<div id=\"verfijntopheader\">".html("verfijnzoekopdracht","zoek-en-boek")."</div>";

		if(is_array($verfijnd["kenmerken"])) {

			#
			# Kenmerken
			#
			$lhtml.="<div class=\"keuzes\">";

			#
			# Keuzeopsomming
			#
			function keuzeopsomming($combinatiesmogelijk,$name,$verfijndname,$getname,$fields) {
				global $lhtml,$verfijnd,$urlself,$vars;
				while(list($key,$value)=each($fields)) {
					if($combinatiesmogelijk) {
						$getnumber=$value;
						$getvalue=1;
					} else {
						$getnumber=1;
						$getvalue=$value;
					}
					$_SERVER["REQUEST_URI"]=ereg_replace("\?$","",$_SERVER["REQUEST_URI"]);
					$keuzes.="<div class=\"keuzeopsomming_veldnaam_".$key."\">";
					if($combinatiesmogelijk or !$_GET[$getname.$getnumber]) {
						if($_GET[$getname.$getnumber]==$getvalue) {
							$qs=wt_stripget($_GET,array("page","referer","selb",$getname.$getnumber));
							$keuzes.="<a href=\"".wt_he($urlself.($qs ? "?".$qs : ""))."\" class=\"keuzeopsomming keuzeopsomming_actief\" rel=\"nofollow\">".html($key,"zoek-en-boek")." <span class=\"aantal\">(".$verfijnd[$verfijndname][$value].")</span></a>";
						} elseif($verfijnd[$verfijndname][$value]>0) {
							$request_uri=$_SERVER["REQUEST_URI"];
							$request_uri=preg_replace("/page=[0-9]+&/","",$request_uri);
							$keuzes.="<a href=\"".wt_he($request_uri).(preg_match("/\?/",$request_uri) ? "&amp;" : "?").(isset($_GET["fzt"]) ? "" : "filled=1&amp;fzt=&amp;").$getname.$getnumber."=".$getvalue.($vars["aanbiedingenpagina_voor_de_eerste_keer_geopend"] ? "&amp;faab=1" : "")."\" class=\"keuzeopsomming\" rel=\"nofollow\">".html($key,"zoek-en-boek")." <span class=\"aantal\">(".$verfijnd[$verfijndname][$value].")</span></a>";
						} else {
							$keuzes.="<div class=\"keuzeopsomming keuzeopsomming_leeg\">".html($key,"zoek-en-boek")." <span class=\"aantal\">(0)</span></div>";
						}
					} else {
						if($_GET[$getname.$getnumber]==$getvalue) {
							$qs=wt_stripget($_GET,array("page","referer","selb",$getname.$getnumber));
							$keuzes.="<a href=\"".wt_he($urlself.($qs ? "?".$qs : ""))."\" class=\"keuzeopsomming keuzeopsomming_actief\" rel=\"nofollow\">".html($key,"zoek-en-boek")." <span class=\"aantal\">(".$verfijnd[$verfijndname][$value].")</span></a>";
						} else {
							$url=preg_replace("/".$getname.$getnumber."=[0-9]+/",$getname.$getnumber."=".$getvalue,$_SERVER["REQUEST_URI"]);
							$keuzes.="<a href=\"".wt_he($url)."\" class=\"keuzeopsomming keuzeopsomming_geen_combinatie\" rel=\"nofollow\">".html($key,"zoek-en-boek")."</a>";
						}
					}
					$keuzes.="</div>";
				}
				if($keuzes) {
					$lhtml.="<div class=\"keuzes_kopjes\">".html($name,"zoek-en-boek")."</div>";
					$lhtml.=$keuzes;
				}
			}

			reset($keuzeopsomming);
			while(list($key2,$value2)=each($keuzeopsomming)) {
				keuzeopsomming($value2["combinatiesmogelijk"],$value2["name"],$value2["verfijndname"],$value2["getname"],$value2["fields"]);
			}

			$lhtml.="</div>";

			#
			# alle selecties wissen-link
			#
			# qs bepalen
			unset($qs);
			if(is_array($_GET)) {
				reset($_GET);
				while(list($key,$value)=each($_GET)) {
					if($value and !preg_match("/^vf_/",$key) and $key<>"page" and $key<>"sort" and $key<>"scrolly" and $key<>"map" and $key<>"sp" and $key<>"referer") {
						if(is_array($value)) {
							foreach ($value as $key2 => $value2) {
								$qs.="&".$key."[".$key2."]=".urlencode($value2);
							}
						} else {
							$qs.="&".$key."=".urlencode($value);
						}
					}
				}
				if($qs) {
					$qs=substr($qs,1);
				}
				if($qs=="filled=1") unset($qs);
			}
			$lhtml.="<a href=\"".wt_he($urlself.($qs ? "?".$qs : ""))."\" class=\"alle_selecties_wissen\">".html("alleselectieswissen","zoek-en-boek")."</a>";
		}
		$lhtml.="<div style=\"\">&nbsp;</div>";
		$lhtml.="<div class=\"bloklinks_blauwelijn\"></div>";
		$lhtml.="</div>";

	} else {
		$lhtml="";
	}
}

// Criteo retargeting datalayer tags
if($vars["website"]=="C" and is_array($product_impressions) and $_GET["filled"]) {
	$criteo = new CriteoTags;
	echo $criteo->searchAndBook($product_impressions);
}


// pageload-time bepalen
if($vars["page_starttime"]) {
	echo "<div class=\"data-div\" id=\"page_load_time\" data-time=\"".number_format(microtime(true)-$vars["page_starttime"],2,",",".")."\" data-zonder-variabelen=\"".($_SERVER["REQUEST_URI"]==$vars["path"].txt("menu_zoek-en-boek").".php" ? "1" : "0")."\"></div>";
}


?>